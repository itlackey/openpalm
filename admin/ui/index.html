<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenPalm Admin</title>
<style>
*,*::before,*::after{box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3348;--text:#e4e6f0;--muted:#8b8fa3;--accent:#6366f1;--accent2:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--purple:#a855f7;--radius:8px}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;font-size:15px;line-height:1.5}
a{color:var(--accent2)}
button{cursor:pointer;font:inherit;border:none;border-radius:var(--radius);padding:.5rem 1rem;background:var(--accent);color:#fff;transition:opacity .15s}
button:hover{opacity:.85}
button:disabled{opacity:.4;cursor:default}
button.secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
button.danger{background:var(--red)}
button.sm{padding:.3rem .7rem;font-size:13px}
input,select{font:inherit;padding:.45rem .7rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);width:100%}
input:focus,select:focus{outline:2px solid var(--accent);outline-offset:-1px}
.container{max-width:960px;margin:0 auto;padding:1rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.card h3{margin:0 0 .5rem}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
@media(max-width:700px){.grid2,.grid3{grid-template-columns:1fr}}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.badge-low{background:var(--green)}.badge-medium{background:var(--yellow);color:#000}.badge-high{background:var(--red)}.badge-critical{background:var(--purple)}
.tag{display:inline-block;padding:1px 6px;border-radius:4px;font-size:11px;background:var(--surface2);color:var(--muted);margin:0 3px 3px 0}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot-ok{background:var(--green)}.dot-err{background:var(--red)}.dot-warn{background:var(--yellow)}
.muted{color:var(--muted)}
.mb{margin-bottom:1rem}
.hidden{display:none!important}
/* nav */
nav{background:var(--surface);border-bottom:1px solid var(--border);padding:.7rem 1rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
nav .logo{font-weight:700;font-size:18px;color:var(--accent2);margin-right:auto;display:flex;align-items:center;gap:.45rem}
nav .logo img{width:24px;height:24px;border-radius:6px}
nav button{background:transparent;color:var(--muted);padding:.3rem .8rem;border:1px solid transparent;font-size:14px}
nav button.active{color:var(--text);border-color:var(--accent);background:var(--surface2)}
/* detail modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:90}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:560px;width:95%;max-height:80vh;overflow-y:auto}
.modal h3{margin:0 0 .5rem}
.sec-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin:.5rem 0}
.sec-box .sec-title{font-weight:600;font-size:13px;text-transform:uppercase;color:var(--muted);margin-bottom:.3rem}
.perm-list{list-style:none;padding:0;margin:.3rem 0}
.perm-list li::before{content:">";margin-right:6px;color:var(--accent)}
</style>
</head>
<body>

<nav>
  <span class="logo"><img src="/logo.png" alt="OpenPalm logo" />OpenPalm</span>
  <button id="nav-gallery" onclick="showPage('gallery')">Gallery</button>
  <button id="nav-installed" onclick="showPage('installed')">Installed</button>
  <button id="nav-services" onclick="showPage('services')">Services</button>
  <button id="nav-crons" onclick="showPage('crons')">Cron Jobs</button>
  <button id="nav-settings" onclick="showPage('settings')">Settings</button>
</nav>

<div class="container">
  <!-- PAGES -->
  <div id="page-gallery" class="page"></div>
  <div id="page-installed" class="page hidden"></div>
  <div id="page-services" class="page hidden"></div>
  <div id="page-crons" class="page hidden"></div>
  <div id="page-settings" class="page hidden"></div>
</div>

<!-- setup wizard overlay, rendered by JS -->
<div id="setup-overlay" class="wizard-overlay hidden"></div>
<!-- detail modal, rendered by JS -->
<div id="modal-overlay" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()"></div>

<script src="/setup-ui.js"></script>
<script>
/* ── state ────────────────────────────────────────────── */
let adminToken = localStorage.getItem('op_admin') || '';
let galleryItems = [];
let setupState = null;
let currentPage = 'gallery';

const BASE = ''; // same-origin via Caddy

/* ── API helper ───────────────────────────────────────── */
async function api(path, opts = {}) {
  const headers = { 'content-type': 'application/json', ...(opts.headers || {}) };
  if (adminToken) headers['x-admin-token'] = adminToken;
  const res = await fetch(BASE + path, { ...opts, headers });
  const text = await res.text();
  try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
  catch { return { ok: res.ok, status: res.status, data: text }; }
}

/* ── pages ────────────────────────────────────────────── */
function showPage(name) {
  currentPage = name;
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById('page-' + name).classList.remove('hidden');
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const nb = document.getElementById('nav-' + name);
  if (nb) nb.classList.add('active');
  if (name === 'gallery') loadGallery();
  if (name === 'installed') loadInstalled();
  if (name === 'services') loadServices();
  if (name === 'crons') loadCrons();
  if (name === 'settings') renderSettings();
}

/* ── risk badge ───────────────────────────────────────── */
function riskBadge(r) {
  return '<span class="badge badge-' + r + '">' + r.charAt(0).toUpperCase() + r.slice(1) + ' Risk</span>';
}
function riskDesc(r) {
  const m = { low:'Safe. No network access or side effects.', medium:'Limited capabilities. Review before installing.', high:'Significant capabilities. Requires careful review.', critical:'Maximum capability. Review thoroughly.' };
  return m[r] || '';
}
function categoryIcon(c) {
  return c === 'plugin' ? 'P' : c === 'skill' ? 'S' : 'C';
}
function categoryLabel(c) {
  return c === 'plugin' ? 'Plugin' : c === 'skill' ? 'Skill' : 'Container';
}

/* ── gallery ──────────────────────────────────────────── */
let galleryFilter = '';
let galleryCat = '';

async function loadGallery() {
  const qs = '/admin/gallery/search?q=' + encodeURIComponent(galleryFilter) + (galleryCat ? '&category=' + galleryCat : '');
  const r = await api(qs);
  galleryItems = r.ok ? r.data.items : [];
  renderGallery();
}

function renderGallery() {
  const el = document.getElementById('page-gallery');
  let h = '<h2>Extension Gallery</h2>';
  h += '<p class="muted">Search for OpenCode plugins, skills, and Docker containers to extend your platform.</p>';
  // search
  h += '<div class="mb" style="display:flex;gap:.5rem;flex-wrap:wrap">';
  h += '<input id="gal-search" style="flex:1;min-width:200px" placeholder="Search extensions..." value="' + esc(galleryFilter) + '" onkeyup="if(event.key===\'Enter\'){galleryFilter=this.value;loadGallery()}" />';
  h += '<button class="sm" onclick="galleryFilter=document.getElementById(\'gal-search\').value;loadGallery()">Search</button>';
  h += '</div>';
  // category tabs
  h += '<div class="mb" style="display:flex;gap:.4rem;flex-wrap:wrap">';
  h += catTab('', 'All');
  h += catTab('plugin', 'Plugins');
  h += catTab('skill', 'Skills');
  h += catTab('container', 'Containers');
  h += '</div>';
  // npm search link
  h += '<div class="mb"><button class="secondary sm" onclick="promptNpmSearch()">Search npm registry...</button></div>';
  // items
  if (!galleryItems.length) {
    h += '<p class="muted">No extensions found.</p>';
  }
  h += '<div class="grid2">';
  for (const item of galleryItems) {
    h += '<div class="card" style="cursor:pointer" onclick="showDetail(\'' + esc(item.id) + '\')">';
    h += '<div style="display:flex;justify-content:space-between;align-items:start">';
    h += '<h3 style="margin:0">' + esc(item.name) + '</h3>';
    h += riskBadge(item.risk);
    h += '</div>';
    h += '<div class="muted" style="font-size:13px;margin:.3rem 0">' + categoryLabel(item.category) + ' by ' + esc(item.author) + '</div>';
    h += '<p style="font-size:14px;margin:.4rem 0">' + esc(item.description).substring(0, 120) + '</p>';
    h += '<div>';
    for (const t of item.tags.slice(0, 4)) h += '<span class="tag">' + esc(t) + '</span>';
    h += '</div></div>';
  }
  h += '</div>';
  el.innerHTML = h;
}

function catTab(val, label) {
  const cls = galleryCat === val ? 'sm' : 'secondary sm';
  return '<button class="' + cls + '" onclick="galleryCat=\'' + val + '\';loadGallery()">' + label + '</button>';
}

/* ── detail modal ─────────────────────────────────────── */
async function showDetail(id) {
  const r = await api('/admin/gallery/item/' + id);
  if (!r.ok) return;
  const item = r.data.item;
  const badge = r.data.riskBadge;
  const ov = document.getElementById('modal-overlay');
  let h = '<div class="modal">';
  h += '<div style="display:flex;justify-content:space-between;align-items:start">';
  h += '<h3>' + esc(item.name) + '</h3>';
  h += '<button class="secondary sm" onclick="closeModal()">Close</button>';
  h += '</div>';
  h += '<div class="muted" style="font-size:13px">' + categoryLabel(item.category) + ' &middot; v' + esc(item.version) + ' &middot; by ' + esc(item.author) + '</div>';
  h += '<p>' + esc(item.description) + '</p>';
  // security section
  h += '<div class="sec-box">';
  h += '<div class="sec-title">Security Assessment</div>';
  h += '<div style="margin-bottom:.4rem">' + riskBadge(item.risk) + ' <span class="muted" style="font-size:13px;margin-left:.5rem">' + esc(badge.description) + '</span></div>';
  h += '<div style="font-size:14px;margin:.5rem 0"><strong>Security notes:</strong> ' + esc(item.securityNotes) + '</div>';
  h += '<div class="sec-title" style="margin-top:.6rem">Permissions Required</div>';
  h += '<ul class="perm-list">';
  for (const p of item.permissions) h += '<li>' + esc(p) + '</li>';
  h += '</ul></div>';
  // tags
  h += '<div class="mb">';
  for (const t of item.tags) h += '<span class="tag">' + esc(t) + '</span>';
  h += '</div>';
  // defense in depth note
  h += '<div class="sec-box">';
  h += '<div class="sec-title">Defense in Depth</div>';
  h += '<div style="font-size:13px">';
  if (item.category === 'plugin') {
    h += 'Plugins run inside the OpenCode sandbox. They can hook into tool calls but cannot make network requests or access the filesystem outside the sandbox. The gateway tool firewall provides a second layer of enforcement.';
  } else if (item.category === 'skill') {
    h += 'Skills are behavioral SOPs (markdown files). They have zero tool access and cannot execute code. They only influence how the assistant reasons and responds.';
  } else {
    h += 'Containers run on the isolated Docker network. Channel containers can only reach the gateway. All inbound messages pass through HMAC signature verification, rate limiting, and the tool firewall before reaching OpenCode.';
  }
  h += '</div></div>';
  // install button
  if (!adminToken) {
    h += '<p class="muted" style="font-size:13px">Set your admin password in Settings to enable installation.</p>';
  } else {
    h += '<div style="margin-top:1rem"><button onclick="installGallery(\'' + esc(item.id) + '\')">Install ' + esc(item.name) + '</button></div>';
  }
  h += '</div>';
  ov.innerHTML = h;
  ov.classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}

async function installGallery(id) {
  if (!confirm('Install this extension?')) return;
  const r = await api('/admin/gallery/install', { method: 'POST', body: JSON.stringify({ galleryId: id }) });
  if (r.ok) {
    alert('Installed successfully.');
    closeModal();
  } else {
    alert('Install failed: ' + (r.data.error || r.status));
  }
}

async function promptNpmSearch() {
  const q = prompt('Search npm for OpenCode plugins:');
  if (!q) return;
  const r = await api('/admin/gallery/npm-search?q=' + encodeURIComponent(q));
  if (!r.ok || !r.data.results.length) { alert('No results found.'); return; }
  let msg = 'Results:\n';
  for (const p of r.data.results.slice(0, 10)) {
    msg += '\n' + p.name + ' (v' + p.version + ') - ' + p.description.substring(0, 60);
  }
  msg += '\n\nEnter package name to install (or cancel):';
  const pkg = prompt(msg);
  if (!pkg) return;
  if (!confirm('Install "' + pkg + '" from npm? This is an unreviewed package (HIGH RISK). Continue?')) return;
  const ir = await api('/admin/gallery/install', { method: 'POST', body: JSON.stringify({ pluginId: pkg }) });
  alert(ir.ok ? 'Installed.' : 'Failed: ' + (ir.data.error || ir.status));
}

/* ── installed ────────────────────────────────────────── */
async function loadInstalled() {
  const el = document.getElementById('page-installed');
  let h = '<h2>Installed Extensions</h2>';
  if (!adminToken) {
    h += '<p class="muted">Set your admin password in Settings to view installed extensions.</p>';
    el.innerHTML = h;
    return;
  }
  const r = await api('/admin/installed');
  if (!r.ok) {
    h += '<p class="muted">Could not load: ' + esc(r.data.error || String(r.status)) + '</p>';
    el.innerHTML = h;
    return;
  }
  const d = r.data;
  h += '<h3>Active Plugins</h3>';
  if (!d.plugins.length) h += '<p class="muted">No plugins installed.</p>';
  for (const p of d.plugins) {
    h += '<div class="card" style="display:flex;justify-content:space-between;align-items:center">';
    h += '<div><strong>' + esc(p) + '</strong> <span class="tag">plugin</span></div>';
    h += '<button class="danger sm" onclick="uninstallPlugin(\'' + esc(p) + '\')">Remove</button>';
    h += '</div>';
  }
  if (d.setupState.installedExtensions.length) {
    h += '<h3>Gallery Installations</h3>';
    for (const id of d.setupState.installedExtensions) {
      h += '<div class="card"><span class="tag">' + esc(id) + '</span></div>';
    }
  }
  el.innerHTML = h;
}

async function uninstallPlugin(pluginId) {
  if (!confirm('Remove "' + pluginId + '"? OpenCode will be restarted.')) return;
  await api('/admin/gallery/uninstall', { method: 'POST', body: JSON.stringify({ pluginId }) });
  loadInstalled();
}

/* ── services ─────────────────────────────────────────── */
async function loadServices() {
  const el = document.getElementById('page-services');
  let h = '<h2>Services</h2>';
  h += '<p class="muted">Health status, channel controls, and container management.</p>';

  const hc = await api('/admin/setup/health-check');
  if (hc.ok) {
    const s = hc.data.services;
    h += '<div class="grid3">';
    for (const [name, info] of Object.entries(s)) {
      h += '<div class="card"><span class="dot ' + (info.ok ? 'dot-ok' : 'dot-err') + '"></span><strong>' + esc(name) + '</strong>';
      h += '<div class="muted" style="font-size:13px">' + (info.ok ? 'Healthy' : esc(info.error || 'Unreachable')) + '</div></div>';
    }
    h += '</div>';
  }

  h += '<h3>Channels</h3>';
  const ch = await api('/admin/channels');
  if (ch.ok) {
    h += '<div class="grid2">';
    for (const c of ch.data.channels) {
      h += '<div class="card">';
      h += '<div style="display:flex;justify-content:space-between;align-items:center">';
      h += '<strong>' + esc(c.service) + '</strong>';
      h += '<span class="tag">' + esc(c.access.toUpperCase()) + '</span>';
      h += '</div>';
      h += '<div class="muted" style="font-size:13px;margin:.35rem 0">Network access: ' + (c.access === 'public' ? 'Public' : 'LAN only') + '</div>';
      if (!adminToken) {
        h += '<p class="muted" style="font-size:12px">Set your admin password in Settings to edit access/config.</p>';
      } else {
        if (c.service.startsWith('channel-')) {
          const next = c.access === 'public' ? 'lan' : 'public';
          const label = c.access === 'public' ? 'Set LAN only' : 'Set Public';
          h += `<button class="sm secondary" onclick="setChannelAccess('${esc(c.service)}','${next}')">${label}</button> `;
        }
        h += `<button class="sm" onclick="editChannelConfig('${esc(c.service)}')">Edit Config</button>`;
      }
      h += '</div>';
    }
    h += '</div>';
  }

  const known = ['gateway','opencode-core','openmemory','admin','controller','channel-chat','channel-discord','channel-voice','channel-telegram','caddy'];
  h += '<h3>Container Actions</h3>';
  if (!adminToken) {
    h += '<p class="muted">Set your admin password in Settings to manage containers.</p>';
  } else {
    h += '<div class="grid2">';
    for (const svc of known) {
      h += '<div class="card" style="display:flex;justify-content:space-between;align-items:center">';
      h += '<strong>' + esc(svc) + '</strong>';
      h += '<div style="display:flex;gap:.3rem">';
      h += `<button class="sm" onclick="svcAction('restart','${esc(svc)}')">Restart</button>`;
      h += `<button class="sm secondary" onclick="svcAction('up','${esc(svc)}')">Up</button>`;
      h += `<button class="sm danger" onclick="svcAction('down','${esc(svc)}')">Down</button>`;
      h += '</div></div>';
    }
    h += '</div>';
  }

  el.innerHTML = h;
}

async function setChannelAccess(service, access) {
  const channel = service === 'channel-chat' ? 'chat' : service === 'channel-voice' ? 'voice' : service === 'channel-discord' ? 'discord' : service === 'channel-telegram' ? 'telegram' : '';
  if (!channel) return;
  if (!confirm('Set ' + service + ' network access to ' + access.toUpperCase() + '? Caddy will restart.')) return;
  const r = await api('/admin/channels/access', { method: 'POST', body: JSON.stringify({ channel, access }) });
  alert(r.ok ? 'Updated.' : 'Failed: ' + (r.data.error || r.status));
  loadServices();
}

async function editChannelConfig(service) {
  const r = await api('/admin/channels/config?service=' + encodeURIComponent(service));
  if (!r.ok) return alert('Could not load config');
  const cfg = r.data.config || {};
  const preset = Object.entries(cfg).map(([k, v]) => k + '=' + (v || '')).join('\n');
  const next = prompt('Edit key=value lines for ' + service, preset);
  if (next === null) return;
  const out = {};
  for (const line of next.split(/\r?\n/)) {
    if (!line.includes('=')) continue;
    const idx = line.indexOf('=');
    const k = line.slice(0, idx).trim();
    const v = line.slice(idx + 1).trim();
    out[k] = v;
  }
  const wr = await api('/admin/channels/config', { method: 'POST', body: JSON.stringify({ service, config: out, restart: true }) });
  alert(wr.ok ? 'Config updated.' : 'Failed: ' + (wr.data.error || wr.status));
  loadServices();
}

async function svcAction(action, svc) {
  if (!confirm(action.toUpperCase() + ' ' + svc + '?')) return;
  const r = await api('/admin/containers/' + action, { method: 'POST', body: JSON.stringify({ service: svc }) });
  alert(r.ok ? 'Done.' : 'Failed: ' + (r.data.error || r.status));
  loadServices();
}

/* ── cron jobs ────────────────────────────────────────── */
let cronJobs = [];
let cronEditId = null;

async function loadCrons() {
  const el = document.getElementById('page-crons');
  let h = '<h2>Cron Jobs</h2>';
  h += '<p class="muted">Schedule recurring tasks that run on the OpenCode core agent via system cron. Changes will restart opencode-core to install the updated crontab.</p>';
  if (!adminToken) {
    h += '<p class="muted">Set your admin password in Settings to manage cron jobs.</p>';
    el.innerHTML = h;
    return;
  }
  const r = await api('/admin/crons');
  if (!r.ok) {
    h += '<p class="muted">Could not load: ' + esc(r.data.error || String(r.status)) + '</p>';
    el.innerHTML = h;
    return;
  }
  cronJobs = r.data.jobs || [];
  renderCrons();
}

function renderCrons() {
  const el = document.getElementById('page-crons');
  let h = '<h2>Cron Jobs</h2>';
  h += '<p class="muted">Schedule recurring tasks that run on the OpenCode core agent via system cron. Changes will restart opencode-core to install the updated crontab.</p>';

  // create / edit form
  h += '<div class="card">';
  h += '<h3>' + (cronEditId ? 'Edit Cron Job' : 'New Cron Job') + '</h3>';
  const editing = cronEditId ? cronJobs.find(j => j.id === cronEditId) : null;
  h += '<label style="display:block;margin:.4rem 0 .2rem;font-size:13px">Name</label>';
  h += '<input id="cron-name" placeholder="e.g. Daily summary" value="' + esc(editing ? editing.name : '') + '" />';
  h += '<label style="display:block;margin:.4rem 0 .2rem;font-size:13px">Schedule (cron expression)</label>';
  h += '<input id="cron-schedule" placeholder="e.g. 0 9 * * *  (every day at 9 AM)" value="' + esc(editing ? editing.schedule : '') + '" />';
  h += '<div class="muted" style="font-size:12px;margin:.2rem 0">Format: minute hour day-of-month month day-of-week &mdash; Examples: <code>*/5 * * * *</code> (every 5 min), <code>0 9 * * 1-5</code> (weekdays 9 AM), <code>0 0 1 * *</code> (1st of month)</div>';
  h += '<label style="display:block;margin:.4rem 0 .2rem;font-size:13px">Prompt</label>';
  h += '<textarea id="cron-prompt" rows="3" style="width:100%;font:inherit;padding:.45rem .7rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);resize:vertical" placeholder="The message to send to the agent...">' + esc(editing ? editing.prompt : '') + '</textarea>';
  h += '<div style="margin-top:.7rem;display:flex;gap:.5rem">';
  h += '<button onclick="saveCron()">' + (cronEditId ? 'Update' : 'Create') + '</button>';
  if (cronEditId) h += '<button class="secondary" onclick="cancelEditCron()">Cancel</button>';
  h += '</div></div>';

  // list
  if (!cronJobs.length) {
    h += '<p class="muted">No cron jobs configured yet.</p>';
  }
  for (const job of cronJobs) {
    h += '<div class="card">';
    h += '<div style="display:flex;justify-content:space-between;align-items:start">';
    h += '<div>';
    h += '<strong>' + esc(job.name) + '</strong> ';
    h += job.enabled
      ? '<span class="badge badge-low" style="font-size:11px">Enabled</span>'
      : '<span class="badge" style="font-size:11px;background:var(--muted)">Disabled</span>';
    h += '<div class="muted" style="font-size:13px;margin:.2rem 0"><code>' + esc(job.schedule) + '</code></div>';
    h += '<div style="font-size:13px;margin:.2rem 0">' + esc(job.prompt.length > 120 ? job.prompt.substring(0, 120) + '...' : job.prompt) + '</div>';
    h += '</div>';
    h += '<div style="display:flex;gap:.3rem;flex-shrink:0">';
    h += '<button class="sm" onclick="triggerCron(\'' + esc(job.id) + '\')">Run Now</button>';
    h += '<button class="sm secondary" onclick="toggleCron(\'' + esc(job.id) + '\',' + !job.enabled + ')">' + (job.enabled ? 'Disable' : 'Enable') + '</button>';
    h += '<button class="sm secondary" onclick="editCron(\'' + esc(job.id) + '\')">Edit</button>';
    h += '<button class="sm danger" onclick="deleteCron(\'' + esc(job.id) + '\')">Delete</button>';
    h += '</div></div></div>';
  }
  el.innerHTML = h;
}

async function saveCron() {
  const name = document.getElementById('cron-name').value.trim();
  const schedule = document.getElementById('cron-schedule').value.trim();
  const prompt = document.getElementById('cron-prompt').value.trim();
  if (!name || !schedule || !prompt) { alert('All fields are required.'); return; }

  if (cronEditId) {
    const r = await api('/admin/crons/update', { method: 'POST', body: JSON.stringify({ id: cronEditId, name, schedule, prompt }) });
    if (!r.ok) { alert('Failed: ' + (r.data.error || r.status)); return; }
    cronEditId = null;
  } else {
    const r = await api('/admin/crons', { method: 'POST', body: JSON.stringify({ name, schedule, prompt }) });
    if (!r.ok) { alert('Failed: ' + (r.data.error || r.status)); return; }
  }
  loadCrons();
}

function editCron(id) {
  cronEditId = id;
  renderCrons();
  document.getElementById('cron-name').focus();
}

function cancelEditCron() {
  cronEditId = null;
  renderCrons();
}

async function toggleCron(id, enabled) {
  const r = await api('/admin/crons/update', { method: 'POST', body: JSON.stringify({ id, enabled }) });
  if (!r.ok) { alert('Failed: ' + (r.data.error || r.status)); return; }
  loadCrons();
}

async function deleteCron(id) {
  if (!confirm('Delete this cron job?')) return;
  const r = await api('/admin/crons/delete', { method: 'POST', body: JSON.stringify({ id }) });
  if (!r.ok) { alert('Failed: ' + (r.data.error || r.status)); return; }
  loadCrons();
}

async function triggerCron(id) {
  const job = cronJobs.find(j => j.id === id);
  if (!confirm('Run "' + (job ? job.name : id) + '" now?')) return;
  const r = await api('/admin/crons/trigger', { method: 'POST', body: JSON.stringify({ id }) });
  if (r.ok) {
    alert('Job triggered against opencode-core.');
    loadCrons();
  } else {
    alert('Failed: ' + (r.data.error || r.status));
  }
}

/* ── settings ─────────────────────────────────────────── */
async function renderSettings() {
  const el = document.getElementById('page-settings');
  const status = await api('/admin/setup/status');
  const statusWarning = status.ok ? '' : '<p style="color:var(--yellow);font-size:13px">Could not load saved service instance settings from admin API. Showing empty defaults.</p>';
  const svc = status.ok && status.data && status.data.serviceInstances
    ? status.data.serviceInstances
    : { openmemory: '', psql: '', qdrant: '' };
  let h = '<h2>Settings</h2>';
  h += '<div class="card"><h3>Authentication</h3>';
  h += '<p class="muted" style="font-size:13px">Your admin password is stored in your browser only (localStorage) and sent as a header to the admin API.</p>';
  h += '<label style="display:block;margin:.5rem 0 .2rem;font-size:13px">Admin Password</label>';
  h += '<input type="password" id="set-admin" value="' + esc(adminToken) + '" />';
  h += '<div style="margin-top:.7rem"><button onclick="saveSettings()">Save</button></div>';
  h += '</div>';
  h += '<div class="card"><h3>Re-run Setup Wizard</h3>';
  h += '<p class="muted" style="font-size:13px">Revisit the initial setup steps.</p>';
  h += '<button class="secondary" onclick="runSetup()">Open Setup Wizard</button>';
  h += '</div>';
  h += '<div class="card"><h3>System Service Instances</h3>';
  h += '<p class="muted" style="font-size:13px">Optional: point OpenPalm at existing OpenMemory, Postgres, or Qdrant instances.</p>';
  h += statusWarning;
  h += '<p style="color:var(--yellow);font-size:13px"><strong>Warning:</strong> Changing these settings after initial setup may break memory access and existing workflows.</p>';
  h += '<label style="display:block;margin:.5rem 0 .2rem;font-size:13px">OpenMemory base URL</label>';
  h += '<input id="set-openmemory-url" placeholder="http://openmemory:3000" value="' + esc(svc.openmemory || '') + '" />';
  h += '<label style="display:block;margin:.5rem 0 .2rem;font-size:13px">Postgres connection URL</label>';
  h += '<input id="set-psql-url" placeholder="postgresql://user:pass@host:5432/db" value="' + esc(svc.psql || '') + '" />';
  h += '<label style="display:block;margin:.5rem 0 .2rem;font-size:13px">Qdrant URL</label>';
  h += '<input id="set-qdrant-url" placeholder="http://qdrant:6333" value="' + esc(svc.qdrant || '') + '" />';
  h += '<div style="margin-top:.7rem"><button onclick="saveServiceInstances()">Save Service Configuration</button></div>';
  h += '</div>';
  el.innerHTML = h;
}

function saveSettings() {
  adminToken = document.getElementById('set-admin').value;
  localStorage.setItem('op_admin', adminToken);
  alert('Saved.');
}

async function saveServiceInstances() {
  if (!confirm('Changing service instance settings after initial setup may break memory access and existing workflows. Continue?')) return;
  const openmemory = document.getElementById('set-openmemory-url')?.value || '';
  const psql = document.getElementById('set-psql-url')?.value || '';
  const qdrant = document.getElementById('set-qdrant-url')?.value || '';
  const r = await api('/admin/setup/service-instances', { method: 'POST', body: JSON.stringify({ openmemory, psql, qdrant }) });
  if (!r.ok) { alert('Failed: ' + (r.data?.error || 'Unknown error')); return; }
  alert('Service configuration saved.');
}

/* ── setup wizard ─────────────────────────────────────── */
async function checkSetup() {
  await window.openPalmSetup?.checkSetup();
}

function runSetup() {
  window.openPalmSetup?.runSetup();
}

/* ── utils ────────────────────────────────────────────── */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

/* ── init ─────────────────────────────────────────────── */
showPage('gallery');
window.openPalmSetup?.init({ api, esc, riskBadge, showPage, getAdminToken: () => adminToken, setAdminToken: (v) => { adminToken = v; localStorage.setItem('op_admin', v); } });
checkSetup();
</script>
</body>
</html>
