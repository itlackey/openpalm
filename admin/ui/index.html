<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenPalm Admin</title>
<style>
*,*::before,*::after{box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3348;--text:#e4e6f0;--muted:#8b8fa3;--accent:#6366f1;--accent2:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--purple:#a855f7;--radius:8px}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;font-size:15px;line-height:1.5}
a{color:var(--accent2)}
button{cursor:pointer;font:inherit;border:none;border-radius:var(--radius);padding:.5rem 1rem;background:var(--accent);color:#fff;transition:opacity .15s}
button:hover{opacity:.85}
button:disabled{opacity:.4;cursor:default}
button.secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
button.danger{background:var(--red)}
button.sm{padding:.3rem .7rem;font-size:13px}
input,select,textarea{font:inherit;padding:.45rem .7rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);width:100%}
input:focus,select:focus,textarea:focus{outline:2px solid var(--accent);outline-offset:-1px}
textarea{resize:vertical}
.container{max-width:960px;margin:0 auto;padding:1rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.card h3{margin:0 0 .5rem}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
@media(max-width:700px){.grid2,.grid3{grid-template-columns:1fr}}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.badge-lowest{background:var(--green)}.badge-low{background:#30d158}.badge-medium{background:var(--yellow);color:#000}.badge-medium-high{background:#ff6b35}.badge-highest{background:var(--red)}
.tag{display:inline-block;padding:1px 6px;border-radius:4px;font-size:11px;background:var(--surface2);color:var(--muted);margin:0 3px 3px 0}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot-ok{background:var(--green)}.dot-err{background:var(--red)}.dot-warn{background:var(--yellow)}
.muted{color:var(--muted)}
.mb{margin-bottom:1rem}
.hidden{display:none!important}
/* nav */
nav{background:var(--surface);border-bottom:1px solid var(--border);padding:.7rem 1rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
nav .logo{font-weight:700;font-size:18px;color:var(--accent2);margin-right:auto;display:flex;align-items:center;gap:.45rem}
nav .logo img{width:24px;height:24px;border-radius:6px}
nav button{background:transparent;color:var(--muted);padding:.3rem .8rem;border:1px solid transparent;font-size:14px}
nav button.active{color:var(--text);border-color:var(--accent);background:var(--surface2)}
@media(max-width:480px){nav{flex-wrap:wrap}nav .logo{width:100%;margin-bottom:.3rem}nav button{flex:1;font-size:12px;padding:.3rem .4rem}}
/* detail modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:90}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:560px;width:95%;max-height:80vh;overflow-y:auto}
.modal h3{margin:0 0 .5rem}
.sec-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin:.5rem 0}
.sec-box .sec-title{font-weight:600;font-size:13px;text-transform:uppercase;color:var(--muted);margin-bottom:.3rem}
.perm-list{list-style:none;padding:0;margin:.3rem 0}
.perm-list li::before{content:">";margin-right:6px;color:var(--accent)}
/* Toast notifications */
.toast-container{position:fixed;top:60px;right:1rem;z-index:200;display:flex;flex-direction:column;gap:.5rem}
.toast{padding:.7rem 1.2rem;border-radius:var(--radius);font-size:14px;animation:toast-in .3s ease;max-width:380px;border:1px solid var(--border)}
.toast-success{background:var(--surface);border-color:var(--green);color:var(--green)}
.toast-error{background:var(--surface);border-color:var(--red);color:var(--red)}
.toast-info{background:var(--surface);border-color:var(--accent);color:var(--text)}
@keyframes toast-in{from{opacity:0;transform:translateX(1rem)}to{opacity:1;transform:none}}
/* Inline confirm */
.inline-confirm{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin-top:.5rem}
/* Frequency picker */
.freq-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.freq-row select{width:auto}
/* View toggle */
.view-toggle{display:flex;gap:0;margin-bottom:1rem}
.view-toggle button{border-radius:0;border:1px solid var(--border);background:var(--surface2);color:var(--muted);padding:.4rem 1.2rem;font-size:14px}
.view-toggle button:first-child{border-radius:var(--radius) 0 0 var(--radius)}
.view-toggle button:last-child{border-radius:0 var(--radius) var(--radius) 0}
.view-toggle button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
/* Channel card */
.channel-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.channel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}
.channel-status{display:flex;align-items:center;gap:.4rem}
.help-text{font-size:12px;color:var(--muted);margin-top:.2rem}
.field-group{margin-bottom:.7rem}
.field-group label{display:block;font-size:13px;font-weight:600;margin-bottom:.2rem}
/* Access toggle */
.access-toggle{display:inline-flex;align-items:center;gap:.5rem;font-size:13px;padding:.3rem .6rem;border-radius:var(--radius);background:var(--surface2);border:1px solid var(--border)}
.access-toggle .toggle-dot{width:8px;height:8px;border-radius:50%}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
</style>
</head>
<body>
<a href="#main-content" class="sr-only" style="position:absolute;top:-40px;left:0;background:var(--accent);color:#fff;padding:.5rem 1rem;z-index:1000;transition:top .2s" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to content</a>

<nav>
  <span class="logo"><img src="logo.png" alt="OpenPalm logo" />OpenPalm</span>
  <button id="nav-extensions" onclick="showPage('extensions')">Extensions</button>
  <button id="nav-channels" onclick="showPage('channels')">Channels</button>
  <button id="nav-automations" onclick="showPage('automations')">Automations</button>
  <button id="nav-system" onclick="showPage('system')">System</button>
</nav>

<div class="container" id="main-content">
  <div id="page-extensions" class="page"></div>
  <div id="page-channels" class="page hidden"></div>
  <div id="page-automations" class="page hidden"></div>
  <div id="page-system" class="page hidden"></div>
</div>

<!-- setup wizard overlay, rendered by JS -->
<div id="setup-overlay" class="wizard-overlay hidden" role="dialog" aria-modal="true"></div>
<!-- detail modal, rendered by JS -->
<div id="modal-overlay" class="modal-overlay hidden" role="dialog" aria-modal="true" onclick="if(event.target===this)closeModal()"></div>

<script src="setup-ui.js"></script>
<script>
/* ── state ────────────────────────────────────────────── */
let adminToken = localStorage.getItem('op_admin') || '';
let currentPage = 'extensions';

/* Extensions page state */

/* Cron / Automations state */
let automations = [];
let automationEditId = null;

const BASE = '';
const ADMIN_PREFIX = '/admin/';
const ADMIN_API_PREFIX = '/admin/api/';
const BEHIND_CADDY = window.location.pathname.startsWith('/admin');

/* ── service name mapping (populated from /admin/meta) ── */
window.SERVICE_NAMES = {};
let CHANNEL_FIELDS = {};

async function loadMeta() {
  try {
    const r = await api('/admin/meta');
    if (r.ok && r.data) {
      if (r.data.serviceNames) window.SERVICE_NAMES = r.data.serviceNames;
      if (r.data.channelFields) CHANNEL_FIELDS = r.data.channelFields;
    }
  } catch (e) {
    // meta not available; SERVICE_NAMES and CHANNEL_FIELDS remain empty objects
  }
}

const CHANNEL_FRIENDLY = {
  'channel-chat': 'Chat',
  'channel-discord': 'Discord',
  'channel-voice': 'Voice',
  'channel-telegram': 'Telegram',
};

function friendlyServiceName(svc) {
  return (window.SERVICE_NAMES[svc] && window.SERVICE_NAMES[svc].label) || svc;
}

function normalizeAdminApiPath(path) {
  if (!BEHIND_CADDY) return path;
  if (path.startsWith(ADMIN_API_PREFIX)) return path;
  if (!path.startsWith(ADMIN_PREFIX)) return path;
  return ADMIN_API_PREFIX + path.slice(ADMIN_PREFIX.length);
}

/* ── API helper ───────────────────────────────────────── */
async function api(path, opts = {}) {
  const headers = { 'content-type': 'application/json', ...(opts.headers || {}) };
  if (adminToken) headers['x-admin-token'] = adminToken;
  const requestPath = normalizeAdminApiPath(path);
  try {
    const res = await fetch(BASE + requestPath, { ...opts, headers });
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
    catch { return { ok: res.ok, status: res.status, data: text }; }
  } catch (e) {
    return { ok: false, status: 0, data: { error: 'Server unreachable. Check that OpenPalm is running.' } };
  }
}

/* ── toast notifications ──────────────────────────────── */
function showToast(message, type) {
  if (!type) type = 'info';
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  const toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.setAttribute('role', 'alert');
  toast.setAttribute('aria-live', 'assertive');
  toast.textContent = message;
  toast.style.cursor = 'pointer';
  toast.onclick = function() { toast.remove(); };
  container.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 4000);
}

/* ── pages ────────────────────────────────────────────── */
function showPage(name) {
  currentPage = name;
  window.location.hash = name;
  document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
  document.getElementById('page-' + name).classList.remove('hidden');
  document.querySelectorAll('nav button').forEach(function(b) { b.classList.remove('active'); b.removeAttribute('aria-current'); });
  const nb = document.getElementById('nav-' + name);
  if (nb) { nb.classList.add('active'); nb.setAttribute('aria-current', 'page'); }
  const existing = document.getElementById('iframe-overlay');
  if (existing) existing.remove();
  document.querySelector('.container').style.display = '';
  if (name === 'extensions') loadExtensions();
  if (name === 'channels') loadChannels();
  if (name === 'automations') loadAutomations();
  if (name === 'system') loadSystem();
}

/* ── utils ────────────────────────────────────────────── */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function jsStr(s) {
  if (!s) return '';
  return String(s).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function friendlyError(msg) {
  if (!msg) return 'An unexpected error occurred';
  const s = String(msg);
  if (s.indexOf('admin token required') !== -1) return 'Please enter your admin password in Settings to continue';
  if (s.indexOf('invalid jsonc') !== -1) return 'The configuration file has a syntax error';
  if (s.indexOf('policy lint failed') !== -1 && s.indexOf('permission widening blocked') !== -1) return 'This change would weaken security protections and was blocked';
  return s;
}

function cronToHuman(expr) {
  if (!expr) return '';
  var PRESETS = {
    '0 * * * *': 'Every hour',
    '0 0 * * *': 'Every day at midnight',
    '0 9 * * *': 'Every day at 9:00 AM',
    '0 0 * * 1-5': 'Every weekday at midnight',
    '0 9 * * 1-5': 'Every weekday at 9:00 AM',
    '0 0 * * 1': 'Every Monday at midnight',
    '0 9 * * 1': 'Every Monday at 9:00 AM',
    '0 0 1 * *': 'Every month (1st) at midnight',
    '0 9 1 * *': 'Every month (1st) at 9:00 AM'
  };
  // Check exact preset matches
  if (PRESETS[expr]) return PRESETS[expr];
  // Try to parse "0 H * * *" pattern (daily at hour H)
  var m = expr.match(/^0 (\d{1,2}) \* \* \*$/);
  if (m) { var h = parseInt(m[1],10); return 'Every day at ' + (h === 0 ? '12:00 AM' : h < 12 ? h + ':00 AM' : h === 12 ? '12:00 PM' : (h-12) + ':00 PM'); }
  // Try "0 H * * 1-5" (weekdays at H)
  m = expr.match(/^0 (\d{1,2}) \* \* 1-5$/);
  if (m) { var h = parseInt(m[1],10); return 'Every weekday at ' + (h === 0 ? '12:00 AM' : h < 12 ? h + ':00 AM' : h === 12 ? '12:00 PM' : (h-12) + ':00 PM'); }
  return expr;
}

function toggleCollapse(el) {
  const body = el.parentElement.querySelector('.collapse-body');
  if (body) body.classList.toggle('hidden');
  const arrow = el.querySelector('.arrow');
  if (arrow) arrow.textContent = arrow.textContent === '\u25B6' ? '\u25BC' : '\u25B6';
}

/* ── inline confirm helper ────────────────────────────── */
function showInlineConfirm(containerId, message, onYes) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '<div class="inline-confirm"><p style="margin:0 0 .5rem;font-size:14px">' + esc(message) + '</p>' +
    '<div style="display:flex;gap:.4rem"><button class="sm danger" id="' + containerId + '-yes">Yes, continue</button>' +
    '<button class="sm secondary" id="' + containerId + '-no">Cancel</button></div></div>';
  document.getElementById(containerId + '-yes').onclick = function() {
    container.innerHTML = '';
    Promise.resolve(onYes()).catch(function(err) {
      showToast('Operation failed: ' + friendlyError(err.message), 'error');
    });
  };
  document.getElementById(containerId + '-no').onclick = function() {
    container.innerHTML = '';
  };
}

/* ── EXTENSIONS PAGE ──────────────────────────────────── */
async function loadExtensions() {
  await loadMyExtensions();
}

async function installPlugin() {
  const input = document.getElementById('plugin-install-id');
  const pluginId = input ? input.value.trim() : '';
  if (!pluginId) {
    showToast('Enter a plugin id.', 'error');
    return;
  }
  const r = await api('/admin/plugins/install', { method: 'POST', body: JSON.stringify({ pluginId }) });
  if (!r.ok) {
    showToast('Install failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
    return;
  }
  if (input) input.value = '';
  showToast('Plugin installed.', 'success');
  await loadMyExtensions();
}

async function loadMyExtensions() {
  const el = document.getElementById('page-extensions');
  let h = '<h2>Plugins</h2>';
  h += '<p class="muted">OpenPalm MVP plugin management: add or remove entries in the mounted OpenCode <code>plugin[]</code> list.</p>';
  h += '<div class="card" style="margin-bottom:1rem">';
  h += '<h3>Add Plugin</h3>';
  h += '<div style="display:flex;gap:.5rem">';
  h += '<input id="plugin-install-id" style="flex:1" placeholder="@scope/plugin or ./plugins/local.ts" />';
  h += '<button onclick="installPlugin()">Install</button>';
  h += '</div></div>';

  if (!adminToken) {
    h += '<p class="muted">Please enter your admin password in System settings.</p>';
    el.innerHTML = h;
    return;
  }

  const r = await api('/admin/installed');
  if (!r.ok) {
    h += '<p class="muted">Could not load plugins: ' + esc(friendlyError(r.data?.error || r.data?.message || 'Request failed')) + '</p>';
    el.innerHTML = h;
    return;
  }

  const plugins = Array.isArray(r.data.plugins) ? r.data.plugins : [];
  h += '<h3>Installed Plugins</h3>';
  if (!plugins.length) h += '<p class="muted">No plugins installed.</p>';
  for (let i = 0; i < plugins.length; i++) {
    const pluginId = plugins[i];
    h += '<div class="card" style="display:flex;justify-content:space-between;align-items:center">';
    h += '<div><strong>' + esc(pluginId) + '</strong></div>';
    h += '<div id="uninstall-confirm-' + i + '"><button class="danger sm" onclick="confirmUninstall(\'' + jsStr(pluginId) + '\',' + i + ')">Remove</button></div>';
    h += '</div>';
  }

  h += '<div class="card" style="margin-top:1rem"><strong>Manual OpenCode customization</strong><div class="muted" style="font-size:13px;margin-top:.3rem">Manage skills, agents, commands, and tools manually under OPENPALM_DATA_HOME/assistant/.config/opencode/.</div></div>';
  el.innerHTML = h;
}

function confirmUninstall(pluginId, index) {
  showInlineConfirm('uninstall-confirm-' + index,
    'Remove plugin "' + pluginId + '" and restart assistant?',
    function() { doUninstall(pluginId); }
  );
}

async function doUninstall(pluginId) {
  const r = await api('/admin/plugins/uninstall', { method: 'POST', body: JSON.stringify({ pluginId: pluginId }) });
  if (r.ok) {
    showToast('Plugin removed.', 'success');
  } else {
    showToast('Failed to remove: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
  loadMyExtensions();
}

/* ── CHANNELS PAGE ────────────────────────────────────── */
let channelsData = [];
let channelConfigs = {};
let channelSecretOptions = [];

async function loadChannels() {
  const el = document.getElementById('page-channels');
  el.innerHTML = '<h2>Channels</h2><p class="muted">Loading...</p>';
  let h = '<h2>Channels</h2>';
  h += '<p class="muted">Connect your assistant to different messaging platforms.</p>';

  const ch = await api('/admin/channels');
  if (!ch.ok) {
    h += '<p class="muted">Could not load channels.</p>';
    el.innerHTML = h;
    return;
  }
  channelsData = ch.data.channels || [];
  channelSecretOptions = ch.data.secretOptions || [];

  /* Use config data already included in the channels response */
  for (let ci = 0; ci < channelsData.length; ci++) {
    const c = channelsData[ci];
    if (c.service && c.config) {
      channelConfigs[c.service] = c.config;
    }
  }

  renderChannels();
}

function renderChannels() {
  const el = document.getElementById('page-channels');
  let h = '<h2>Channels</h2>';
  h += '<p class="muted">Connect your assistant to different messaging platforms.</p>';

  if (!channelsData.length) {
    h += '<p class="muted">No channels available.</p>';
    el.innerHTML = h;
    return;
  }

  for (let ci = 0; ci < channelsData.length; ci++) {
    const c = channelsData[ci];
    const svc = c.service;
    const friendly = CHANNEL_FRIENDLY[svc] || svc;
    const fields = CHANNEL_FIELDS[svc] || [];
    const cfg = channelConfigs[svc] || {};
    const mappings = c.secretMappings || {};

    h += '<div class="channel-card">';
    h += '<div class="channel-header">';
    h += '<div class="channel-status">';
    h += '<span class="dot ' + (c.access !== 'disabled' ? 'dot-ok' : 'dot-err') + '"></span>';
    h += '<span class="sr-only">' + (c.access !== 'disabled' ? 'Healthy' : 'Error') + '</span>';
    h += '<strong style="font-size:16px">' + esc(friendly) + '</strong>';
    h += '</div>';
    /* Access toggle */
    if (adminToken && svc.startsWith('channel-')) {
      if (c.access === 'public') {
        h += '<button class="access-toggle" onclick="toggleChannelAccess(\'' + jsStr(svc) + '\',\'lan\')" title="Currently accessible from the internet. Click to restrict to local network.">';
        h += '<span class="toggle-dot" style="background:var(--green)"></span> Public';
        h += '</button>';
      } else if (c.access === 'lan') {
        h += '<button class="access-toggle" onclick="toggleChannelAccess(\'' + jsStr(svc) + '\',\'public\')" title="Currently accessible on local network. Click to make accessible from the internet.">';
        h += '<span class="toggle-dot" style="background:var(--yellow)"></span> Local Network';
        h += '</button>';
      } else {
        h += '<button class="access-toggle" onclick="toggleChannelAccess(\'' + jsStr(svc) + '\',\'public\')" title="Currently disabled. Click to make accessible from the internet.">';
        h += '<span class="toggle-dot" style="background:var(--muted)"></span> Disabled';
        h += '</button>';
      }
    } else {
      if (c.access === 'public') {
        h += '<span class="tag">Public</span>';
      } else if (c.access === 'lan') {
        h += '<span class="tag">Local Network</span>';
      } else {
        h += '<span class="tag">Disabled</span>';
      }
    }
    h += '</div>';

    /* Inline config form */
    if (adminToken && fields.length > 0) {
      for (let fi = 0; fi < fields.length; fi++) {
        const f = fields[fi];
        const val = cfg[f.key] || '';
        h += '<div class="field-group">';
        h += '<label for="ch-' + esc(svc) + '-' + esc(f.key) + '">' + esc(f.label) + (f.required ? ' *' : '') + '</label>';
        h += '<input id="ch-' + esc(svc) + '-' + esc(f.key) + '" type="' + f.type + '" placeholder="' + esc(f.helpText || '') + '" value="' + esc(val) + '" />';
        h += '<div class="help-text">' + esc(f.helpText || '') + '</div>';
        h += '</div>';
      }
      h += '<div style="display:flex;gap:.5rem;align-items:center">';
      h += '<button class="sm" onclick="saveChannelConfig(\'' + jsStr(svc) + '\')">Save</button>';
      h += '</div>';
    } else if (!adminToken) {
      h += '<p class="muted" style="font-size:12px">Please enter your admin password in System settings to edit channel configuration.</p>';
    } else if (svc === 'channel-voice') {
      h += '<p class="muted" style="font-size:13px">No configuration needed for voice channel.</p>';
    }

    if (adminToken && svc.startsWith('channel-')) {
      const secretLabel = mappings.requiredEnvKey || 'CHANNEL_SECRET';
      h += '<div class="field-group" style="margin-top:.6rem">';
      h += '<label>Secret mapping for <code>' + esc(secretLabel) + '</code></label>';
      h += '<div style="display:flex;gap:.5rem;align-items:center">';
      h += '<select id="ch-secret-gw-' + esc(svc) + '">';
      for (let si = 0; si < channelSecretOptions.length; si++) {
        const opt = channelSecretOptions[si];
        const selected = mappings.gateway === opt ? ' selected' : '';
        h += '<option value="' + esc(opt) + '"' + selected + '>Gateway: ' + esc(opt) + '</option>';
      }
      h += '</select>';
      h += '<select id="ch-secret-ch-' + esc(svc) + '">';
      for (let si = 0; si < channelSecretOptions.length; si++) {
        const opt = channelSecretOptions[si];
        const selected = mappings.channel === opt ? ' selected' : '';
        h += '<option value="' + esc(opt) + '"' + selected + '>Channel: ' + esc(opt) + '</option>';
      }
      h += '</select>';
      h += '<button class="sm secondary" onclick="saveChannelSecretMapping(\'' + jsStr(svc) + '\')">Map secrets</button>';
      h += '</div>';
      h += '</div>';
    }

    h += '<div id="channel-access-confirm-' + esc(svc) + '" style="margin-top:.3rem"></div>';
    h += '</div>';
  }

  el.innerHTML = h;
}

function toggleChannelAccess(service, newAccess) {
  const channel = service === 'channel-chat' ? 'chat' : service === 'channel-voice' ? 'voice' : service === 'channel-discord' ? 'discord' : service === 'channel-telegram' ? 'telegram' : '';
  if (!channel) return;
  const msg = newAccess === 'public' ? 'Make accessible from the internet?' : newAccess === 'lan' ? 'Restrict to local network?' : 'Disable this channel?';
  showInlineConfirm('channel-access-confirm-' + service, msg, function() {
    doSetChannelAccess(service, channel, newAccess);
  });
}

async function doSetChannelAccess(service, channel, access) {
  const r = await api('/admin/channels/access', { method: 'POST', body: JSON.stringify({ channel: channel, access: access }) });
  if (r.ok) {
    showToast('Access updated.', 'success');
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
  loadChannels();
}

async function saveChannelConfig(service) {
  const fields = CHANNEL_FIELDS[service] || [];
  const out = {};
  for (let fi = 0; fi < fields.length; fi++) {
    const f = fields[fi];
    const el = document.getElementById('ch-' + service + '-' + f.key);
    if (el) out[f.key] = el.value;
  }
  const r = await api('/admin/channels/config', { method: 'POST', body: JSON.stringify({ service: service, config: out, restart: true }) });
  if (r.ok) {
    showToast('Channel configuration saved.', 'success');
    channelConfigs[service] = out;
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

async function saveChannelSecretMapping(service) {
  const channel = service === 'channel-chat' ? 'chat' : service === 'channel-voice' ? 'voice' : service === 'channel-discord' ? 'discord' : service === 'channel-telegram' ? 'telegram' : '';
  if (!channel) return;
  const gatewayEl = document.getElementById('ch-secret-gw-' + service);
  const channelEl = document.getElementById('ch-secret-ch-' + service);
  if (!gatewayEl || !channelEl) return;
  const gatewaySecret = gatewayEl.value;
  const channelSecret = channelEl.value;
  const r1 = await api('/admin/secrets/mappings/channel', { method: 'POST', body: JSON.stringify({ channel: channel, target: 'gateway', secretName: gatewaySecret }) });
  const r2 = await api('/admin/secrets/mappings/channel', { method: 'POST', body: JSON.stringify({ channel: channel, target: 'channel', secretName: channelSecret }) });
  if (r1.ok && r2.ok) {
    showToast('Secret mappings updated.', 'success');
    loadChannels();
  } else {
    showToast('Failed to update mappings.', 'error');
  }
}

/* ── AUTOMATIONS PAGE ─────────────────────────────────── */
const FREQ_PRESETS = [
  { label: 'Every hour', cron: '0 * * * *' },
  { label: 'Every day', cron: '0 9 * * *' },
  { label: 'Every weekday', cron: '0 9 * * 1-5' },
  { label: 'Every Monday', cron: '0 9 * * 1' },
  { label: 'Every month (1st)', cron: '0 9 1 * *' }
];

const HOUR_OPTIONS = [];
(function() {
  for (let hr = 0; hr < 24; hr++) {
    const ampm = hr < 12 ? 'AM' : 'PM';
    const h12 = hr === 0 ? 12 : hr > 12 ? hr - 12 : hr;
    HOUR_OPTIONS.push({ label: h12 + ':00 ' + ampm, value: hr });
  }
})();

function automationFromPreset(presetLabel, hour) {
  if (presetLabel === 'Every hour') return '0 * * * *';
  if (presetLabel === 'Every day') return '0 ' + hour + ' * * *';
  if (presetLabel === 'Every weekday') return '0 ' + hour + ' * * 1-5';
  if (presetLabel === 'Every Monday') return '0 ' + hour + ' * * 1';
  if (presetLabel === 'Every month (1st)') return '0 ' + hour + ' 1 * *';
  return '';
}

async function loadAutomations() {
  const el = document.getElementById('page-automations');
  el.innerHTML = '<h2>Automations</h2><p class="muted">Loading...</p>';
  let h = '<h2>Automations</h2>';
  h += '<p class="muted">Schedule recurring tasks for your assistant. Changes will restart your assistant to apply the new schedule.</p>';
  if (!adminToken) {
    h += '<p class="muted">Please enter your admin password in System settings to manage automations.</p>';
    el.innerHTML = h;
    return;
  }
  const r = await api('/admin/automations');
  if (!r.ok) {
    h += '<p class="muted">Could not load: ' + esc(friendlyError(r.data?.error || r.data?.message || 'Request failed')) + '</p>';
    el.innerHTML = h;
    return;
  }
  automations = r.data.automations || [];
  renderAutomations();
}

function renderAutomations() {
  const el = document.getElementById('page-automations');
  let h = '<h2>Automations</h2>';
  h += '<p class="muted">Schedule recurring tasks for your assistant. Changes will restart your assistant to apply the new schedule.</p>';

  /* create / edit form */
  h += '<div class="card">';
  h += '<h3>' + (automationEditId ? 'Edit Automation' : 'New Automation') + '</h3>';
  const editing = automationEditId ? automations.find(function(j) { return j.id === automationEditId; }) : null;

  h += '<div class="field-group">';
  h += '<label for="automation-name">Name</label>';
  h += '<input id="automation-name" placeholder="e.g. Daily summary" value="' + esc(editing ? editing.name : '') + '" />';
  h += '</div>';

  /* Frequency picker */
  h += '<div class="field-group">';
  h += '<label for="automation-freq-preset">Frequency</label>';
  h += '<div class="freq-row">';
  h += '<select id="automation-freq-preset" onchange="updateAutomationFromPreset()">';
  h += '<option value="">Choose a preset...</option>';
  for (let fi = 0; fi < FREQ_PRESETS.length; fi++) {
    h += '<option value="' + esc(FREQ_PRESETS[fi].cron) + '">' + esc(FREQ_PRESETS[fi].label) + '</option>';
  }
  h += '</select>';
  h += '<span id="automation-hour-group">';
  h += '<span class="muted" style="font-size:13px">at</span> ';
  h += '<select id="automation-freq-hour" onchange="updateAutomationFromPreset()">';
  for (let hi = 0; hi < HOUR_OPTIONS.length; hi++) {
    const sel = HOUR_OPTIONS[hi].value === 9 ? ' selected' : '';
    h += '<option value="' + HOUR_OPTIONS[hi].value + '"' + sel + '>' + esc(HOUR_OPTIONS[hi].label) + '</option>';
  }
  h += '</select>';
  h += '</span>';
  h += '</div>';
  h += '<div style="margin:.5rem 0;font-size:13px;color:var(--muted)">&mdash; or &mdash;</div>';
  h += '<label for="automation-schedule" style="font-size:13px">Custom schedule (cron expression)</label>';
  h += '<input id="automation-schedule" placeholder="e.g. 0 9 * * *  (every day at 9 AM)" value="' + esc(editing ? editing.schedule : '') + '" />';
  h += '<div class="help-text">Format: minute hour day-of-month month day-of-week. Examples: <code>*/5 * * * *</code> (every 5 min), <code>0 9 * * 1-5</code> (weekdays 9 AM)</div>';
  h += '</div>';

  h += '<div class="field-group">';
  h += '<label for="automation-script">Script to run</label>';
  h += '<textarea id="automation-script" rows="3" placeholder="e.g. Write a summary of today\'s events and send it to the team Discord channel">' + esc(editing ? editing.script : '') + '</textarea>';
  h += '</div>';

  h += '<div style="display:flex;gap:.5rem">';
  h += '<button onclick="saveAutomation()">' + (automationEditId ? 'Update' : 'Create') + '</button>';
  if (automationEditId) h += '<button class="secondary" onclick="cancelEditAutomation()">Cancel</button>';
  h += '</div></div>';

  /* list */
  if (!automations.length) {
    h += '<p class="muted">No automations configured yet.</p>';
  }
  for (let ji = 0; ji < automations.length; ji++) {
    const job = automations[ji];
    h += '<div class="card">';
    h += '<div style="display:flex;justify-content:space-between;align-items:start">';
    h += '<div>';
    h += '<strong>' + esc(job.name) + '</strong> ';
    h += job.enabled
      ? '<span class="badge badge-low" style="font-size:11px">Enabled</span>'
      : '<span class="badge" style="font-size:11px;background:var(--muted)">Disabled</span>';
    h += '<div class="muted" style="font-size:13px;margin:.2rem 0">' + cronToHuman(job.schedule) + ' <span class="muted" style="font-size:12px">(' + esc(job.schedule) + ')</span></div>';
    h += '<div style="font-size:13px;margin:.2rem 0">' + esc(job.script.length > 120 ? job.script.substring(0, 120) + '...' : job.script) + '</div>';
    h += '</div>';
    h += '<div style="display:flex;gap:.3rem;flex-shrink:0">';
    h += '<button class="sm" onclick="confirmTriggerAutomation(\'' + jsStr(job.id) + '\',' + ji + ')">Run Now</button>';
    h += '<button class="sm secondary" onclick="toggleAutomation(\'' + jsStr(job.id) + '\',' + (!job.enabled) + ')">' + (job.enabled ? 'Disable' : 'Enable') + '</button>';
    h += '<button class="sm secondary" onclick="editAutomation(\'' + jsStr(job.id) + '\')">Edit</button>';
    h += '<button class="sm danger" onclick="confirmDeleteAutomation(\'' + jsStr(job.id) + '\',' + ji + ')">Delete</button>';
    h += '</div></div>';
    h += '<div id="automation-action-confirm-' + ji + '"></div>';
    h += '</div>';
  }
  el.innerHTML = h;
}

function updateAutomationFromPreset() {
  const presetCron = document.getElementById('automation-freq-preset').value;
  const hour = document.getElementById('automation-freq-hour').value;
  var hourGroup = document.getElementById('automation-hour-group');
  if (hourGroup) hourGroup.style.display = presetCron === '0 * * * *' ? 'none' : '';
  if (!presetCron) return;
  // Replace the hour in the preset cron with the selected hour
  // For 'every hour' preset (0 * * * *), keep as-is
  if (presetCron === '0 * * * *') {
    document.getElementById('automation-schedule').value = presetCron;
    return;
  }
  // Replace the hour field (second token) with selected hour
  var expr = presetCron.replace(/^0 \d{1,2} /, '0 ' + hour + ' ');
  document.getElementById('automation-schedule').value = expr;
}

async function saveAutomation() {
  const name = document.getElementById('automation-name').value.trim();
  const schedule = document.getElementById('automation-schedule').value.trim();
  const script = document.getElementById('automation-script').value.trim();
  if (!name || !schedule || !script) { showToast('All fields are required.', 'error'); return; }

  if (automationEditId) {
    const r = await api('/admin/automations/update', { method: 'POST', body: JSON.stringify({ id: automationEditId, name: name, schedule: schedule, script: script }) });
    if (!r.ok) { showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error'); return; }
    automationEditId = null;
  } else {
    const r2 = await api('/admin/automations', { method: 'POST', body: JSON.stringify({ name: name, schedule: schedule, script: script }) });
    if (!r2.ok) { showToast('Failed: ' + friendlyError(r2.data?.error || r2.data?.message || 'Request failed'), 'error'); return; }
  }
  showToast('Automation saved.', 'success');
  loadAutomations();
}

function editAutomation(id) {
  automationEditId = id;
  renderAutomations();
  document.getElementById('automation-name').focus();
  // Auto-populate preset picker
  var job = automations.find(function(j) { return j.id === id; });
  var presetEl = document.getElementById('automation-freq-preset');
  var hourEl = document.getElementById('automation-freq-hour');
  if (presetEl && hourEl && job) {
    var matched = false;
    for (var i = 0; i < FREQ_PRESETS.length; i++) {
      var p = FREQ_PRESETS[i];
      if (p.cron === job.schedule) { presetEl.value = p.cron; matched = true; break; }
      // Check if it matches the pattern with a different hour
      var m = job.schedule.match(/^0 (\d{1,2}) (.*)$/);
      if (m && p.cron.match(/^0 \d{1,2} (.*)$/) && m[2] === p.cron.match(/^0 \d{1,2} (.*)$/)[1]) {
        presetEl.value = p.cron; hourEl.value = m[1]; matched = true; break;
      }
    }
    if (!matched) presetEl.value = '';
  }
}

function cancelEditAutomation() {
  automationEditId = null;
  renderAutomations();
}

async function toggleAutomation(id, newStatus) {
  const r = await api('/admin/automations/update', { method: 'POST', body: JSON.stringify({ id: id, enabled: newStatus }) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error'); return; }
  showToast(newStatus ? 'Automation enabled.' : 'Automation disabled.', 'success');
  loadAutomations();
}

function confirmDeleteAutomation(id, index) {
  showInlineConfirm('automation-action-confirm-' + index,
    'Delete this automation?',
    function() { doDeleteAutomation(id); }
  );
}

async function doDeleteAutomation(id) {
  const r = await api('/admin/automations/delete', { method: 'POST', body: JSON.stringify({ id: id }) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error'); return; }
  showToast('Automation deleted.', 'success');
  loadAutomations();
}

function confirmTriggerAutomation(id, index) {
  const job = automations.find(function(j) { return j.id === id; });
  showInlineConfirm('automation-action-confirm-' + index,
    'Run "' + (job ? job.name : 'this automation') + '" now?',
    function() { doTriggerAutomation(id); }
  );
}

async function doTriggerAutomation(id) {
  const r = await api('/admin/automations/trigger', { method: 'POST', body: JSON.stringify({ id: id }) });
  if (r.ok) {
    showToast('Task sent to your assistant.', 'success');
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

/* ── SYSTEM PAGE ──────────────────────────────────────── */
async function loadSystem() {
  const el = document.getElementById('page-system');
  el.innerHTML = '<h2>System</h2><p class="muted">Loading...</p>';
  let h = '<h2>System</h2>';

  /* Health Status */
  h += '<div class="card"><h3>Health Status</h3>';
  const hc = await api('/admin/setup/health-check');
  if (hc.ok) {
    const s = hc.data.services;
    h += '<div class="grid3">';
    for (const name in s) {
      if (!s.hasOwnProperty(name)) continue;
      const info = s[name];
      const friendly = friendlyServiceName(name);
      h += '<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem">';
      h += '<span class="dot ' + (info.ok ? 'dot-ok' : 'dot-err') + '"></span>';
      h += '<span class="sr-only">' + (info.ok ? 'Healthy' : 'Error') + '</span>';
      h += '<div><strong style="font-size:14px">' + esc(friendly) + '</strong>';
      h += '<div class="muted" style="font-size:12px">' + (info.ok ? 'Healthy' : esc(friendlyError(info.error || 'Unreachable'))) + '</div></div>';
      h += '</div>';
    }
    h += '</div>';
  } else {
    h += '<p class="muted">Could not load health status.</p>';
  }
  h += '</div>';

  /* Authentication */
  h += '<div class="card"><h3>Authentication</h3>';
  h += '<p class="muted" style="font-size:13px">This is the password you use to manage your assistant.</p>';
  h += '<div class="field-group">';
  h += '<label for="set-admin">Admin Password</label>';
  h += '<input type="password" id="set-admin" value="' + esc(adminToken) + '" />';
  h += '</div>';
  h += '<button onclick="saveSettings()">Save</button>';
  h += '</div>';

  /* Re-run Setup Wizard */
  h += '<div class="card"><h3>Re-run Setup Wizard</h3>';
  h += '<p class="muted" style="font-size:13px">Revisit the initial setup steps.</p>';
  h += '<button class="secondary" onclick="runSetup()">Open Setup Wizard</button>';
  h += '</div>';

  /* Advanced Configuration (collapsed) */
  const status = await api('/admin/setup/status');
  const svc = status.ok && status.data && status.data.serviceInstances
    ? status.data.serviceInstances
    : { openmemory: '', psql: '', qdrant: '' };

  h += '<div class="card">';
  h += '<h3 style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">';
  h += '<span class="arrow">&#9654;</span> Advanced Configuration</h3>';
  h += '<div class="collapse-body hidden">';
  h += '<p class="muted" style="font-size:13px">Only change these if you know what you are doing.</p>';
  if (!status.ok) {
    h += '<p style="color:var(--yellow);font-size:13px">Could not load saved settings. Showing empty defaults.</p>';
  }
  h += '<div class="field-group">';
  h += '<label>Memory service address</label>';
  h += '<input id="set-openmemory-url" placeholder="http://openmemory:8765" value="' + esc(svc.openmemory || '') + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>Database connection</label>';
  h += '<input id="set-psql-url" placeholder="postgresql://user:pass@host:5432/db" value="' + esc(svc.psql || '') + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>Search service address</label>';
  h += '<input id="set-qdrant-url" placeholder="http://qdrant:6333" value="' + esc(svc.qdrant || '') + '" />';
  h += '</div>';
  h += '<div id="advanced-save-confirm"></div>';
  h += '<button onclick="confirmSaveServiceInstances()">Save Configuration</button>';
  h += '</div></div>';

  /* Developer Tools (collapsed) */
  h += '<div class="card">';
  h += '<h3 style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">';
  h += '<span class="arrow">&#9654;</span> Developer Tools</h3>';
  h += '<div class="collapse-body hidden">';
  const assistantUrl = '/admin/opencode/';
  const openmemoryUrl = window.location.protocol + '//' + window.location.hostname + ':3000';
  h += '<div style="display:flex;flex-direction:column;gap:.5rem">';
  h += '<a href="' + esc(assistantUrl) + '" target="_blank">Open OpenCode UI</a>';
  h += '<a href="' + esc(openmemoryUrl) + '" target="_blank">Open Memory Dashboard</a>';
  h += '</div>';
  h += '</div></div>';

  /* Troubleshooting (collapsed) */
  h += '<div class="card">';
  h += '<h3 style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">';
  h += '<span class="arrow">&#9654;</span> Troubleshooting</h3>';
  h += '<div class="collapse-body hidden">';
  h += '<p style="color:var(--yellow);font-size:13px"><strong>Warning:</strong> These controls can disrupt your assistant. Only use them if something isn\'t working.</p>';
  if (!adminToken) {
    h += '<p class="muted">Please enter your admin password above to manage services.</p>';
  } else {
    const known = ['gateway','assistant','openmemory','openmemory-ui','admin','channel-chat','channel-discord','channel-voice','channel-telegram','caddy'];
    for (let ki = 0; ki < known.length; ki++) {
      const svcName = known[ki];
      h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid var(--border)">';
      h += '<span style="font-size:14px">' + esc(friendlyServiceName(svcName)) + '</span>';
      h += '<div id="svc-action-confirm-' + ki + '" style="display:inline-flex;gap:.3rem;align-items:center">';
      h += '<button class="sm secondary" onclick="confirmSvcRestart(\'' + jsStr(svcName) + '\',' + ki + ')">Restart</button>';
      h += '</div>';
      h += '</div>';
    }
  }
  h += '</div></div>';

  el.innerHTML = h;

}

/* ── Settings (Authentication) ────────────────────────── */
async function saveSettings() {
  var token = document.getElementById('set-admin').value;
  var testHeaders = { 'content-type': 'application/json', 'x-admin-token': token };
  try {
    var res = await fetch(BASE + normalizeAdminApiPath('/admin/installed'), { headers: testHeaders });
    if (res.status === 401) {
      showToast('Invalid admin password. Please check and try again.', 'error');
      return;
    }
  } catch(e) { /* server unreachable, save anyway */ }
  adminToken = token;
  localStorage.setItem('op_admin', adminToken);
  showToast('Password saved.', 'success');
}

function confirmSaveServiceInstances() {
  showInlineConfirm('advanced-save-confirm',
    'Changing these settings may affect how your assistant accesses memory and data. Are you sure?',
    function() { saveServiceInstances(); }
  );
}

async function saveServiceInstances() {
  const openmemory = document.getElementById('set-openmemory-url') ? document.getElementById('set-openmemory-url').value : '';
  const psql = document.getElementById('set-psql-url') ? document.getElementById('set-psql-url').value : '';
  const qdrant = document.getElementById('set-qdrant-url') ? document.getElementById('set-qdrant-url').value : '';
  const payload = { openmemory: openmemory, psql: psql, qdrant: qdrant };
  const r = await api('/admin/setup/service-instances', { method: 'POST', body: JSON.stringify(payload) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data ? r.data.error : 'Unknown error'), 'error'); return; }
  showToast('Configuration saved.', 'success');
}

/* ── Troubleshooting service actions ──────────────────── */
function confirmSvcRestart(svc, index) {
  showInlineConfirm('svc-action-confirm-' + index,
    'Restart ' + friendlyServiceName(svc) + '?',
    function() { doSvcAction('restart', svc); }
  );
}

async function doSvcAction(action, svc) {
  const r = await api('/admin/containers/' + action, { method: 'POST', body: JSON.stringify({ service: svc }) });
  if (r.ok) {
    showToast(friendlyServiceName(svc) + ' is restarting.', 'success');
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

/* ── setup wizard ─────────────────────────────────────── */
async function checkSetup() {
  await window.openPalmSetup?.checkSetup();
}

function runSetup() {
  window.openPalmSetup?.runSetup();
}

/* ── init ─────────────────────────────────────────────── */
loadMeta().then(function() {
  var initPage = window.location.hash.replace('#', '');
  if (['extensions','channels','automations','system'].indexOf(initPage) === -1) initPage = 'extensions';
  showPage(initPage);
  window.openPalmSetup?.init({ api: api, esc: esc, showPage: showPage, getAdminToken: function() { return adminToken; }, setAdminToken: function(v) { adminToken = v; localStorage.setItem('op_admin', v); } });
  checkSetup();
});

function trapFocus(overlayEl) {
  overlayEl._focusTrap = function(e) {
    if (e.key !== 'Tab') return;
    var focusable = overlayEl.querySelectorAll('button, input, select, textarea, a[href], [tabindex]:not([tabindex="-1"])');
    if (!focusable.length) return;
    var first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  };
  overlayEl.addEventListener('keydown', overlayEl._focusTrap);
}
function releaseFocus(overlayEl) {
  if (overlayEl._focusTrap) overlayEl.removeEventListener('keydown', overlayEl._focusTrap);
}

window.addEventListener('hashchange', function() {
  var page = window.location.hash.replace('#', '');
  if (['extensions','channels','automations','system'].indexOf(page) !== -1 && page !== currentPage) {
    showPage(page);
  }
});
</script>
</body>
</html>
