<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenPalm Admin</title>
<style>
*,*::before,*::after{box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3348;--text:#e4e6f0;--muted:#8b8fa3;--accent:#6366f1;--accent2:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--purple:#a855f7;--radius:8px}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;font-size:15px;line-height:1.5}
a{color:var(--accent2)}
button{cursor:pointer;font:inherit;border:none;border-radius:var(--radius);padding:.5rem 1rem;background:var(--accent);color:#fff;transition:opacity .15s}
button:hover{opacity:.85}
button:disabled{opacity:.4;cursor:default}
button.secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
button.danger{background:var(--red)}
button.sm{padding:.3rem .7rem;font-size:13px}
input,select,textarea{font:inherit;padding:.45rem .7rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);width:100%}
input:focus,select:focus,textarea:focus{outline:2px solid var(--accent);outline-offset:-1px}
textarea{resize:vertical}
.container{max-width:960px;margin:0 auto;padding:1rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.card h3{margin:0 0 .5rem}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
@media(max-width:700px){.grid2,.grid3{grid-template-columns:1fr}}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.badge-lowest{background:var(--green)}.badge-low{background:#30d158}.badge-medium{background:var(--yellow);color:#000}.badge-medium-high{background:#ff6b35}.badge-highest{background:var(--red)}
.tag{display:inline-block;padding:1px 6px;border-radius:4px;font-size:11px;background:var(--surface2);color:var(--muted);margin:0 3px 3px 0}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot-ok{background:var(--green)}.dot-err{background:var(--red)}.dot-warn{background:var(--yellow)}
.muted{color:var(--muted)}
.mb{margin-bottom:1rem}
.hidden{display:none!important}
/* nav */
nav{background:var(--surface);border-bottom:1px solid var(--border);padding:.7rem 1rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
nav .logo{font-weight:700;font-size:18px;color:var(--accent2);margin-right:auto;display:flex;align-items:center;gap:.45rem}
nav .logo img{width:24px;height:24px;border-radius:6px}
nav button{background:transparent;color:var(--muted);padding:.3rem .8rem;border:1px solid transparent;font-size:14px}
nav button.active{color:var(--text);border-color:var(--accent);background:var(--surface2)}
/* detail modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:90}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;max-width:560px;width:95%;max-height:80vh;overflow-y:auto}
.modal h3{margin:0 0 .5rem}
.sec-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin:.5rem 0}
.sec-box .sec-title{font-weight:600;font-size:13px;text-transform:uppercase;color:var(--muted);margin-bottom:.3rem}
.perm-list{list-style:none;padding:0;margin:.3rem 0}
.perm-list li::before{content:">";margin-right:6px;color:var(--accent)}
/* Toast notifications */
.toast-container{position:fixed;top:60px;right:1rem;z-index:200;display:flex;flex-direction:column;gap:.5rem}
.toast{padding:.7rem 1.2rem;border-radius:var(--radius);font-size:14px;animation:toast-in .3s ease;max-width:380px;border:1px solid var(--border)}
.toast-success{background:var(--surface);border-color:var(--green);color:var(--green)}
.toast-error{background:var(--surface);border-color:var(--red);color:var(--red)}
.toast-info{background:var(--surface);border-color:var(--accent);color:var(--text)}
@keyframes toast-in{from{opacity:0;transform:translateX(1rem)}to{opacity:1;transform:none}}
/* Inline confirm */
.inline-confirm{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin-top:.5rem}
/* Frequency picker */
.freq-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.freq-row select{width:auto}
/* View toggle */
.view-toggle{display:flex;gap:0;margin-bottom:1rem}
.view-toggle button{border-radius:0;border:1px solid var(--border);background:var(--surface2);color:var(--muted);padding:.4rem 1.2rem;font-size:14px}
.view-toggle button:first-child{border-radius:var(--radius) 0 0 var(--radius)}
.view-toggle button:last-child{border-radius:0 var(--radius) var(--radius) 0}
.view-toggle button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
/* Channel card */
.channel-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.channel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem}
.channel-status{display:flex;align-items:center;gap:.4rem}
.help-text{font-size:12px;color:var(--muted);margin-top:.2rem}
.field-group{margin-bottom:.7rem}
.field-group label{display:block;font-size:13px;font-weight:600;margin-bottom:.2rem}
/* Access toggle */
.access-toggle{display:inline-flex;align-items:center;gap:.5rem;font-size:13px;cursor:pointer;padding:.3rem .6rem;border-radius:var(--radius);background:var(--surface2);border:1px solid var(--border)}
.access-toggle .toggle-dot{width:8px;height:8px;border-radius:50%}
</style>
</head>
<body>

<nav>
  <span class="logo"><img src="logo.png" alt="OpenPalm logo" />OpenPalm</span>
  <button id="nav-extensions" onclick="showPage('extensions')">Extensions</button>
  <button id="nav-channels" onclick="showPage('channels')">Channels</button>
  <button id="nav-automations" onclick="showPage('automations')">Automations</button>
  <button id="nav-system" onclick="showPage('system')">System</button>
</nav>

<div class="container">
  <div id="page-extensions" class="page"></div>
  <div id="page-channels" class="page hidden"></div>
  <div id="page-automations" class="page hidden"></div>
  <div id="page-system" class="page hidden"></div>
</div>

<!-- setup wizard overlay, rendered by JS -->
<div id="setup-overlay" class="wizard-overlay hidden"></div>
<!-- detail modal, rendered by JS -->
<div id="modal-overlay" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()"></div>

<script src="setup-ui.js"></script>
<script>
/* ── state ────────────────────────────────────────────── */
let adminToken = localStorage.getItem('op_admin') || '';
let galleryItems = [];
let currentPage = 'extensions';

/* Extensions page state */
let extensionsView = 'browse'; // 'browse' or 'my'
let galleryFilter = '';
let galleryCat = '';
let npmSearchVisible = false;
let npmSearchResults = [];

/* Cron / Automations state */
let automations = [];
let automationEditId = null;

/* Providers state */
let providersList = [];
let providerAssignments = {};
let providerModels = [];
let selectedProviderId = '';

const BASE = '';
const ADMIN_PREFIX = '/admin/';
const ADMIN_API_PREFIX = '/admin/api/';
const BEHIND_CADDY = window.location.pathname.startsWith('/admin');

/* ── service name mapping (populated from /admin/meta) ── */
window.SERVICE_NAMES = {};
let CHANNEL_FIELDS = {};

async function loadMeta() {
  try {
    const r = await api('/admin/meta');
    if (r.ok && r.data) {
      if (r.data.serviceNames) window.SERVICE_NAMES = r.data.serviceNames;
      if (r.data.channelFields) CHANNEL_FIELDS = r.data.channelFields;
    }
  } catch (e) {
    // meta not available; SERVICE_NAMES and CHANNEL_FIELDS remain empty objects
  }
}

const CHANNEL_FRIENDLY = {
  'channel-chat': 'Chat',
  'channel-discord': 'Discord',
  'channel-voice': 'Voice',
  'channel-telegram': 'Telegram'
};

function friendlyServiceName(svc) {
  return (window.SERVICE_NAMES[svc] && window.SERVICE_NAMES[svc].label) || svc;
}

function normalizeAdminApiPath(path) {
  if (!BEHIND_CADDY) return path;
  if (path.startsWith(ADMIN_API_PREFIX)) return path;
  if (!path.startsWith(ADMIN_PREFIX)) return path;
  return ADMIN_API_PREFIX + path.slice(ADMIN_PREFIX.length);
}

/* ── API helper ───────────────────────────────────────── */
async function api(path, opts = {}) {
  const headers = { 'content-type': 'application/json', ...(opts.headers || {}) };
  if (adminToken) headers['x-admin-token'] = adminToken;
  const requestPath = normalizeAdminApiPath(path);
  const res = await fetch(BASE + requestPath, { ...opts, headers });
  const text = await res.text();
  try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
  catch { return { ok: res.ok, status: res.status, data: text }; }
}

/* ── toast notifications ──────────────────────────────── */
function showToast(message, type) {
  if (!type) type = 'info';
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  const toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.textContent = message;
  toast.style.cursor = 'pointer';
  toast.onclick = function() { toast.remove(); };
  container.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 4000);
}

/* ── pages ────────────────────────────────────────────── */
function showPage(name) {
  currentPage = name;
  document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
  document.getElementById('page-' + name).classList.remove('hidden');
  document.querySelectorAll('nav button').forEach(function(b) { b.classList.remove('active'); });
  const nb = document.getElementById('nav-' + name);
  if (nb) nb.classList.add('active');
  const existing = document.getElementById('iframe-overlay');
  if (existing) existing.remove();
  document.querySelector('.container').style.display = '';
  if (name === 'extensions') loadExtensions();
  if (name === 'channels') loadChannels();
  if (name === 'automations') loadAutomations();
  if (name === 'system') loadSystem();
}

/* ── risk badge ───────────────────────────────────────── */
function riskBadge(r) {
  const safe = esc(r);
  return '<span class="badge badge-' + safe + '">' + safe.charAt(0).toUpperCase() + safe.slice(1) + ' Risk</span>';
}

function categoryLabel(c) {
  if (c === 'plugin') return 'Capability';
  if (c === 'skill') return 'Behavior';
  if (c === 'command') return 'Command';
  if (c === 'agent') return 'Agent';
  if (c === 'tool') return 'Custom Tool';
  if (c === 'channel') return 'Channel';
  if (c === 'service') return 'Service';
  return c;
}

/* ── utils ────────────────────────────────────────────── */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function jsStr(s) {
  if (!s) return '';
  return String(s).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function friendlyError(msg) {
  if (!msg) return 'An unexpected error occurred';
  const s = String(msg);
  if (s.indexOf('admin token required') !== -1) return 'Please enter your admin password in Settings to continue';
  if (s.indexOf('invalid jsonc') !== -1) return 'The configuration file has a syntax error';
  if (s.indexOf('policy lint failed') !== -1 && s.indexOf('permission widening blocked') !== -1) return 'This change would weaken security protections and was blocked';
  return s;
}

function toggleCollapse(el) {
  const body = el.parentElement.querySelector('.collapse-body');
  if (body) body.classList.toggle('hidden');
  const arrow = el.querySelector('.arrow');
  if (arrow) arrow.textContent = arrow.textContent === '\u25B6' ? '\u25BC' : '\u25B6';
}

/* ── inline confirm helper ────────────────────────────── */
function showInlineConfirm(containerId, message, onYes) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '<div class="inline-confirm"><p style="margin:0 0 .5rem;font-size:14px">' + esc(message) + '</p>' +
    '<div style="display:flex;gap:.4rem"><button class="sm danger" id="' + containerId + '-yes">Yes, continue</button>' +
    '<button class="sm secondary" id="' + containerId + '-no">Cancel</button></div></div>';
  document.getElementById(containerId + '-yes').onclick = function() {
    container.innerHTML = '';
    Promise.resolve(onYes()).catch(function(err) {
      showToast('Operation failed: ' + friendlyError(err.message), 'error');
    });
  };
  document.getElementById(containerId + '-no').onclick = function() {
    container.innerHTML = '';
  };
}

/* ── EXTENSIONS PAGE ──────────────────────────────────── */
async function loadExtensions() {
  if (extensionsView === 'browse') {
    await loadGallery();
  } else {
    await loadMyExtensions();
  }
}

function renderExtensionsToggle() {
  let h = '<h2>Extensions</h2>';
  h += '<div class="view-toggle">';
  h += '<button class="' + (extensionsView === 'browse' ? 'active' : '') + '" onclick="extensionsView=\'browse\';loadExtensions()">Browse</button>';
  h += '<button class="' + (extensionsView === 'my' ? 'active' : '') + '" onclick="extensionsView=\'my\';loadExtensions()">My Extensions</button>';
  h += '</div>';
  return h;
}

async function loadGallery() {
  const qs = '/admin/gallery/search?q=' + encodeURIComponent(galleryFilter) + (galleryCat ? '&category=' + galleryCat : '');
  const r = await api(qs);
  galleryItems = r.ok ? r.data.items : [];
  renderGallery();
}

function renderGallery() {
  const el = document.getElementById('page-extensions');
  let h = renderExtensionsToggle();
  h += '<p class="muted">Search for extensions to add new capabilities, behaviors, and services to your assistant.</p>';
  h += '<div class="mb" style="display:flex;gap:.5rem;flex-wrap:wrap">';
  h += '<input id="gal-search" style="flex:1;min-width:200px" placeholder="Search extensions..." value="' + esc(galleryFilter) + '" onkeyup="if(event.key===\'Enter\'){galleryFilter=this.value;loadGallery()}" />';
  h += '<button class="sm" onclick="galleryFilter=document.getElementById(\'gal-search\').value;loadGallery()">Search</button>';
  h += '</div>';
  h += '<div class="mb" style="display:flex;gap:.4rem;flex-wrap:wrap">';
  h += catTab('', 'All');
  h += catTab('plugin', 'Capabilities');
  h += catTab('skill', 'Behaviors');
  h += catTab('command', 'Commands');
  h += catTab('agent', 'Agents');
  h += catTab('tool', 'Tools');
  h += catTab('channel', 'Channels');
  h += catTab('service', 'Services');
  h += '</div>';
  /* npm registry link */
  h += '<div class="mb">';
  if (!npmSearchVisible) {
    h += '<a href="#" style="font-size:13px" onclick="event.preventDefault();npmSearchVisible=true;renderGallery()">Advanced: Install from registry</a>';
  } else {
    h += '<div class="card">';
    h += '<h3 style="font-size:14px">Install from npm registry</h3>';
    h += '<div style="display:flex;gap:.5rem">';
    h += '<input id="npm-search-input" style="flex:1" placeholder="Search npm for OpenCode extensions..." />';
    h += '<button class="sm" onclick="doNpmSearch()">Search</button>';
    h += '<button class="sm secondary" onclick="npmSearchVisible=false;npmSearchResults=[];renderGallery()">Close</button>';
    h += '</div>';
    if (npmSearchResults.length > 0) {
      h += '<div style="margin-top:.7rem">';
      for (let i = 0; i < npmSearchResults.length; i++) {
        const pkg = npmSearchResults[i];
        h += '<div class="card" style="display:flex;justify-content:space-between;align-items:center;padding:.7rem">';
        h += '<div>';
        h += '<strong style="font-size:14px">' + esc(pkg.name) + '</strong> <span class="muted" style="font-size:12px">v' + esc(pkg.version) + '</span>';
        h += '<div class="muted" style="font-size:13px">' + esc((pkg.description || '').substring(0, 100)) + '</div>';
        h += '</div>';
        h += '<div id="npm-install-confirm-' + i + '">';
        h += '<button class="sm" onclick="confirmNpmInstall(' + i + ')">Install</button>';
        h += '</div>';
        h += '</div>';
      }
      h += '</div>';
    }
    h += '</div>';
  }
  h += '</div>';
  /* gallery items */
  if (!galleryItems.length) {
    h += '<p class="muted">No extensions found.</p>';
  }
  h += '<div class="grid2">';
  for (let gi = 0; gi < galleryItems.length; gi++) {
    const item = galleryItems[gi];
    h += '<div class="card" style="cursor:pointer" onclick="showDetail(\'' + jsStr(item.id) + '\')">';
    h += '<div style="display:flex;justify-content:space-between;align-items:start">';
    h += '<h3 style="margin:0">' + esc(item.name) + '</h3>';
    h += riskBadge(item.risk);
    h += '</div>';
    h += '<div class="muted" style="font-size:13px;margin:.3rem 0">' + categoryLabel(item.category) + ' by ' + esc(item.author) + '</div>';
    h += '<p style="font-size:14px;margin:.4rem 0">' + esc(item.description).substring(0, 120) + '</p>';
    h += '<div>';
    const tags = (item.tags || []).slice(0, 4);
    for (let ti = 0; ti < tags.length; ti++) h += '<span class="tag">' + esc(tags[ti]) + '</span>';
    h += '</div></div>';
  }
  h += '</div>';
  el.innerHTML = h;
}

function catTab(val, label) {
  const cls = galleryCat === val ? 'sm' : 'secondary sm';
  return '<button class="' + cls + '" onclick="galleryCat=\'' + val + '\';loadGallery()">' + label + '</button>';
}

async function doNpmSearch() {
  const q = document.getElementById('npm-search-input').value.trim();
  if (!q) return;
  const r = await api('/admin/gallery/npm-search?q=' + encodeURIComponent(q));
  if (!r.ok || !r.data.results || !r.data.results.length) {
    showToast('No results found.', 'info');
    npmSearchResults = [];
    renderGallery();
    return;
  }
  npmSearchResults = r.data.results.slice(0, 10);
  renderGallery();
}

function confirmNpmInstall(index) {
  const pkg = npmSearchResults[index];
  if (!pkg) return;
  showInlineConfirm('npm-install-confirm-' + index,
    'Install "' + pkg.name + '" from npm? This is an unreviewed package (high risk).',
    function() { doNpmInstall(pkg.name, index); }
  );
}

async function doNpmInstall(pkgName, index) {
  const r = await api('/admin/gallery/install', { method: 'POST', body: JSON.stringify({ pluginId: pkgName }) });
  if (r.ok) {
    showToast('Installed "' + pkgName + '" successfully.', 'success');
  } else {
    showToast('Install failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
  renderGallery();
}

/* ── detail modal ─────────────────────────────────────── */
async function showDetail(id) {
  const r = await api('/admin/gallery/item/' + id);
  if (!r.ok) return;
  const item = r.data.item;
  const badge = r.data.riskBadge;
  const ov = document.getElementById('modal-overlay');
  let h = '<div class="modal">';
  h += '<div style="display:flex;justify-content:space-between;align-items:start">';
  h += '<h3>' + esc(item.name) + '</h3>';
  h += '<button class="secondary sm" onclick="closeModal()">Close</button>';
  h += '</div>';
  h += '<div class="muted" style="font-size:13px">' + categoryLabel(item.category) + ' &middot; v' + esc(item.version) + ' &middot; by ' + esc(item.author) + '</div>';
  h += '<p>' + esc(item.description) + '</p>';
  h += '<div class="sec-box">';
  h += '<div class="sec-title">Security Assessment</div>';
  h += '<div style="margin-bottom:.4rem">' + riskBadge(item.risk) + ' <span class="muted" style="font-size:13px;margin-left:.5rem">' + esc(badge.description) + '</span></div>';
  h += '<div style="font-size:14px;margin:.5rem 0"><strong>Security notes:</strong> ' + esc(item.securityNotes) + '</div>';
  h += '<div class="sec-title" style="margin-top:.6rem">Permissions Required</div>';
  h += '<ul class="perm-list">';
  const perms = item.permissions || [];
  for (let pi = 0; pi < perms.length; pi++) h += '<li>' + esc(perms[pi]) + '</li>';
  h += '</ul></div>';
  h += '<div class="mb">';
  const itemTags = item.tags || [];
  for (let ti = 0; ti < itemTags.length; ti++) h += '<span class="tag">' + esc(itemTags[ti]) + '</span>';
  h += '</div>';
  h += '<div class="sec-box">';
  h += '<div class="sec-title">Defense in Depth</div>';
  h += '<div style="font-size:13px">';
  if (item.category === 'plugin') {
    h += 'Capabilities run inside the sandbox. They can hook into tool calls but cannot make network requests or access the filesystem outside the sandbox. A tool firewall provides a second layer of enforcement.';
  } else if (item.category === 'skill') {
    h += 'Behaviors are behavioral SOPs (markdown files). They have zero tool access and cannot execute code. They only influence how the assistant reasons and responds.';
  } else {
    h += 'Services run on an isolated network. All inbound messages pass through signature verification, rate limiting, and the tool firewall before reaching your assistant.';
  }
  h += '</div></div>';
  if (!adminToken) {
    h += '<p class="muted" style="font-size:13px">Set your admin password in System settings to enable installation.</p>';
  } else {
    h += '<div style="margin-top:1rem" id="gallery-install-confirm-' + esc(item.id) + '">';
    h += '<button onclick="confirmInstallGallery(\'' + jsStr(item.id) + '\',\'' + jsStr(item.name) + '\')">Install ' + esc(item.name) + '</button>';
    h += '</div>';
  }
  h += '</div>';
  ov.innerHTML = h;
  ov.classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
}

function confirmInstallGallery(id, name) {
  showInlineConfirm('gallery-install-confirm-' + id,
    'Install "' + name + '"? Your assistant will restart to apply changes.',
    function() { doInstallGallery(id); }
  );
}

async function doInstallGallery(id) {
  const r = await api('/admin/gallery/install', { method: 'POST', body: JSON.stringify({ galleryId: id }) });
  if (r.ok) {
    showToast('Installed successfully.', 'success');
    closeModal();
  } else {
    showToast('Install failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

/* ── My Extensions ────────────────────────────────────── */
async function loadMyExtensions() {
  const el = document.getElementById('page-extensions');
  let h = renderExtensionsToggle();
  h += '<p class="muted">Extensions currently active on your assistant.</p>';
  if (!adminToken) {
    h += '<p class="muted">Please enter your admin password in System settings to view installed extensions.</p>';
    el.innerHTML = h;
    return;
  }
  const r = await api('/admin/installed');
  if (!r.ok) {
    h += '<p class="muted">Could not load: ' + esc(friendlyError(r.data?.error || r.data?.message || 'Request failed')) + '</p>';
    el.innerHTML = h;
    return;
  }
  const d = r.data;
  h += '<h3>Active Capabilities</h3>';
  if (!d.plugins.length) h += '<p class="muted">No capabilities installed.</p>';
  for (let pi = 0; pi < d.plugins.length; pi++) {
    const p = d.plugins[pi];
    h += '<div class="card" style="display:flex;justify-content:space-between;align-items:center">';
    h += '<div><strong>' + esc(p) + '</strong> <span class="tag">Capability</span></div>';
    h += '<div id="uninstall-confirm-' + pi + '"><button class="danger sm" onclick="confirmUninstall(\'' + jsStr(p) + '\',' + pi + ')">Remove</button></div>';
    h += '</div>';
  }
  if (d.setupState && d.setupState.installedExtensions && d.setupState.installedExtensions.length) {
    h += '<h3>Installed Extensions</h3>';
    for (let ei = 0; ei < d.setupState.installedExtensions.length; ei++) {
      const extId = d.setupState.installedExtensions[ei];
      h += '<div class="card"><span class="tag">' + esc(extId) + '</span></div>';
    }
  }
  el.innerHTML = h;
}

function confirmUninstall(pluginId, index) {
  showInlineConfirm('uninstall-confirm-' + index,
    'Are you sure? Your assistant will restart to apply changes.',
    function() { doUninstall(pluginId); }
  );
}

async function doUninstall(pluginId) {
  const r = await api('/admin/gallery/uninstall', { method: 'POST', body: JSON.stringify({ pluginId: pluginId }) });
  if (r.ok) {
    showToast('Extension removed. Your assistant will restart to apply changes.', 'success');
  } else {
    showToast('Failed to remove: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
  loadMyExtensions();
}

/* ── CHANNELS PAGE ────────────────────────────────────── */
let channelsData = [];
let channelConfigs = {};

async function loadChannels() {
  const el = document.getElementById('page-channels');
  let h = '<h2>Channels</h2>';
  h += '<p class="muted">Connect your assistant to different messaging platforms.</p>';

  const ch = await api('/admin/channels');
  if (!ch.ok) {
    h += '<p class="muted">Could not load channels.</p>';
    el.innerHTML = h;
    return;
  }
  channelsData = ch.data.channels || [];

  /* Use config data already included in the channels response */
  for (let ci = 0; ci < channelsData.length; ci++) {
    const c = channelsData[ci];
    if (c.service && c.config) {
      channelConfigs[c.service] = c.config;
    }
  }

  renderChannels();
}

function renderChannels() {
  const el = document.getElementById('page-channels');
  let h = '<h2>Channels</h2>';
  h += '<p class="muted">Connect your assistant to different messaging platforms.</p>';

  if (!channelsData.length) {
    h += '<p class="muted">No channels available.</p>';
    el.innerHTML = h;
    return;
  }

  for (let ci = 0; ci < channelsData.length; ci++) {
    const c = channelsData[ci];
    const svc = c.service;
    const friendly = CHANNEL_FRIENDLY[svc] || svc;
    const fields = CHANNEL_FIELDS[svc] || [];
    const cfg = channelConfigs[svc] || {};

    h += '<div class="channel-card">';
    h += '<div class="channel-header">';
    h += '<div class="channel-status">';
    h += '<span class="dot ' + (c.access !== 'disabled' ? 'dot-ok' : 'dot-err') + '"></span>';
    h += '<strong style="font-size:16px">' + esc(friendly) + '</strong>';
    h += '</div>';
    /* Access toggle */
    if (adminToken && svc.startsWith('channel-')) {
      if (c.access === 'public') {
        h += '<span class="access-toggle" onclick="toggleChannelAccess(\'' + jsStr(svc) + '\',\'lan\')" title="Currently accessible from the internet. Click to restrict to local network.">';
        h += '<span class="toggle-dot" style="background:var(--green)"></span> Public';
        h += '</span>';
      } else if (c.access === 'lan') {
        h += '<span class="access-toggle" onclick="toggleChannelAccess(\'' + jsStr(svc) + '\',\'public\')" title="Currently accessible on local network. Click to make accessible from the internet.">';
        h += '<span class="toggle-dot" style="background:var(--yellow)"></span> Local Network';
        h += '</span>';
      } else {
        h += '<span class="access-toggle" onclick="toggleChannelAccess(\'' + jsStr(svc) + '\',\'public\')" title="Currently disabled. Click to make accessible from the internet.">';
        h += '<span class="toggle-dot" style="background:var(--muted)"></span> Disabled';
        h += '</span>';
      }
    } else {
      if (c.access === 'public') {
        h += '<span class="tag">Public</span>';
      } else if (c.access === 'lan') {
        h += '<span class="tag">Local Network</span>';
      } else {
        h += '<span class="tag">Disabled</span>';
      }
    }
    h += '</div>';

    /* Inline config form */
    if (adminToken && fields.length > 0) {
      for (let fi = 0; fi < fields.length; fi++) {
        const f = fields[fi];
        const val = cfg[f.key] || '';
        h += '<div class="field-group">';
        h += '<label>' + esc(f.label) + (f.required ? ' *' : '') + '</label>';
        h += '<input id="ch-' + esc(svc) + '-' + esc(f.key) + '" type="' + f.type + '" placeholder="' + esc(f.helpText || '') + '" value="' + esc(val) + '" />';
        h += '<div class="help-text">' + esc(f.helpText || '') + '</div>';
        h += '</div>';
      }
      h += '<div style="display:flex;gap:.5rem;align-items:center">';
      h += '<button class="sm" onclick="saveChannelConfig(\'' + jsStr(svc) + '\')">Save</button>';
      h += '</div>';
    } else if (!adminToken) {
      h += '<p class="muted" style="font-size:12px">Please enter your admin password in System settings to edit channel configuration.</p>';
    } else if (svc === 'channel-voice') {
      h += '<p class="muted" style="font-size:13px">No configuration needed for voice channel.</p>';
    }

    h += '<div id="channel-access-confirm-' + esc(svc) + '" style="margin-top:.3rem"></div>';
    h += '</div>';
  }

  el.innerHTML = h;
}

function toggleChannelAccess(service, newAccess) {
  const channel = service === 'channel-chat' ? 'chat' : service === 'channel-voice' ? 'voice' : service === 'channel-discord' ? 'discord' : service === 'channel-telegram' ? 'telegram' : '';
  if (!channel) return;
  const msg = newAccess === 'public' ? 'Make accessible from the internet?' : newAccess === 'lan' ? 'Restrict to local network?' : 'Disable this channel?';
  showInlineConfirm('channel-access-confirm-' + service, msg, function() {
    doSetChannelAccess(service, channel, newAccess);
  });
}

async function doSetChannelAccess(service, channel, access) {
  const r = await api('/admin/channels/access', { method: 'POST', body: JSON.stringify({ channel: channel, access: access }) });
  if (r.ok) {
    showToast('Access updated.', 'success');
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
  loadChannels();
}

async function saveChannelConfig(service) {
  const fields = CHANNEL_FIELDS[service] || [];
  const out = {};
  for (let fi = 0; fi < fields.length; fi++) {
    const f = fields[fi];
    const el = document.getElementById('ch-' + service + '-' + f.key);
    if (el) out[f.key] = el.value;
  }
  const r = await api('/admin/channels/config', { method: 'POST', body: JSON.stringify({ service: service, config: out, restart: true }) });
  if (r.ok) {
    showToast('Channel configuration saved.', 'success');
    channelConfigs[service] = out;
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

/* ── AUTOMATIONS PAGE ─────────────────────────────────── */
const FREQ_PRESETS = [
  { label: 'Every hour', cron: '0 * * * *' },
  { label: 'Every day', cron: '0 9 * * *' },
  { label: 'Every weekday', cron: '0 9 * * 1-5' },
  { label: 'Every Monday', cron: '0 9 * * 1' },
  { label: 'Every month (1st)', cron: '0 9 1 * *' }
];

const HOUR_OPTIONS = [];
(function() {
  for (let hr = 0; hr < 24; hr++) {
    const ampm = hr < 12 ? 'AM' : 'PM';
    const h12 = hr === 0 ? 12 : hr > 12 ? hr - 12 : hr;
    HOUR_OPTIONS.push({ label: h12 + ':00 ' + ampm, value: hr });
  }
})();

function cronFromPreset(presetLabel, hour) {
  if (presetLabel === 'Every hour') return '0 * * * *';
  if (presetLabel === 'Every day') return '0 ' + hour + ' * * *';
  if (presetLabel === 'Every weekday') return '0 ' + hour + ' * * 1-5';
  if (presetLabel === 'Every Monday') return '0 ' + hour + ' * * 1';
  if (presetLabel === 'Every month (1st)') return '0 ' + hour + ' 1 * *';
  return '';
}

async function loadAutomations() {
  const el = document.getElementById('page-automations');
  let h = '<h2>Automations</h2>';
  h += '<p class="muted">Schedule recurring tasks for your assistant. Changes will restart your assistant to apply the new schedule.</p>';
  if (!adminToken) {
    h += '<p class="muted">Please enter your admin password in System settings to manage automations.</p>';
    el.innerHTML = h;
    return;
  }
  const r = await api('/admin/automations');
  if (!r.ok) {
    h += '<p class="muted">Could not load: ' + esc(friendlyError(r.data?.error || r.data?.message || 'Request failed')) + '</p>';
    el.innerHTML = h;
    return;
  }
  automations = r.data.automations || [];
  renderAutomations();
}

function renderAutomations() {
  const el = document.getElementById('page-automations');
  let h = '<h2>Automations</h2>';
  h += '<p class="muted">Schedule recurring tasks for your assistant. Changes will restart your assistant to apply the new schedule.</p>';

  /* create / edit form */
  h += '<div class="card">';
  h += '<h3>' + (automationEditId ? 'Edit Automation' : 'New Automation') + '</h3>';
  const editing = automationEditId ? automations.find(function(j) { return j.id === automationEditId; }) : null;

  h += '<div class="field-group">';
  h += '<label>Name</label>';
  h += '<input id="cron-name" placeholder="e.g. Daily summary" value="' + esc(editing ? editing.name : '') + '" />';
  h += '</div>';

  /* Frequency picker */
  h += '<div class="field-group">';
  h += '<label>Frequency</label>';
  h += '<div class="freq-row">';
  h += '<select id="cron-freq-preset" onchange="updateCronFromPreset()">';
  h += '<option value="">Choose a preset...</option>';
  for (let fi = 0; fi < FREQ_PRESETS.length; fi++) {
    h += '<option value="' + esc(FREQ_PRESETS[fi].label) + '">' + esc(FREQ_PRESETS[fi].label) + '</option>';
  }
  h += '</select>';
  h += '<span class="muted" style="font-size:13px">at</span>';
  h += '<select id="cron-freq-hour" onchange="updateCronFromPreset()">';
  for (let hi = 0; hi < HOUR_OPTIONS.length; hi++) {
    const sel = HOUR_OPTIONS[hi].value === 9 ? ' selected' : '';
    h += '<option value="' + HOUR_OPTIONS[hi].value + '"' + sel + '>' + esc(HOUR_OPTIONS[hi].label) + '</option>';
  }
  h += '</select>';
  h += '</div>';
  h += '<div style="margin:.5rem 0;font-size:13px;color:var(--muted)">&mdash; or &mdash;</div>';
  h += '<label style="font-size:13px">Custom schedule (cron expression)</label>';
  h += '<input id="cron-schedule" placeholder="e.g. 0 9 * * *  (every day at 9 AM)" value="' + esc(editing ? editing.schedule : '') + '" />';
  h += '<div class="help-text">Format: minute hour day-of-month month day-of-week. Examples: <code>*/5 * * * *</code> (every 5 min), <code>0 9 * * 1-5</code> (weekdays 9 AM)</div>';
  h += '</div>';

  h += '<div class="field-group">';
  h += '<label>What should the assistant do?</label>';
  h += '<textarea id="cron-prompt" rows="3" placeholder="e.g. Write a summary of today\'s events and send it to the team Discord channel">' + esc(editing ? editing.prompt : '') + '</textarea>';
  h += '</div>';

  h += '<div style="display:flex;gap:.5rem">';
  h += '<button onclick="saveCron()">' + (automationEditId ? 'Update' : 'Create') + '</button>';
  if (automationEditId) h += '<button class="secondary" onclick="cancelEditCron()">Cancel</button>';
  h += '</div></div>';

  /* list */
  if (!automations.length) {
    h += '<p class="muted">No automations configured yet.</p>';
  }
  for (let ji = 0; ji < automations.length; ji++) {
    const job = automations[ji];
    h += '<div class="card">';
    h += '<div style="display:flex;justify-content:space-between;align-items:start">';
    h += '<div>';
    h += '<strong>' + esc(job.name) + '</strong> ';
    h += job.status === "enabled"
      ? '<span class="badge badge-low" style="font-size:11px">Enabled</span>'
      : '<span class="badge" style="font-size:11px;background:var(--muted)">Disabled</span>';
    h += '<div class="muted" style="font-size:13px;margin:.2rem 0"><code>' + esc(job.schedule) + '</code></div>';
    h += '<div style="font-size:13px;margin:.2rem 0">' + esc(job.prompt.length > 120 ? job.prompt.substring(0, 120) + '...' : job.prompt) + '</div>';
    h += '</div>';
    h += '<div style="display:flex;gap:.3rem;flex-shrink:0">';
    h += '<button class="sm" onclick="confirmTriggerCron(\'' + jsStr(job.id) + '\',' + ji + ')">Run Now</button>';
    h += '<button class="sm secondary" onclick="toggleCron(\'' + jsStr(job.id) + '\',\'' + (job.status === "enabled" ? "disabled" : "enabled") + '\')">' + (job.status === "enabled" ? 'Disable' : 'Enable') + '</button>';
    h += '<button class="sm secondary" onclick="editCron(\'' + jsStr(job.id) + '\')">Edit</button>';
    h += '<button class="sm danger" onclick="confirmDeleteCron(\'' + jsStr(job.id) + '\',' + ji + ')">Delete</button>';
    h += '</div></div>';
    h += '<div id="cron-action-confirm-' + ji + '"></div>';
    h += '</div>';
  }
  el.innerHTML = h;
}

function updateCronFromPreset() {
  const preset = document.getElementById('cron-freq-preset').value;
  const hour = document.getElementById('cron-freq-hour').value;
  if (!preset) return;
  const expr = cronFromPreset(preset, hour);
  if (expr) {
    document.getElementById('cron-schedule').value = expr;
  }
}

async function saveCron() {
  const name = document.getElementById('cron-name').value.trim();
  const schedule = document.getElementById('cron-schedule').value.trim();
  const prompt = document.getElementById('cron-prompt').value.trim();
  if (!name || !schedule || !prompt) { showToast('All fields are required.', 'error'); return; }

  if (automationEditId) {
    const r = await api('/admin/automations/update', { method: 'POST', body: JSON.stringify({ id: automationEditId, name: name, schedule: schedule, prompt: prompt }) });
    if (!r.ok) { showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error'); return; }
    automationEditId = null;
  } else {
    const r2 = await api('/admin/automations', { method: 'POST', body: JSON.stringify({ name: name, schedule: schedule, prompt: prompt }) });
    if (!r2.ok) { showToast('Failed: ' + friendlyError(r2.data?.error || r2.data?.message || 'Request failed'), 'error'); return; }
  }
  showToast('Automation saved.', 'success');
  loadAutomations();
}

function editCron(id) {
  automationEditId = id;
  renderAutomations();
  document.getElementById('cron-name').focus();
}

function cancelEditCron() {
  automationEditId = null;
  renderAutomations();
}

async function toggleCron(id, newStatus) {
  const r = await api('/admin/automations/update', { method: 'POST', body: JSON.stringify({ id: id, status: newStatus }) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error'); return; }
  showToast(newStatus === 'enabled' ? 'Automation enabled.' : 'Automation disabled.', 'success');
  loadAutomations();
}

function confirmDeleteCron(id, index) {
  showInlineConfirm('cron-action-confirm-' + index,
    'Delete this automation? Your assistant will restart to apply the new schedule.',
    function() { doDeleteCron(id); }
  );
}

async function doDeleteCron(id) {
  const r = await api('/admin/automations/delete', { method: 'POST', body: JSON.stringify({ id: id }) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error'); return; }
  showToast('Automation deleted.', 'success');
  loadAutomations();
}

function confirmTriggerCron(id, index) {
  const job = automations.find(function(j) { return j.id === id; });
  showInlineConfirm('cron-action-confirm-' + index,
    'Run "' + (job ? job.name : 'this automation') + '" now?',
    function() { doTriggerCron(id); }
  );
}

async function doTriggerCron(id) {
  const r = await api('/admin/automations/trigger', { method: 'POST', body: JSON.stringify({ id: id }) });
  if (r.ok) {
    showToast('Task sent to your assistant.', 'success');
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

/* ── SYSTEM PAGE ──────────────────────────────────────── */
async function loadSystem() {
  const el = document.getElementById('page-system');
  let h = '<h2>System</h2>';

  /* Health Status */
  h += '<div class="card"><h3>Health Status</h3>';
  const hc = await api('/admin/setup/health-check');
  if (hc.ok) {
    const s = hc.data.services;
    h += '<div class="grid3">';
    for (const name in s) {
      if (!s.hasOwnProperty(name)) continue;
      const info = s[name];
      const friendly = friendlyServiceName(name);
      h += '<div style="display:flex;align-items:center;gap:.5rem;padding:.5rem">';
      h += '<span class="dot ' + (info.ok ? 'dot-ok' : 'dot-err') + '"></span>';
      h += '<div><strong style="font-size:14px">' + esc(friendly) + '</strong>';
      h += '<div class="muted" style="font-size:12px">' + (info.ok ? 'Healthy' : esc(friendlyError(info.error || 'Unreachable'))) + '</div></div>';
      h += '</div>';
    }
    h += '</div>';
  } else {
    h += '<p class="muted">Could not load health status.</p>';
  }
  h += '</div>';

  /* Authentication */
  h += '<div class="card"><h3>Authentication</h3>';
  h += '<p class="muted" style="font-size:13px">This is the password you use to manage your assistant.</p>';
  h += '<div class="field-group">';
  h += '<label>Admin Password</label>';
  h += '<input type="password" id="set-admin" value="' + esc(adminToken) + '" />';
  h += '</div>';
  h += '<button onclick="saveSettings()">Save</button>';
  h += '</div>';

  /* Re-run Setup Wizard */
  h += '<div class="card"><h3>Re-run Setup Wizard</h3>';
  h += '<p class="muted" style="font-size:13px">Revisit the initial setup steps.</p>';
  h += '<button class="secondary" onclick="runSetup()">Open Setup Wizard</button>';
  h += '</div>';

  /* Providers */
  h += '<div class="card" id="providers-section">';
  h += renderProvidersSection();
  h += '</div>';

  /* Advanced Configuration (collapsed) */
  const status = await api('/admin/setup/status');
  const svc = status.ok && status.data && status.data.serviceInstances
    ? status.data.serviceInstances
    : { openmemory: '', psql: '', qdrant: '' };
  const openmemoryProvider = status.ok && status.data && status.data.openmemoryProvider
    ? status.data.openmemoryProvider
    : { openaiBaseUrl: '', openaiApiKeyConfigured: false };

  h += '<div class="card">';
  h += '<h3 style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">';
  h += '<span class="arrow">&#9654;</span> Advanced Configuration</h3>';
  h += '<div class="collapse-body hidden">';
  h += '<p class="muted" style="font-size:13px">Only change these if you know what you are doing.</p>';
  if (!status.ok) {
    h += '<p style="color:var(--yellow);font-size:13px">Could not load saved settings. Showing empty defaults.</p>';
  }
  h += '<div class="field-group">';
  h += '<label>Memory service address</label>';
  h += '<input id="set-openmemory-url" placeholder="http://openmemory:8765" value="' + esc(svc.openmemory || '') + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>Database connection</label>';
  h += '<input id="set-psql-url" placeholder="postgresql://user:pass@host:5432/db" value="' + esc(svc.psql || '') + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>Search service address</label>';
  h += '<input id="set-qdrant-url" placeholder="http://qdrant:6333" value="' + esc(svc.qdrant || '') + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>AI model endpoint for memory</label>';
  h += '<input id="set-openmemory-openai-base" placeholder="https://api.openai.com/v1" value="' + esc(openmemoryProvider.openaiBaseUrl || '') + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>AI model API key for memory</label>';
  h += '<input id="set-openmemory-openai-key" type="password" placeholder="sk-..." value="" />';
  h += '<div class="help-text">' + (openmemoryProvider.openaiApiKeyConfigured ? 'API key already configured. Leave blank to keep current key.' : 'Leave blank if not using an external AI model for memory.') + '</div>';
  h += '</div>';
  h += '<div id="advanced-save-confirm"></div>';
  h += '<button onclick="confirmSaveServiceInstances()">Save Configuration</button>';
  h += '</div></div>';

  /* Developer Tools (collapsed) */
  h += '<div class="card">';
  h += '<h3 style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">';
  h += '<span class="arrow">&#9654;</span> Developer Tools</h3>';
  h += '<div class="collapse-body hidden">';
  const opencodeUrl = '/admin/opencode/';
  const openmemoryUrl = window.location.protocol + '//' + window.location.hostname + ':3000';
  h += '<div style="display:flex;flex-direction:column;gap:.5rem">';
  h += '<a href="' + esc(opencodeUrl) + '" target="_blank">Open OpenCode UI</a>';
  h += '<a href="' + esc(openmemoryUrl) + '" target="_blank">Open Memory Dashboard</a>';
  h += '</div>';
  h += '</div></div>';

  /* Troubleshooting (collapsed) */
  h += '<div class="card">';
  h += '<h3 style="cursor:pointer;user-select:none" onclick="toggleCollapse(this)">';
  h += '<span class="arrow">&#9654;</span> Troubleshooting</h3>';
  h += '<div class="collapse-body hidden">';
  h += '<p style="color:var(--yellow);font-size:13px"><strong>Warning:</strong> These controls can disrupt your assistant. Only use them if something isn\'t working.</p>';
  if (!adminToken) {
    h += '<p class="muted">Please enter your admin password above to manage services.</p>';
  } else {
    const known = ['gateway','opencode-core','openmemory','openmemory-ui','admin','controller','channel-chat','channel-discord','channel-voice','channel-telegram','caddy'];
    for (let ki = 0; ki < known.length; ki++) {
      const svcName = known[ki];
      h += '<div style="display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid var(--border)">';
      h += '<span style="font-size:14px">' + esc(friendlyServiceName(svcName)) + '</span>';
      h += '<div id="svc-action-confirm-' + ki + '" style="display:inline-flex;gap:.3rem;align-items:center">';
      h += '<button class="sm secondary" onclick="confirmSvcRestart(\'' + jsStr(svcName) + '\',' + ki + ')">Restart</button>';
      h += '</div>';
      h += '</div>';
    }
  }
  h += '</div></div>';

  el.innerHTML = h;

  /* Now load providers data */
  await loadProvidersData();
}

/* ── Providers (embedded in System) ───────────────────── */
async function loadProvidersData() {
  const r = await api('/admin/providers');
  if (r.ok) {
    providersList = r.data.providers || [];
    providerAssignments = r.data.assignments || {};
  }
  const section = document.getElementById('providers-section');
  if (section) {
    section.innerHTML = renderProvidersSection();
  }
}

function renderProvidersSection() {
  let h = '<h3>Providers</h3>';
  h += '<p class="muted" style="font-size:13px">Manage AI provider connections and assign models to roles.</p>';

  h += '<div style="margin-bottom:1rem;padding:.8rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius)">';
  h += '<strong style="font-size:14px">Add Provider</strong>';
  h += '<div class="grid3" style="margin-top:.5rem">';
  h += '<div><label style="display:block;font-size:13px;margin-bottom:.2rem">Name</label>';
  h += '<input id="prov-name" placeholder="e.g. OpenAI, Ollama" /></div>';
  h += '<div><label style="display:block;font-size:13px;margin-bottom:.2rem">Base URL</label>';
  h += '<input id="prov-url" placeholder="https://api.openai.com/v1" /></div>';
  h += '<div><label style="display:block;font-size:13px;margin-bottom:.2rem">API Key</label>';
  h += '<input id="prov-key" type="password" placeholder="sk-..." /></div>';
  h += '</div>';
  h += '<div style="margin-top:.5rem"><button class="sm" onclick="addProvider()">Add Provider</button></div>';
  h += '</div>';

  if (providersList.length === 0) {
    h += '<p class="muted" style="font-size:13px">No providers configured yet. Add one above to get started.</p>';
  } else {
    h += '<div class="grid2">';
    for (let pi = 0; pi < providersList.length; pi++) {
      const p = providersList[pi];
      const isSmall = providerAssignments.small && providerAssignments.small.providerId === p.id;
      const isOpenmemory = providerAssignments.openmemory && providerAssignments.openmemory.providerId === p.id;
      h += '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem">';
      h += '<div style="display:flex;justify-content:space-between;align-items:start">';
      h += '<strong>' + esc(p.name) + '</strong>';
      h += '<button class="danger sm" onclick="deleteProvider(\'' + jsStr(p.id) + '\')">Delete</button>';
      h += '</div>';
      h += '<div class="muted" style="font-size:12px;margin:.2rem 0">' + esc(p.url || 'No URL') + '</div>';
      h += '<div class="muted" style="font-size:12px">Key: ' + (p.apiKey ? '------' : 'none') + '</div>';
      if (isSmall) h += '<div style="margin-top:.3rem"><span class="badge badge-low">Small Model</span> ' + esc(providerAssignments.small.modelId) + '</div>';
      if (isOpenmemory) h += '<div style="margin-top:.3rem"><span class="badge badge-medium">Memory Model</span> ' + esc(providerAssignments.openmemory.modelId) + '</div>';
      h += '<div style="margin-top:.4rem;display:flex;gap:.3rem;flex-wrap:wrap">';
      h += '<button class="secondary sm" onclick="fetchModels(\'' + jsStr(p.id) + '\')">Fetch Models</button>';
      h += '<button class="secondary sm" onclick="editProvider(\'' + jsStr(p.id) + '\')">Edit</button>';
      h += '</div>';
      h += '<div id="provider-delete-confirm-' + esc(p.id) + '"></div>';
      h += '</div>';
    }
    h += '</div>';
  }

  h += '<div id="provider-models-section"></div>';
  return h;
}

async function addProvider() {
  const name = document.getElementById('prov-name') ? document.getElementById('prov-name').value.trim() : '';
  const url = document.getElementById('prov-url') ? document.getElementById('prov-url').value.trim() : '';
  const apiKey = document.getElementById('prov-key') ? document.getElementById('prov-key').value.trim() : '';
  if (!name) { showToast('Provider name is required.', 'error'); return; }
  const r = await api('/admin/providers', { method: 'POST', body: JSON.stringify({ name: name, url: url, apiKey: apiKey }) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data ? r.data.error : 'Unknown error'), 'error'); return; }
  showToast('Provider added.', 'success');
  await loadProvidersData();
}

async function deleteProvider(id) {
  showInlineConfirm('provider-delete-confirm-' + id,
    'Delete this provider? Any model assignments will be removed.',
    async function() {
      const r = await api('/admin/providers/delete', { method: 'POST', body: JSON.stringify({ id: id }) });
      if (!r.ok) { showToast('Failed: ' + friendlyError(r.data ? r.data.error : 'Unknown error'), 'error'); return; }
      showToast('Provider deleted.', 'success');
      await loadProvidersData();
    }
  );
}

function editProvider(id) {
  const p = providersList.find(function(x) { return x.id === id; });
  if (!p) return;
  const el = document.getElementById('modal-overlay');
  let h = '<div class="modal">';
  h += '<h3>Edit Provider: ' + esc(p.name) + '</h3>';
  h += '<div class="field-group">';
  h += '<label>Name</label>';
  h += '<input id="edit-prov-name" value="' + esc(p.name) + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>Base URL</label>';
  h += '<input id="edit-prov-url" value="' + esc(p.url) + '" />';
  h += '</div>';
  h += '<div class="field-group">';
  h += '<label>API Key</label>';
  h += '<input id="edit-prov-key" type="password" placeholder="Leave blank to keep current" />';
  h += '</div>';
  h += '<div style="margin-top:1rem;display:flex;gap:.5rem">';
  h += '<button onclick="saveProviderEdit(\'' + jsStr(id) + '\')">Save</button>';
  h += '<button class="secondary" onclick="closeModal()">Cancel</button>';
  h += '</div></div>';
  el.innerHTML = h;
  el.classList.remove('hidden');
}

async function saveProviderEdit(id) {
  const name = document.getElementById('edit-prov-name') ? document.getElementById('edit-prov-name').value.trim() : '';
  const url = document.getElementById('edit-prov-url') ? document.getElementById('edit-prov-url').value.trim() : '';
  const apiKey = document.getElementById('edit-prov-key') ? document.getElementById('edit-prov-key').value.trim() : '';
  const payload = { id: id };
  if (name) payload.name = name;
  if (url !== undefined) payload.url = url;
  if (apiKey) payload.apiKey = apiKey;
  const r = await api('/admin/providers/update', { method: 'POST', body: JSON.stringify(payload) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data ? r.data.error : 'Unknown error'), 'error'); return; }
  closeModal();
  showToast('Provider updated.', 'success');
  await loadProvidersData();
}

async function fetchModels(providerId) {
  selectedProviderId = providerId;
  const section = document.getElementById('provider-models-section');
  if (!section) return;
  section.innerHTML = '<div style="padding:.5rem"><p class="muted">Fetching models...</p></div>';
  const r = await api('/admin/providers/models', { method: 'POST', body: JSON.stringify({ providerId: providerId }) });
  if (!r.ok) {
    section.innerHTML = '<div style="padding:.5rem;border:1px solid var(--red);border-radius:var(--radius)"><p style="color:var(--red);font-size:13px">Failed to fetch models: ' + esc(friendlyError(r.data ? (r.data.message || r.data.error) : 'Unknown error')) + '</p></div>';
    return;
  }
  providerModels = r.data.models || [];
  renderModelSelection();
}

function renderModelSelection() {
  const section = document.getElementById('provider-models-section');
  if (!section) return;
  const p = providersList.find(function(x) { return x.id === selectedProviderId; });
  if (!p || !providerModels.length) {
    section.innerHTML = '<div style="padding:.5rem"><p class="muted">No models found for this provider.</p></div>';
    return;
  }
  let h = '<div style="margin-top:.8rem"><strong>Available Models from ' + esc(p.name) + '</strong>';
  h += '<p class="muted" style="font-size:13px">Select a model and assign it to a role.</p>';
  h += '<div style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);margin:.5rem 0">';
  for (let mi = 0; mi < providerModels.length; mi++) {
    const m = providerModels[mi];
    h += '<div style="padding:.4rem .7rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">';
    h += '<span style="font-size:14px">' + esc(m.id) + '</span>';
    h += '<span style="display:flex;gap:.3rem">';
    h += '<button class="sm" onclick="assignModel(\'' + jsStr(m.id) + '\',\'small\')">Set Small</button>';
    h += '<button class="secondary sm" onclick="assignModel(\'' + jsStr(m.id) + '\',\'openmemory\')">Set Memory</button>';
    h += '</span>';
    h += '</div>';
  }
  h += '</div></div>';
  section.innerHTML = h;
}

async function assignModel(modelId, role) {
  const r = await api('/admin/providers/assign', { method: 'POST', body: JSON.stringify({ role: role, providerId: selectedProviderId, modelId: modelId }) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data ? r.data.error : 'Unknown error'), 'error'); return; }
  providerAssignments = r.data.assignments || {};
  showToast('Model "' + modelId + '" assigned as ' + role + '. Your assistant will restart to apply changes.', 'success');
  await loadProvidersData();
}

/* ── Settings (Authentication) ────────────────────────── */
function saveSettings() {
  adminToken = document.getElementById('set-admin').value;
  localStorage.setItem('op_admin', adminToken);
  showToast('Password saved.', 'success');
}

function confirmSaveServiceInstances() {
  showInlineConfirm('advanced-save-confirm',
    'Changing these settings may affect how your assistant accesses memory and data. Are you sure?',
    function() { saveServiceInstances(); }
  );
}

async function saveServiceInstances() {
  const openmemory = document.getElementById('set-openmemory-url') ? document.getElementById('set-openmemory-url').value : '';
  const psql = document.getElementById('set-psql-url') ? document.getElementById('set-psql-url').value : '';
  const qdrant = document.getElementById('set-qdrant-url') ? document.getElementById('set-qdrant-url').value : '';
  const openaiBaseUrl = document.getElementById('set-openmemory-openai-base') ? document.getElementById('set-openmemory-openai-base').value : '';
  const openaiApiKey = document.getElementById('set-openmemory-openai-key') ? document.getElementById('set-openmemory-openai-key').value : '';
  const payload = { openmemory: openmemory, psql: psql, qdrant: qdrant, openaiBaseUrl: openaiBaseUrl };
  if (openaiApiKey.trim()) payload.openaiApiKey = openaiApiKey.trim();
  const r = await api('/admin/setup/service-instances', { method: 'POST', body: JSON.stringify(payload) });
  if (!r.ok) { showToast('Failed: ' + friendlyError(r.data ? r.data.error : 'Unknown error'), 'error'); return; }
  showToast('Configuration saved.', 'success');
}

/* ── Troubleshooting service actions ──────────────────── */
function confirmSvcRestart(svc, index) {
  showInlineConfirm('svc-action-confirm-' + index,
    'Restart ' + friendlyServiceName(svc) + '?',
    function() { doSvcAction('restart', svc); }
  );
}

async function doSvcAction(action, svc) {
  const r = await api('/admin/containers/' + action, { method: 'POST', body: JSON.stringify({ service: svc }) });
  if (r.ok) {
    showToast(friendlyServiceName(svc) + ' is restarting.', 'success');
  } else {
    showToast('Failed: ' + friendlyError(r.data?.error || r.data?.message || 'Request failed'), 'error');
  }
}

/* ── setup wizard ─────────────────────────────────────── */
async function checkSetup() {
  await window.openPalmSetup?.checkSetup();
}

function runSetup() {
  window.openPalmSetup?.runSetup();
}

/* ── init ─────────────────────────────────────────────── */
loadMeta().then(function() {
  showPage('extensions');
  window.openPalmSetup?.init({ api: api, esc: esc, riskBadge: riskBadge, showPage: showPage, getAdminToken: function() { return adminToken; }, setAdminToken: function(v) { adminToken = v; localStorage.setItem('op_admin', v); } });
  checkSetup();
});
</script>
</body>
</html>
