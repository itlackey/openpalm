<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenPalm Admin</title>
<style>
*,*::before,*::after{box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3348;--text:#e4e6f0;--muted:#8b8fa3;--accent:#6366f1;--accent2:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444;--purple:#a855f7;--radius:8px}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;font-size:15px;line-height:1.5}
a{color:var(--accent2)}
button{cursor:pointer;font:inherit;border:none;border-radius:var(--radius);padding:.5rem 1rem;background:var(--accent);color:#fff;transition:opacity .15s}
button:hover{opacity:.85}
button:disabled{opacity:.4;cursor:default}
button.secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
button.danger{background:var(--red)}
button.sm{padding:.3rem .7rem;font-size:13px}
input,select,textarea{font:inherit;padding:.45rem .7rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface2);color:var(--text);width:100%}
input:focus,select:focus,textarea:focus{outline:2px solid var(--accent);outline-offset:-1px}
textarea{resize:vertical;font-family:monospace;font-size:13px}
.container{max-width:960px;margin:0 auto;padding:1rem}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;margin-bottom:1rem}
.card h3{margin:0 0 .5rem}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:700px){.grid2{grid-template-columns:1fr}}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.dot-ok{background:var(--green)}.dot-err{background:var(--red)}
.muted{color:var(--muted)}
.hidden{display:none!important}
nav{background:var(--surface);border-bottom:1px solid var(--border);padding:.7rem 1rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:10}
nav .logo{font-weight:700;font-size:18px;color:var(--accent2);margin-right:auto;display:flex;align-items:center;gap:.45rem}
nav .logo img{width:24px;height:24px;border-radius:6px}
nav button{background:transparent;color:var(--muted);padding:.3rem .8rem;border:1px solid transparent;font-size:14px}
nav button.active{color:var(--text);border-color:var(--accent);background:var(--surface2)}
.sec-box{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin:.5rem 0}
.sec-box .sec-title{font-weight:600;font-size:13px;text-transform:uppercase;color:var(--muted);margin-bottom:.3rem}
.toast-container{position:fixed;top:60px;right:1rem;z-index:200;display:flex;flex-direction:column;gap:.5rem}
.toast{padding:.7rem 1.2rem;border-radius:var(--radius);font-size:14px;animation:toast-in .3s ease;max-width:380px;border:1px solid var(--border)}
.toast-success{background:var(--surface);border-color:var(--green);color:var(--green)}
.toast-error{background:var(--surface);border-color:var(--red);color:var(--red)}
.toast-info{background:var(--surface);border-color:var(--accent);color:var(--text)}
@keyframes toast-in{from{opacity:0;transform:translateX(1rem)}to{opacity:1;transform:none}}
.inline-confirm{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:.8rem;margin-top:.5rem}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
.link-card{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);text-decoration:none;color:var(--text);transition:border-color .15s}
.link-card:hover{border-color:var(--accent)}
.link-card .link-icon{font-size:24px;width:40px;text-align:center}
</style>
</head>
<body>
<a href="#main-content" class="sr-only" style="position:absolute;top:-40px;left:0;background:var(--accent);color:#fff;padding:.5rem 1rem;z-index:1000;transition:top .2s" onfocus="this.style.top='0'" onblur="this.style.top='-40px'">Skip to content</a>

<nav>
  <span class="logo"><img src="logo.png" alt="OpenPalm logo" />OpenPalm</span>
  <button id="nav-dashboard" onclick="showPage('dashboard')">Dashboard</button>
</nav>

<div class="container" id="main-content">
  <div id="page-dashboard" class="page"></div>
</div>

<!-- setup wizard overlay, rendered by JS -->
<div id="setup-overlay" class="wizard-overlay hidden" role="dialog" aria-modal="true"></div>

<script src="setup-ui.js"></script>
<script>
/* ── state ────────────────────────────────────────────── */
let adminToken = localStorage.getItem('op_admin') || '';
let currentPage = 'dashboard';

const BASE = '';
const ADMIN_PREFIX = '/admin/';
const ADMIN_API_PREFIX = '/admin/api/';
const BEHIND_CADDY = window.location.pathname.startsWith('/admin');

window.SERVICE_NAMES = {};

async function loadMeta() {
  try {
    const r = await api('/admin/meta');
    if (r.ok && r.data && r.data.serviceNames) window.SERVICE_NAMES = r.data.serviceNames;
  } catch (e) {}
}

function friendlyServiceName(svc) {
  return (window.SERVICE_NAMES[svc] && window.SERVICE_NAMES[svc].label) || svc;
}

function normalizeAdminApiPath(path) {
  if (!BEHIND_CADDY) return path;
  if (path.startsWith(ADMIN_API_PREFIX)) return path;
  if (!path.startsWith(ADMIN_PREFIX)) return path;
  return ADMIN_API_PREFIX + path.slice(ADMIN_PREFIX.length);
}

/* ── API helper ───────────────────────────────────────── */
async function api(path, opts = {}) {
  const headers = { 'content-type': 'application/json', ...(opts.headers || {}) };
  if (adminToken) headers['x-admin-token'] = adminToken;
  const requestPath = normalizeAdminApiPath(path);
  try {
    const res = await fetch(BASE + requestPath, { ...opts, headers });
    const text = await res.text();
    try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
    catch { return { ok: res.ok, status: res.status, data: text }; }
  } catch (e) {
    return { ok: false, status: 0, data: { error: 'Server unreachable. Check that OpenPalm is running.' } };
  }
}

/* ── toast notifications ──────────────────────────────── */
function showToast(message, type) {
  if (!type) type = 'info';
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }
  const toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.setAttribute('role', 'alert');
  toast.textContent = message;
  toast.style.cursor = 'pointer';
  toast.onclick = function() { toast.remove(); };
  container.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 4000);
}

/* ── pages ────────────────────────────────────────────── */
function showPage(name) {
  currentPage = name;
  document.querySelectorAll('.page').forEach(function(p) { p.classList.add('hidden'); });
  var el = document.getElementById('page-' + name);
  if (el) el.classList.remove('hidden');
  document.querySelectorAll('nav button').forEach(function(b) { b.classList.remove('active'); });
  var nb = document.getElementById('nav-' + name);
  if (nb) { nb.classList.add('active'); nb.setAttribute('aria-current', 'page'); }
  if (name === 'dashboard') loadDashboard();
}

/* ── utils ────────────────────────────────────────────── */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}

function friendlyError(msg) {
  if (!msg) return 'An unexpected error occurred';
  const s = String(msg);
  if (s.indexOf('admin token required') !== -1) return 'Please enter your admin password to continue';
  return s;
}

/* ── inline confirm helper ────────────────────────────── */
function showInlineConfirm(containerId, message, onYes) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '<div class="inline-confirm"><p style="margin:0 0 .5rem;font-size:14px">' + esc(message) + '</p>' +
    '<div style="display:flex;gap:.4rem"><button class="sm danger" id="' + containerId + '-yes">Yes</button>' +
    '<button class="sm secondary" id="' + containerId + '-no">Cancel</button></div></div>';
  document.getElementById(containerId + '-yes').onclick = function() {
    container.innerHTML = '';
    Promise.resolve(onYes()).catch(function(err) {
      showToast('Failed: ' + friendlyError(err.message), 'error');
    });
  };
  document.getElementById(containerId + '-no').onclick = function() {
    container.innerHTML = '';
  };
}

/* ── DASHBOARD PAGE ──────────────────────────────────── */
async function loadDashboard() {
  const el = document.getElementById('page-dashboard');
  if (!el) return;
  let h = '';

  /* ── Quick Links ─────────────────────────────────────── */
  h += '<h2>Dashboard</h2>';
  const assistantUrl = '/admin/opencode/';
  const openmemoryUrl = window.location.protocol + '//' + window.location.hostname + ':3000';
  h += '<div class="grid2" style="margin-bottom:1rem">';
  h += '<a class="link-card" href="' + esc(assistantUrl) + '" target="_blank">';
  h += '<div class="link-icon">&#9997;</div>';
  h += '<div><strong>Open OpenCode</strong><div class="muted" style="font-size:13px">Web-based AI assistant interface</div></div>';
  h += '</a>';
  h += '<a class="link-card" href="' + esc(openmemoryUrl) + '" target="_blank">';
  h += '<div class="link-icon">&#128065;</div>';
  h += '<div><strong>Open Memory Dashboard</strong><div class="muted" style="font-size:13px">View and manage stored memories</div></div>';
  h += '</a>';
  h += '</div>';

  /* ── Authentication ──────────────────────────────────── */
  h += '<div class="card"><h3>Admin Password</h3>';
  h += '<p class="muted" style="font-size:13px">Enter your <code>ADMIN_TOKEN</code> from secrets.env to authenticate.</p>';
  h += '<div style="display:flex;gap:.5rem"><input type="password" id="set-admin" value="' + esc(adminToken) + '" style="flex:1" />';
  h += '<button onclick="saveAdminToken()">Save</button></div>';
  h += '</div>';

  /* ── Stack Spec Editor ───────────────────────────────── */
  h += '<div class="card"><h3>Stack Spec</h3>';
  h += '<p class="muted" style="font-size:13px">Edit the stack specification to configure channels, automations, and access scope. Save, then Apply to regenerate configuration files and restart services.</p>';
  h += '<textarea id="stack-spec-editor" rows="16" style="width:100%;margin:.5rem 0" placeholder="Loading..."></textarea>';
  h += '<div style="display:flex;gap:.5rem">';
  h += '<button onclick="saveStackSpec()">Save Spec</button>';
  h += '<button class="secondary" onclick="applyStack()">Apply Changes</button>';
  h += '<button class="secondary" onclick="loadStackSpec()">Reload</button>';
  h += '</div>';
  h += '<div id="stack-spec-status" style="margin-top:.5rem;font-size:13px"></div>';
  h += '</div>';

  /* ── Secrets Editor ──────────────────────────────────── */
  h += '<div class="card"><h3>Secrets</h3>';
  h += '<p class="muted" style="font-size:13px">Edit the secrets.env file directly. Each line is <code>KEY=value</code>. After saving, apply the stack to propagate changes to services.</p>';
  h += '<textarea id="secrets-editor" rows="10" style="width:100%;margin:.5rem 0" placeholder="Loading..."></textarea>';
  h += '<div style="display:flex;gap:.5rem">';
  h += '<button onclick="saveSecrets()">Save Secrets</button>';
  h += '<button class="secondary" onclick="loadSecrets()">Reload</button>';
  h += '</div>';
  h += '<div id="secrets-status" style="margin-top:.5rem;font-size:13px"></div>';
  h += '</div>';

  /* ── Setup Wizard ────────────────────────────────────── */
  h += '<div class="card"><h3>Setup Wizard</h3>';
  h += '<p class="muted" style="font-size:13px">Re-run the initial setup wizard to reconfigure channels, API keys, and access scope.</p>';
  h += '<button class="secondary" onclick="runSetup()">Run Setup Wizard</button>';
  h += '</div>';

  /* ── Health Status ───────────────────────────────────── */
  h += '<div class="card"><h3>Health Status</h3>';
  h += '<div id="health-status">Loading...</div>';
  h += '</div>';

  el.innerHTML = h;

  // Load data
  loadStackSpec();
  loadSecrets();
  loadHealth();
}

async function loadStackSpec() {
  var editor = document.getElementById('stack-spec-editor');
  if (!editor) return;
  if (!adminToken) { editor.value = '(Enter admin password above to load)'; return; }
  var r = await api('/admin/stack/spec');
  if (r.ok && r.data && r.data.spec) {
    editor.value = JSON.stringify(r.data.spec, null, 2);
  } else {
    editor.value = '// Could not load stack spec: ' + (r.data?.error || 'unknown error');
  }
}

async function saveStackSpec() {
  var editor = document.getElementById('stack-spec-editor');
  var status = document.getElementById('stack-spec-status');
  if (!editor || !adminToken) { showToast('Enter admin password first.', 'error'); return; }
  var spec;
  try { spec = JSON.parse(editor.value); } catch (e) { showToast('Invalid JSON: ' + e.message, 'error'); return; }
  var r = await api('/admin/stack/spec', { method: 'POST', body: JSON.stringify({ spec: spec }) });
  if (r.ok) {
    showToast('Stack spec saved.', 'success');
    if (status) status.textContent = 'Saved. Click "Apply Changes" to regenerate configs and restart services.';
  } else {
    showToast('Save failed: ' + friendlyError(r.data?.error || r.data?.details), 'error');
    if (status) status.textContent = '';
  }
}

async function applyStack() {
  var status = document.getElementById('stack-spec-status');
  if (!adminToken) { showToast('Enter admin password first.', 'error'); return; }
  if (status) status.innerHTML = '<span class="muted">Applying...</span>';
  var r = await api('/admin/stack/apply', { method: 'POST' });
  if (r.ok) {
    showToast('Stack applied successfully.', 'success');
    if (status) {
      var impact = r.data?.impact || {};
      var parts = [];
      if (impact.restart?.length) parts.push('Restarted: ' + impact.restart.join(', '));
      if (impact.reload?.length) parts.push('Reloaded: ' + impact.reload.join(', '));
      if (impact.up?.length) parts.push('Started: ' + impact.up.join(', '));
      status.textContent = parts.length ? parts.join('. ') : 'Applied (no changes detected).';
    }
  } else {
    showToast('Apply failed: ' + friendlyError(r.data?.error || r.data?.details), 'error');
    if (status) status.textContent = '';
  }
}

async function loadSecrets() {
  var editor = document.getElementById('secrets-editor');
  if (!editor) return;
  if (!adminToken) { editor.value = '(Enter admin password above to load)'; return; }
  var r = await api('/admin/secrets/raw');
  if (r.ok) {
    editor.value = typeof r.data === 'string' ? r.data : '';
  } else {
    editor.value = '# Could not load secrets: ' + (r.data?.error || 'unknown error');
  }
}

async function saveSecrets() {
  var editor = document.getElementById('secrets-editor');
  var status = document.getElementById('secrets-status');
  if (!editor || !adminToken) { showToast('Enter admin password first.', 'error'); return; }
  var r = await api('/admin/secrets/raw', { method: 'POST', body: JSON.stringify({ content: editor.value }) });
  if (r.ok) {
    showToast('Secrets saved.', 'success');
    if (status) status.textContent = 'Saved. Apply the stack to propagate changes to services.';
  } else {
    showToast('Save failed: ' + friendlyError(r.data?.error), 'error');
    if (status) status.textContent = '';
  }
}

async function loadHealth() {
  var el = document.getElementById('health-status');
  if (!el) return;
  var r = await api('/admin/setup/health-check');
  if (!r.ok) { el.textContent = 'Could not load health status.'; return; }
  var h = '';
  for (var name in r.data.services) {
    if (!r.data.services.hasOwnProperty(name)) continue;
    var info = r.data.services[name];
    var friendly = friendlyServiceName(name);
    h += '<div style="display:inline-flex;align-items:center;gap:.4rem;margin:.3rem .8rem .3rem 0">';
    h += '<span class="dot ' + (info.ok ? 'dot-ok' : 'dot-err') + '"></span>';
    h += '<span class="sr-only">' + (info.ok ? 'Healthy' : 'Error') + '</span>';
    h += '<strong style="font-size:14px">' + esc(friendly) + '</strong>';
    h += '</div>';
  }
  el.innerHTML = h;
}

/* ── Settings (Authentication) ────────────────────────── */
async function saveAdminToken() {
  var token = document.getElementById('set-admin').value;
  try {
    var res = await fetch(BASE + normalizeAdminApiPath('/admin/installed'), { headers: { 'content-type': 'application/json', 'x-admin-token': token } });
    if (res.status === 401) { showToast('Invalid admin password.', 'error'); return; }
  } catch(e) {}
  adminToken = token;
  localStorage.setItem('op_admin', adminToken);
  showToast('Password saved.', 'success');
  loadDashboard();
}

/* ── setup wizard ─────────────────────────────────────── */
async function checkSetup() {
  await window.openPalmSetup?.checkSetup();
}

function runSetup() {
  window.openPalmSetup?.runSetup();
}

/* ── init ─────────────────────────────────────────────── */
loadMeta().then(function() {
  showPage('dashboard');
  window.openPalmSetup?.init({ api: api, esc: esc, showPage: showPage, getAdminToken: function() { return adminToken; }, setAdminToken: function(v) { adminToken = v; localStorage.setItem('op_admin', v); } });
  checkSetup();
});

function trapFocus(overlayEl) {
  overlayEl._focusTrap = function(e) {
    if (e.key !== 'Tab') return;
    var focusable = overlayEl.querySelectorAll('button, input, select, textarea, a[href], [tabindex]:not([tabindex="-1"])');
    if (!focusable.length) return;
    var first = focusable[0], last = focusable[focusable.length - 1];
    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
  };
  overlayEl.addEventListener('keydown', overlayEl._focusTrap);
}
function releaseFocus(overlayEl) {
  if (overlayEl._focusTrap) overlayEl.removeEventListener('keydown', overlayEl._focusTrap);
}
</script>
</body>
</html>
