# Development-only compose overlay.
# Runtime orchestration is generated into packages/lib/src/embedded/state/docker-compose.yml (and state-root runtime artifact paths at install/runtime).
services:
  assistant:
    build: ./core/assistant
    # Extensions are baked into the image from opencode/extensions/.
    # For local dev, layer this over packages/lib/src/embedded/state/docker-compose.yml.
    environment:
      # OpenMemory HTTP API plugin configuration
      OPENPALM_MEMORY_MODE: "api"
      OPENMEMORY_BASE_URL: "http://openmemory:8765"
      # OPENMEMORY_API_KEY: ""        # set in .env or secrets if auth is enabled
      RECALL_LIMIT: "5"
      RECALL_MAX_CHARS: "2000"
      WRITEBACK_ENABLED: "true"
      TEMPORAL_ENABLED: "false"

  caddy:
    # Remap to non-standard ports in dev to avoid conflicting with any host
    # process (e.g. installed OpenPalm stack) already bound to 80/443.
    ports: !override
      - "127.0.0.1:8080:80"
      - "127.0.0.1:8443:443"

  gateway:
    build:
      context: .
      dockerfile: core/gateway/Dockerfile

  admin:
    build:
      context: .
      dockerfile: core/admin/Dockerfile
    volumes:
      - ./packages/lib/src/embedded/state/docker-compose.yml:/state/docker-compose.yml:ro
    environment:
      OPENPALM_ASSISTANT_URL: "http://assistant:4096"

  channel-chat:
    build:
      context: .
      dockerfile: channels/chat/Dockerfile
