# Managing OpenPalm — TLDR

This document covers day-to-day administration: configuration, channels, secrets,
access control, and extensions. For architecture rationale see
[core-principles.md](./core-principles.md).

---

## One Rule to Remember

**`~/.config/openpalm/` is the only directory you ever edit.**

The admin reads your files from there, assembles them into a runtime in
`~/.local/state/openpalm/`, and hands everything to Docker and Caddy. You never
edit STATE_HOME or DATA_HOME directly.

---

## Directory Map

```
~/.config/openpalm/          ← YOU EDIT THIS
│   secrets.env              # User-managed secrets: admin token, LLM provider keys
│
├── channels/
│   ├── chat.yml             # Compose overlay (required per channel)
│   ├── chat.caddy           # Caddy HTTP route (optional)
│   ├── telegram.yml
│   └── telegram.caddy
│
├── automations/             # Scheduled automations (drop files here)
│   └── backup
│
└── opencode/
    ├── opencode.json        # OpenCode config (LLM provider, settings)
    ├── tools/               # Drop custom tools here
    ├── plugins/             # Drop custom plugins here
    └── skills/              # Drop custom skills here

~/.local/state/openpalm/     ← SYSTEM WRITES THIS (don't edit unless you know what you're doing)
~/.local/share/openpalm/     ← CONTAINER DATA (don't touch, ever)
```

---

## Secrets (`secrets.env`)

User-managed secrets live in this file. The admin seeds it on first install;
edit it directly to update admin auth and LLM provider keys.

```env
# ~/.config/openpalm/secrets.env
# ONLY these keys belong here — nothing else.

ADMIN_TOKEN=<token>

# LLM provider keys (assistant uses these — at least one required)
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GROQ_API_KEY=gsk_...
MISTRAL_API_KEY=...
GOOGLE_API_KEY=...
```

By convention, only `ADMIN_TOKEN` and LLM provider keys belong here.
System-managed values (`POSTGRES_PASSWORD`, `CHANNEL_*_SECRET`, `OPENPALM_*`
infrastructure vars) are generated by the admin and written into
`~/.local/state/openpalm/artifacts/stack.env` — you don't need to set them.
You may add extra variables if needed; `secrets.env` is copied as-is into the
staged artifacts.

**After editing** — changes are not active until you apply:

```bash
# Restart admin to trigger automatic apply, OR
# call the apply endpoint directly:
curl -X POST http://localhost:8100/admin/install \
  -H "x-admin-token: $ADMIN_TOKEN"
```

LLM provider keys and related connection settings can also be managed via the
Connections API or the Connections settings page in the admin UI — no manual
file editing required. The API patches `secrets.env` in-place, preserving all
other keys.

```bash
# View current connection settings (keys are masked in the response)
curl http://localhost:8100/admin/connections \
  -H "x-admin-token: $ADMIN_TOKEN"

# Update one or more keys
curl -X POST http://localhost:8100/admin/connections \
  -H "x-admin-token: $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"OPENAI_API_KEY": "sk-..."}'

# Check if at least one provider key is configured
curl http://localhost:8100/admin/connections/status \
  -H "x-admin-token: $ADMIN_TOKEN"
```

---

## Channels

A channel is a `.yml` compose overlay (required) plus an optional `.caddy` route.

### Install a channel from the registry

Available channels can be installed via the admin API:

```bash
curl -X POST http://localhost:8100/admin/channels/install \
  -H "x-admin-token: $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"channel": "chat"}'
```

This copies the channel files from the registry to `~/.config/openpalm/channels/`,
generates an HMAC secret, stages artifacts, and starts the channel.

### Add a channel manually

1. Drop `<name>.yml` into `~/.config/openpalm/channels/`
2. Optionally drop `<name>.caddy` for HTTP access through Caddy
3. Apply (restart admin or POST to `/admin/install`)

### Uninstall a channel

```bash
curl -X POST http://localhost:8100/admin/channels/uninstall \
  -H "x-admin-token: $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"channel": "chat"}'
```

Or manually: remove (or rename) its `.yml` from `channels/` and apply.

### HTTP routing per channel

| File present? | Result |
|---|---|
| No `.caddy` file | Channel is Docker-network only — no HTTP route |
| `.caddy` with `import lan_only` | LAN-restricted HTTP route |
| `.caddy` with `import public_access` | Publicly accessible HTTP route |
| `.caddy` with no import statement | Admin auto-adds `import lan_only` (LAN by default) |

---

## Automations

You can schedule recurring tasks — like backups, cleanup scripts, or health checks —
by dropping a file into `~/.config/openpalm/automations/`.

### How to add an automation

1. Create a file in `~/.config/openpalm/automations/` (no file extension needed)
2. Write one or more schedule lines
3. Restart admin to activate: `docker compose restart admin`

**Example** — pull the latest container images every Sunday at 3 AM:

```
# ~/.config/openpalm/automations/update-containers
SHELL=/bin/bash
0 3 * * 0 node bash -c '. /etc/openpalm-env && curl -sf -X POST http://localhost:8100/admin/containers/pull -H "x-admin-token: $ADMIN_TOKEN" -H "x-requested-by: automation" -o /dev/null'
```

OpenPalm ships several ready-to-use examples in `assets/automations/` — copy any
of them into `~/.config/openpalm/automations/` to activate:

| File | What it does |
|---|---|
| `update-containers` | Weekly pull latest images and recreate containers |
| `health-check` | Check admin health every 5 minutes, log failures |
| `prompt-assistant` | Send a daily prompt to the assistant via the chat channel |
| `cleanup-logs` | Weekly trim audit logs to prevent unbounded disk growth |

### Schedule format

Each schedule line has five time fields followed by the user (`node`) and the command:

```
┌───────── minute (0–59)
│ ┌─────── hour (0–23)
│ │ ┌───── day of month (1–31)
│ │ │ ┌─── month (1–12)
│ │ │ │ ┌─ day of week (0–7, 0 and 7 are Sunday)
│ │ │ │ │
* * * * * node /path/to/command
```

Common examples:

| Schedule | Meaning |
|---|---|
| `0 * * * *` | Every hour |
| `0 2 * * *` | Daily at 2 AM |
| `0 0 * * 0` | Weekly on Sunday at midnight |
| `*/5 * * * *` | Every 5 minutes |

### Using the admin API from automations

Automations can call the admin API (e.g., to pull images, restart services, or check
status). The container environment is available via `. /etc/openpalm-env` at the
start of your command, which gives you `$ADMIN_TOKEN` and path variables.

```
0 2 * * * node bash -c '. /etc/openpalm-env && curl -sf -X POST http://localhost:8100/admin/containers/restart -H "x-admin-token: $ADMIN_TOKEN" -H "Content-Type: application/json" -d "{\"service\":\"assistant\"}" -o /dev/null'
```

### Rules

- **Filenames** must be lowercase letters, numbers, and hyphens only — no file extension (e.g., `backup`, `weekly-cleanup`)
- **User field** must be `node` — automations using any other user are silently skipped
- Automations run on the **admin container**, which has access to Docker (via socket proxy), your config, and data directories
- Lines starting with `#` are comments; you can also set environment variables like `SHELL=/bin/bash`

### When do changes take effect?

Automation files are picked up during **apply** (admin startup). After adding or
editing a file, restart admin to activate:

```bash
docker compose restart admin
```

### Overriding system automations

OpenPalm may ship system-managed automations in `~/.local/share/openpalm/automations/`.
If you create a user file with the **same name**, your version takes priority.
You don't need to edit system files directly.

---

## Access Scope

Controls which IPs the admin UI and LAN channels accept.

| Scope | Accepts |
|---|---|
| `lan` (default) | Private network ranges + localhost |
| `host` | Localhost only |

The source of truth is the system-managed core Caddyfile at:

`~/.local/share/openpalm/caddy/Caddyfile`

`POST /admin/access-scope` updates that file and restages
`~/.local/state/openpalm/artifacts/Caddyfile`.

---

## OpenCode / Assistant Extensions

The assistant runs OpenCode. Core extensions are baked into the container
(`/opt/opencode`). User extensions overlay on top — no rebuild needed.

**To add a tool/plugin/skill:**

```bash
# Drop files into the matching subdirectory:
~/.config/openpalm/opencode/tools/my-tool.ts
~/.config/openpalm/opencode/plugins/my-plugin.ts
~/.config/openpalm/opencode/skills/my-skill/SKILL.md
```

OpenCode picks them up on next restart of the assistant container.

**To configure OpenCode (LLM provider, models, etc.):**

Edit `~/.config/openpalm/opencode/opencode.json`. This file is never
overwritten by the admin after initial seeding.

---

## Apply / Sync

The admin assembles your config into runtime state via an **apply** action.
Apply runs automatically on admin startup. You can also trigger it manually.

**When apply runs:**
1. Assembles `STATE_HOME/artifacts/secrets.env` from user secrets + system-managed secrets
2. Copies core compose → `STATE_HOME/artifacts/docker-compose.yml`
3. Copies core Caddyfile (`DATA_HOME/caddy/Caddyfile`) → `STATE_HOME/artifacts/Caddyfile`
4. Stages channel `.yml` files → `STATE_HOME/artifacts/channels/`
5. Stages channel `.caddy` snippets → `STATE_HOME/artifacts/channels/lan/` or `channels/public/`
6. Runs `docker compose up`

**To trigger apply without a full reinstall:**

```bash
# Restart the admin container:
docker compose restart admin

# Or POST to install (idempotent — safe to re-run):
curl -X POST http://localhost:8100/admin/install \
  -H "x-admin-token: $ADMIN_TOKEN"
```

---

## Backup & Restore

```bash
# Backup: archive config + data (state is regenerated, optional)
tar czf openpalm-backup.tar.gz \
  ~/.config/openpalm \
  ~/.local/share/openpalm

# Restore: extract then restart
tar xzf openpalm-backup.tar.gz -C /
docker compose restart admin   # triggers apply
```

---

## Admin UI & Ports

| URL | Service |
|---|---|
| `http://localhost:8100/admin` | Admin UI (direct) |
| `http://localhost:8080/admin` | Admin UI via Caddy |
| `http://localhost:8080/admin/opencode` | OpenCode assistant UI |
| `http://localhost:8080/admin/openmemory` | OpenMemory dashboard |
| `http://localhost:8765` | OpenMemory API |

All ports are `127.0.0.1`-bound by default. Caddy at `:8080` is the main ingress.

---

## Common Tasks

**Change an LLM API key:**
1. Edit `~/.config/openpalm/secrets.env`
2. Restart admin: `docker compose restart admin`

**Add a new LLM provider:**
1. Add the API key to `secrets.env`
2. Edit `~/.config/openpalm/opencode/opencode.json` to configure the provider
3. Restart assistant: `docker compose restart assistant`

**Rotate the admin token:**
1. Update `ADMIN_TOKEN` in `secrets.env`
2. Restart all services: `docker compose restart`

**Add an automation:**
1. Create `~/.config/openpalm/automations/my-job` with your schedule
2. Restart admin: `docker compose restart admin`

**View audit logs:**
```bash
tail -f ~/.local/state/openpalm/audit/admin-audit.jsonl
tail -f ~/.local/state/openpalm/audit/guardian-audit.log
```

**Check container status:**
```bash
docker compose ps
# Or via API:
curl http://localhost:8100/admin/containers/list \
  -H "x-admin-token: $ADMIN_TOKEN"
```

**Pull latest images and recreate containers:**
```bash
curl -X POST http://localhost:8100/admin/containers/pull \
  -H "x-admin-token: $ADMIN_TOKEN"
```

This runs `docker compose pull` followed by `docker compose up` to recreate
containers with the updated images. Equivalent to a manual
`docker compose pull && docker compose up -d`.

**Docker socket GID** is auto-detected from `/var/run/docker.sock` by the admin at startup
and written to `STATE_HOME/artifacts/stack.env`. You do not need to set it manually.
If the admin fails to reach Docker, check that the socket exists and is readable.
