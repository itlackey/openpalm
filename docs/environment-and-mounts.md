# Environment Variables & Container Mount Points

This document describes every environment variable and volume mount used by the
OpenPalm stack. The `assets/docker-compose.yml` is the source of truth —
this document mirrors its content for reference.

**Canonical sources:** Volume mounts and directory layout are also described in
[directory-structure.md](./directory-structure.md). LLM provider keys are also
listed in [api-spec.md](./api-spec.md) (connections API) and
[opencode-configuration.md](./opencode-configuration.md). Security invariants
are defined in [core-principles.md](./core-principles.md). When in doubt, the
compose file and `core-principles.md` are authoritative.

---

## 1. Host-Level Path Variables

These variables control where OpenPalm stores data on the **host** filesystem.
They follow the [XDG Base Directory Specification](https://specifications.freedesktop.org/basedir-spec/latest/).

| Variable | Default | Purpose |
|---|---|---|
| `OPENPALM_CONFIG_HOME` | `~/.config/openpalm` | User-editable: secrets.env, channels/, opencode extensions |
| `OPENPALM_DATA_HOME` | `~/.local/share/openpalm` | Opaque service data (postgres, qdrant, assistant home, etc.) |
| `OPENPALM_STATE_HOME` | `~/.local/state/openpalm` | Assembled runtime, audit logs |
| `OPENPALM_WORK_DIR` | `$HOME/openpalm` | Assistant working directory mounted at /work |

CONFIG_HOME is the single user touchpoint. See
[directory-structure.md](./directory-structure.md) for the full tree.

---

## 2. Container Mount Points

All mounts are **bind mounts** from the host filesystem. There are no named
Docker volumes or tmpfs mounts in the stack.

### 2.1 Caddy (Reverse Proxy)

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$STATE_HOME/artifacts/Caddyfile` | `/etc/caddy/Caddyfile` | **ro** | Staged Caddy config |
| `$STATE_HOME/artifacts/channels` | `/etc/caddy/channels` | **ro** | Staged channel `.caddy` route files |
| `$DATA_HOME/caddy/data` | `/data/caddy` | rw | Caddy TLS certificates and state |
| `$DATA_HOME/caddy/config` | `/config/caddy` | rw | Caddy runtime config |

The Caddyfile includes `import channels/public/*.caddy` and
`import channels/lan/*.caddy` to auto-discover staged channel routes from
STATE_HOME.

The source-of-truth core Caddyfile is system-managed at
`$DATA_HOME/caddy/Caddyfile` and staged to `$STATE_HOME/artifacts/Caddyfile` during apply.

### 2.2 PostgreSQL

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$DATA_HOME/postgres` | `/var/lib/postgresql/data` | rw | Database files |

### 2.3 Qdrant

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$DATA_HOME/qdrant` | `/qdrant/storage` | rw | Vector-store data |

### 2.4 OpenMemory MCP

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$DATA_HOME/openmemory` | `/data` | rw | Memory service persistent data |

### 2.5 Assistant (OpenCode Runtime)

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$DATA_HOME/assistant` | `/home/opencode` | rw | OpenCode user home (dotfiles, caches) |
| `$CONFIG_HOME/opencode` | `/home/opencode/.config/opencode` | rw | OpenCode user extensions overlay |
| `$OPENPALM_WORK_DIR` | `/work` | rw | Working directory for user projects |

The OpenCode overlay mount lets users add tools, plugins, or skills to
`CONFIG_HOME/opencode/` without rebuilding the image. OpenCode merges config
from `/opt/opencode/` (built-in) and `~/.config/opencode/` (user).

The assistant runs as `$OPENPALM_UID:$OPENPALM_GID` (default `1000:1000`)
with `working_dir: /work`. It has **no Docker socket access**.

### 2.6 Guardian

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$DATA_HOME/guardian` | `/app/data` | rw | Guardian runtime data |
| `$STATE_HOME/audit` | `/app/audit` | rw | Guardian audit log (guardian-audit.log) |
| `$STATE_HOME/artifacts/stack.env` | `/app/secrets/stack.env` | ro | Channel HMAC secrets (file-based discovery) |

The guardian runs as `$OPENPALM_UID:$OPENPALM_GID` (default `1000:1000`).
Channel HMAC secrets are injected via the staged `STATE_HOME/artifacts/stack.env`
(loaded by the guardian's `env_file:` directive and bind-mounted for runtime
re-reads via `GUARDIAN_SECRETS_PATH`). Secrets are system-generated by the
admin and never appear in user-editable files.

### 2.7 Docker Socket Proxy

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$OPENPALM_DOCKER_SOCK` | `/var/run/docker.sock` | **ro** | Docker daemon socket (proxy only) |

The `docker-socket-proxy` (Tecnativa) is the **only** container that mounts
the Docker socket. It exposes a filtered HTTP API on port 2375 within the
internal network. The admin connects via `DOCKER_HOST=tcp://docker-socket-proxy:2375`.

This eliminates Docker socket permission/GID issues across runtimes (Docker
Desktop, OrbStack, Colima, Podman). The admin never mounts the socket directly
and runs as a non-root user.

**`OPENPALM_DOCKER_SOCK`** is auto-detected by the setup scripts via
`docker context inspect` and written to `STATE_HOME/artifacts/stack.env`.
This supports Docker runtimes whose socket is not at the default
`/var/run/docker.sock` (e.g. OrbStack, Colima, Rancher Desktop).
If not set, it defaults to `/var/run/docker.sock`.

### 2.8 Admin

| Host Path | Container Path | Mode | Purpose |
|---|---|---|---|
| `$CONFIG_HOME` | `$CONFIG_HOME` (same path) | rw | Channel source files, secrets, extensions |
| `$DATA_HOME` | `$DATA_HOME` (same path) | rw | Pre-create DATA_HOME subdirs, ensure ownership |
| `$STATE_HOME` | `$STATE_HOME` (same path) | rw | Assembled runtime, audit logs |

The admin is the sole orchestrator. It connects to Docker via the socket proxy
(HTTP over the internal network) and mounts CONFIG_HOME, DATA_HOME, and
STATE_HOME. The DATA_HOME mount allows the admin to pre-create subdirectories
with correct ownership before other services start.

---

## 3. Secrets

Runtime configuration is split into two staged files in `STATE_HOME/artifacts/`:

- **`stack.env`** — ALL system-managed config. Source of truth is `DATA_HOME/stack.env` (seeded by setup.sh). Contains:
  - Infrastructure: paths, UID/GID, Docker socket, image namespace/tag, networking, OpenMemory URLs
  - Database: `POSTGRES_PASSWORD` (generated by setup.sh, persisted in `DATA_HOME/stack.env`)
  - Channel HMAC keys: `CHANNEL_<NAME>_SECRET` (generated per channel, persisted in `DATA_HOME/stack.env`)
- **`secrets.env`** — a staged copy of `CONFIG_HOME/secrets.env`. By convention contains `ADMIN_TOKEN` and LLM provider keys; copied as-is.

Docker compose is invoked with both: `--env-file stack.env --env-file secrets.env`.

Database credentials and channel HMAC secrets are persisted in `DATA_HOME/stack.env` and staged to `STATE_HOME/artifacts/stack.env` on every apply. Users typically only need to edit `CONFIG_HOME/secrets.env` for tokens and LLM keys.

Configuration changes are activated only through an explicit **apply** action:
the admin stages user config + system assets into STATE_HOME, then runs
compose operations and service reload/restarts from STATE_HOME. The admin also
runs apply automatically on application startup, so restarting the admin
container syncs latest configuration into runtime state when the app starts.

**User-managed** (`CONFIG_HOME/secrets.env` → staged to `STATE_HOME/artifacts/secrets.env`):

| Secret | Consumed By | Purpose |
|---|---|---|
| `ADMIN_TOKEN` | admin, guardian, assistant | Admin API authentication |
| `OPENAI_API_KEY` | assistant, openmemory | OpenAI API key (optional) |
| `ANTHROPIC_API_KEY` | assistant | Anthropic API key (optional) |
| `GROQ_API_KEY` | assistant | Groq API key (optional) |
| `MISTRAL_API_KEY` | assistant | Mistral API key (optional) |
| `GOOGLE_API_KEY` | assistant | Google API key (optional) |

**System-managed** (persisted in `DATA_HOME/stack.env`, staged to `STATE_HOME/artifacts/stack.env`):

| Secret | Consumed By | Purpose |
|---|---|---|
| `POSTGRES_PASSWORD` | postgres | Database password — generated by setup.sh, persisted in `DATA_HOME/stack.env` |
| `CHANNEL_<NAME>_SECRET` | guardian, channel-\<name\> | HMAC signing key — generated per channel, never user-edited |

Channel HMAC secrets are generated when a channel is installed and reused on subsequent restarts.
They are written into `DATA_HOME/stack.env` and staged to `STATE_HOME/artifacts/stack.env` on each apply.

---

## 4. Environment Variables by Service

### 4.1 Admin Service

| Variable | Value | Purpose |
|---|---|---|
| `PORT` | `8100` | HTTP server listen port |
| `ADMIN_TOKEN` | from secrets.env | Bearer token for Admin API |
| `GUARDIAN_URL` | `http://guardian:8080` | Internal URL to guardian |
| `OPENPALM_ASSISTANT_URL` | `http://assistant:4096` | Internal URL to assistant |
| `OPENPALM_CONFIG_HOME` | Same as host path | In-container path to CONFIG_HOME (same-path mount) |
| `OPENPALM_DATA_HOME` | Same as host path | In-container path to DATA_HOME (same-path mount) |
| `OPENPALM_STATE_HOME` | Same as host path | In-container path to STATE_HOME (same-path mount) |

### 4.2 Guardian Service

| Variable | Value | Purpose |
|---|---|---|
| `PORT` | `8080` | HTTP server listen port |
| `OPENPALM_ASSISTANT_URL` | `http://assistant:4096` | Internal URL for message forwarding |
| `GUARDIAN_AUDIT_PATH` | `/app/audit/guardian-audit.log` | Audit log path; compose sets this to write into STATE_HOME/audit |
| `OPENCODE_TIMEOUT_MS` | `120000` | Timeout (ms) for assistant message response (LLM inference can be slow; code default 120s) |
| `ADMIN_TOKEN` | from secrets.env | Admin API token |
| `GUARDIAN_SECRETS_PATH` | `/app/secrets/stack.env` | Path to bind-mounted stack.env for runtime secret re-reads |
| `CHANNEL_*_SECRET` | system-generated (injected into staged stack.env) | HMAC keys for channel signature verification |

### 4.3 Assistant Service (OpenCode Runtime)

| Variable | Value | Purpose |
|---|---|---|
| `OPENCODE_CONFIG_DIR` | `/opt/opencode` | Built-in config, tools, plugins, skills |
| `OPENCODE_PORT` | `4096` | Web-server listen port |
| `OPENCODE_AUTH` | `false` | Auth handled externally — disabled in OpenCode |
| `OPENCODE_ENABLE_SSH` | `0` (default) | SSH server toggle |
| `HOME` | `/home/opencode` | User home directory |
| `OPENPALM_ADMIN_API_URL` | `http://admin:8100` | Admin API URL for admin tools |
| `OPENPALM_ADMIN_TOKEN` | from secrets.env | Bearer token for Admin API |
| `OPENMEMORY_API_URL` | `http://openmemory:8765` | OpenMemory service URL |
| `OPENMEMORY_USER_ID` | `default_user` | User identifier for memory |
| `OPENAI_API_KEY` | pass-through | OpenAI provider key |
| `ANTHROPIC_API_KEY` | pass-through | Anthropic provider key |
| `GROQ_API_KEY` | pass-through | Groq provider key |
| `MISTRAL_API_KEY` | pass-through | Mistral provider key |
| `GOOGLE_API_KEY` | pass-through | Google AI provider key |

### 4.4 PostgreSQL

| Variable | Default | Purpose |
|---|---|---|
| `POSTGRES_DB` | `openpalm` | Database name |
| `POSTGRES_USER` | `openpalm` | Database user |
| `POSTGRES_PASSWORD` | system-managed | Database password (auto-generated by admin) |

### 4.5 Qdrant

No application-specific variables beyond image defaults.

### 4.6 OpenMemory MCP

| Variable | Default | Purpose |
|---|---|---|
| `OPENAI_API_KEY` | pass-through | Required for embedding generation |
| `QDRANT_URL` | `http://qdrant:6333` | Qdrant vector-store connection |

### 4.7 OpenMemory UI

| Variable | Default | Purpose |
|---|---|---|
| `NEXT_PUBLIC_API_URL` | `http://localhost:8765` | OpenMemory API URL for dashboard |
| `NEXT_PUBLIC_USER_ID` | `default_user` | User ID shown in dashboard |

---

## 5. Stack-Level Configuration Variables

These variables are consumed by `docker compose` via `STATE_HOME/artifacts/stack.env`.
They are **system-managed** — the admin auto-detects and writes them on every apply.
You never set these in `CONFIG_HOME/secrets.env`.

| Variable | Default | Source |
|---|---|---|
| `OPENPALM_CONFIG_HOME` | `~/.config/openpalm` | admin process env |
| `OPENPALM_DATA_HOME` | `~/.local/share/openpalm` | admin process env |
| `OPENPALM_STATE_HOME` | `~/.local/state/openpalm` | admin process env |
| `OPENPALM_WORK_DIR` | `$HOME/openpalm` | admin process env |
| `OPENPALM_UID` | current user UID | `process.getuid()` |
| `OPENPALM_GID` | current group GID | `process.getgid()` |
| `OPENPALM_IMAGE_NAMESPACE` | `openpalm` | admin process env (overridable) |
| `OPENPALM_IMAGE_TAG` | `latest` | admin process env (overridable) |
| `OPENPALM_INGRESS_BIND_ADDRESS` | `127.0.0.1` | admin process env (overridable) |
| `OPENPALM_INGRESS_PORT` | `8080` | admin process env (overridable) |
| `OPENPALM_ASSISTANT_BIND_ADDRESS` | `127.0.0.1` | compose default |
| `OPENPALM_ASSISTANT_SSH_BIND_ADDRESS` | `127.0.0.1` | compose default |
| `OPENPALM_ASSISTANT_SSH_PORT` | `2222` | compose default |
| `OPENPALM_OPENMEMORY_BIND_ADDRESS` | `127.0.0.1` | compose default |
| `OPENPALM_OPENMEMORY_DASHBOARD_BIND_ADDRESS` | `127.0.0.1` | compose default |
| `OPENMEMORY_DASHBOARD_API_URL` | `http://localhost:8765` | admin process env (overridable) |
| `OPENMEMORY_USER_ID` | `default_user` | admin process env (overridable) |

Overridable values can be customized by setting the variable in the admin container's
environment before startup (e.g. via docker-compose.yml `environment:` override).

---

## 6. LLM Provider Keys (Pass-Through)

Read from the host environment and passed into containers that need them.
Never generated or defaulted by OpenPalm.

| Variable | Consumed By | Purpose |
|---|---|---|
| `OPENAI_API_KEY` | assistant, openmemory | OpenAI API (also used for embeddings) |
| `ANTHROPIC_API_KEY` | assistant | Anthropic LLM provider |
| `GROQ_API_KEY` | assistant | Groq LLM provider |
| `MISTRAL_API_KEY` | assistant | Mistral LLM provider |
| `GOOGLE_API_KEY` | assistant | Google AI provider |

---

## 7. Docker Networks

| Network | Services | Purpose |
|---|---|---|
| `assistant_net` | caddy, postgres, qdrant, openmemory, openmemory-ui, assistant, guardian, admin | Internal service mesh |
| `channel_lan` | caddy, guardian, channel services | LAN-restricted channel access |
| `channel_public` | caddy, guardian, channel services | Publicly accessible channels |

---

## 8. Port Mappings

| Service | Container Port | Host Binding | Default Host Port |
|---|---|---|---|
| Caddy | 80 | `$OPENPALM_INGRESS_BIND_ADDRESS` | 8080 |
| Admin | 8100 | `127.0.0.1` (fixed) | 8100 |
| Assistant | 4096 | `$OPENPALM_ASSISTANT_BIND_ADDRESS` | 4096 |
| Assistant SSH | 22 | `$OPENPALM_ASSISTANT_SSH_BIND_ADDRESS` | 2222 |
| OpenMemory API | 8765 | `$OPENPALM_OPENMEMORY_BIND_ADDRESS` | 8765 |
| OpenMemory UI | 3000 | `$OPENPALM_OPENMEMORY_DASHBOARD_BIND_ADDRESS` | 3001 |

---

## 9. Security Notes

- **Docker socket** — Only the `docker-socket-proxy` container mounts the
  Docker socket (read-only). The admin connects via HTTP through the proxy,
  which allowlists only the Docker API categories needed for compose operations.
  The assistant is explicitly denied Docker access.
- **Caddy config** — Caddyfile and channel routes mounted read-only (`:ro`).
- **ADMIN_TOKEN** — Required at startup (`${ADMIN_TOKEN:?...}`). The compose
  file will fail if unset in `secrets.env`.
- **POSTGRES_PASSWORD** — Required by compose, but generated and staged by the admin.
- **Bind addresses** — All service ports default to `127.0.0.1` (localhost only).
- **UID/GID mapping** — The assistant, guardian, and admin run with the host
  user's UID/GID for correct file ownership on bind-mounted volumes.
- **Secrets isolation** — Most containers receive only the secrets they
  explicitly declare in their `environment:` block. The guardian loads the
  staged `stack.env` via `env_file` and reads all `CHANNEL_*_SECRET`
  variables at startup (and re-reads them at runtime from the bind-mounted
  file via `GUARDIAN_SECRETS_PATH`). Channel HMAC secrets are system-generated
  by the admin and stored in `DATA_HOME/stack.env`; they
  are never present in user-editable files.
