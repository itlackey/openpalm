services:
  # ============================================================
  # Reverse Proxy — Caddy (front door)
  # Routes public channels and LAN-only dashboards
  # ============================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports: ["80:80", "443:443"]
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ${DATA_DIR:-./data}/caddy_data:/data
      - ${DATA_DIR:-./data}/caddy_config:/config
    networks: [assistant_net]
    depends_on: [gateway, admin-app]

  # ============================================================
  # Storage Layer
  # ============================================================
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-openpalm}
      POSTGRES_USER: ${POSTGRES_USER:-openpalm}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change-me-pg-password}
    volumes:
      - ${DATA_DIR:-./data}/postgres:/var/lib/postgresql/data
    networks: [assistant_net]

  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    volumes:
      - ${DATA_DIR:-./data}/qdrant:/qdrant/storage
    networks: [assistant_net]

  # ============================================================
  # Core Application Layer
  # ============================================================
  openmemory:
    image: skpassegna/openmemory-mcp:latest
    restart: unless-stopped
    ports: ["3000:3000", "8765:8765"]
    volumes:
      - ${DATA_DIR:-./data}/openmemory:/data
      - ${DATA_DIR:-./data}/shared:/shared
    networks: [assistant_net]
    depends_on: [qdrant]

  opencode-core:
    build: ./opencode
    restart: unless-stopped
    environment:
      - OPENCODE_CONFIG=/config/opencode.jsonc
    ports: ["4096:4096"]
    volumes:
      - ./opencode/opencode.jsonc:/config/opencode.jsonc:ro
      - ./opencode/AGENTS.md:/work/AGENTS.md:ro
      - ./opencode/skills:/work/skills:ro
      - ./opencode/.opencode:/work/.opencode:ro
      - ${DATA_DIR:-./data}/opencode:/state
      - ${DATA_DIR:-./data}/shared:/shared
    working_dir: /work
    command: ["opencode", "serve", "--hostname", "0.0.0.0", "--port", "4096"]
    networks: [assistant_net]
    depends_on: [openmemory]

  opencode-channel:
    build: ./opencode
    restart: unless-stopped
    environment:
      - OPENCODE_CONFIG=/config/opencode.channel.jsonc
    volumes:
      - ./opencode/opencode.channel.jsonc:/config/opencode.channel.jsonc:ro
      - ./opencode/AGENTS.md:/work/AGENTS.md:ro
      - ./opencode/skills:/work/skills:ro
      - ./opencode/.opencode:/work/.opencode:ro
      - ${DATA_DIR:-./data}/opencode-channel:/state
      - ${DATA_DIR:-./data}/shared:/shared
    working_dir: /work
    command: ["opencode", "serve", "--hostname", "0.0.0.0", "--port", "4097"]
    networks: [assistant_net]
    depends_on: [openmemory]

  gateway:
    build: ./gateway
    restart: unless-stopped
    environment:
      - PORT=8080
      - OPENCODE_CORE_BASE_URL=http://opencode-core:4096
      - OPENCODE_CHANNEL_BASE_URL=http://opencode-channel:4097
      - OPENCODE_TIMEOUT_MS=${OPENCODE_TIMEOUT_MS:-15000}
      - CHANNEL_CHAT_SECRET=${CHANNEL_CHAT_SECRET:-}
      - CHANNEL_DISCORD_SECRET=${CHANNEL_DISCORD_SECRET:-}
      - CHANNEL_VOICE_SECRET=${CHANNEL_VOICE_SECRET:-}
      - CHANNEL_TELEGRAM_SECRET=${CHANNEL_TELEGRAM_SECRET:-}
    volumes:
      - ${DATA_DIR:-./data}/gateway:/app/data
    networks: [assistant_net]
    depends_on: [opencode-core, opencode-channel]

  admin-app:
    build: ./admin-app
    restart: unless-stopped
    environment:
      - PORT=8100
      - ADMIN_TOKEN=${ADMIN_TOKEN:-change-me-admin-token}
      - ADMIN_STEP_UP_TOKEN=${ADMIN_STEP_UP_TOKEN:-change-me-step-up}
      - AUTO_APPROVE_EXTENSIONS=${AUTO_APPROVE_EXTENSIONS:-}
      - CHANGE_BUNDLE_DIR=/app/data/bundles
      - CHANGE_STATE_DIR=/app/data/change-states
      - EXT_REQUESTS_PATH=/app/data/extension-requests.json
      - OPENCODE_CONFIG_PATH=/app/config/opencode.jsonc
      - CONTROLLER_URL=http://controller:8090
      - CONTROLLER_TOKEN=${CONTROLLER_TOKEN:-change-me-controller}
      - GATEWAY_URL=http://gateway:8080
      - CADDYFILE_PATH=/app/config/Caddyfile
      - CHANNEL_ENV_DIR=/app/channel-env
    volumes:
      - ./opencode/opencode.jsonc:/app/config/opencode.jsonc
      - ./caddy/Caddyfile:/app/config/Caddyfile
      - ./config/channel-env:/app/channel-env
      - ./admin-ui:/app/admin-ui:ro
      - ${DATA_DIR:-./data}/admin-app:/app/data
      - ${DATA_DIR:-./data}/shared:/shared
    networks: [assistant_net]
    depends_on: [controller]

  controller:
    build: ./controller
    restart: unless-stopped
    environment:
      - PORT=8090
      - CONTROLLER_TOKEN=${CONTROLLER_TOKEN:-change-me-controller}
      - COMPOSE_PROJECT_PATH=/workspace
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/workspace
    networks: [assistant_net]

  # ============================================================
  # Channel Layer (optional — enable via --profile channels)
  # All channels route through the gateway for defense in depth
  # ============================================================
  channel-chat:
    build: ./channels/chat
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ./config/channel-env/channel-chat.env
    environment:
      - PORT=8181
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_CHAT_SECRET=${CHANNEL_CHAT_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

  channel-discord:
    build: ./channels/discord
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ./config/channel-env/channel-discord.env
    environment:
      - PORT=8184
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_DISCORD_SECRET=${CHANNEL_DISCORD_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

  channel-voice:
    build: ./channels/voice
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ./config/channel-env/channel-voice.env
    environment:
      - PORT=8183
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_VOICE_SECRET=${CHANNEL_VOICE_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

  channel-telegram:
    build: ./channels/telegram
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ./config/channel-env/channel-telegram.env
    environment:
      - PORT=8182
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_TELEGRAM_SECRET=${CHANNEL_TELEGRAM_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

networks:
  assistant_net:
