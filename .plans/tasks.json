[
  {
    "id": "R01",
    "title": "Add runtime artifacts to .gitignore",
    "description": "Add e2e/screenshots/ to packages/ui/.gitignore to prevent test screenshot artifacts from being accidentally committed.",
    "priority": "P1",
    "status": "completed",
    "estimatedEffort": "15 minutes",
    "planFile": ".plans/R01-gitignore-runtime-artifacts.md",
    "subtasks": [
      {
        "id": "R01.1",
        "description": "Append e2e/screenshots/ rule to packages/ui/.gitignore after the existing e2e/.e2e-state.json line",
        "status": "completed",
        "files": [
          {
            "path": "packages/ui/.gitignore",
            "lines": "26-27",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R01.2",
        "description": "Verify the ignore rule matches screenshots directory and files using git check-ignore",
        "status": "completed",
        "files": [
          {
            "path": "packages/ui/.gitignore",
            "lines": "27",
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R02",
    "title": "Fix contract test state mutation",
    "description": "Replace fragile in-memory save/restore of setup-state.json in setup-wizard-gate.contract.test.ts with file-based backup using mkdtempSync for crash-safe restoration.",
    "priority": "P1",
    "status": "completed",
    "estimatedEffort": "1 hour",
    "planFile": ".plans/R02-fix-contract-test-state-mutation.md",
    "subtasks": [
      {
        "id": "R02.1",
        "description": "Update imports to add copyFileSync, mkdtempSync, tmpdir, and join; remove readFileSync",
        "status": "completed",
        "files": [
          {
            "path": "test/contracts/setup-wizard-gate.contract.test.ts",
            "lines": "2-3",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R02.2",
        "description": "Remove module-level savedState variable and add backupState/restoreState helper functions using mkdtempSync",
        "status": "completed",
        "files": [
          {
            "path": "test/contracts/setup-wizard-gate.contract.test.ts",
            "lines": "14-16",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R02.3",
        "description": "Replace outer beforeAll/afterAll with backupState() and restoreState() calls",
        "status": "completed",
        "files": [
          {
            "path": "test/contracts/setup-wizard-gate.contract.test.ts",
            "lines": "18-32",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R02.4",
        "description": "Verify contract test passes with OPENPALM_INTEGRATION=1 and state file is properly restored",
        "status": "completed",
        "files": [
          {
            "path": "test/contracts/setup-wizard-gate.contract.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R03",
    "title": "Fix relative path in admin-api.contract.test.ts",
    "description": "Replace bare relative path with import.meta.dir-anchored path to fix CWD-dependent test failure.",
    "priority": "P1",
    "status": "pending",
    "estimatedEffort": "15 minutes",
    "planFile": ".plans/R03-fix-relative-paths.md",
    "subtasks": [
      {
        "id": "R03.1",
        "description": "Add join import from node:path",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/admin-api.contract.test.ts",
            "lines": "2",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R03.2",
        "description": "Replace bare relative path 'dev/docs/api-reference.md' with join(import.meta.dir, '../../dev/docs/api-reference.md')",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/admin-api.contract.test.ts",
            "lines": "8",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R03.3",
        "description": "Verify test passes from both repo root and subdirectory",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/admin-api.contract.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R04",
    "title": "Delete duplicate HMAC tests",
    "description": "Remove 9 duplicate HMAC tests: delete crypto.test.ts entirely and reduce channel-security.test.ts to a single re-export smoke test.",
    "priority": "P2",
    "status": "pending",
    "estimatedEffort": "30 minutes",
    "planFile": ".plans/R04-delete-duplicate-hmac-tests.md",
    "subtasks": [
      {
        "id": "R04.1",
        "description": "Delete packages/lib/src/shared/crypto.test.ts (strict subset of hmac.security.test.ts)",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/shared/crypto.test.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R04.2",
        "description": "Replace channel-security.test.ts contents with a single re-export smoke test",
        "status": "pending",
        "files": [
          {
            "path": "core/gateway/src/channel-security.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R04.3",
        "description": "Verify hmac.security.test.ts, channel-security.test.ts, and full test suite pass",
        "status": "pending",
        "files": [
          {
            "path": "test/security/hmac.security.test.ts",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "core/gateway/src/channel-security.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R05",
    "title": "Delete fake contract tests",
    "description": "Move doc-lint checks to a pre-commit hook/lint script, delete 3 fake contract tests, and write a real admin API contract test with live HTTP assertions.",
    "priority": "P2",
    "status": "pending",
    "estimatedEffort": "2-3 hours",
    "planFile": ".plans/R05-delete-fake-contract-tests.md",
    "subtasks": [
      {
        "id": "R05.1",
        "description": "Create dev/scripts/lint-docs.sh with documentation invariant checks extracted from the fake contract tests",
        "status": "pending",
        "files": [
          {
            "path": "dev/scripts/lint-docs.sh",
            "lines": null,
            "action": "create"
          }
        ]
      },
      {
        "id": "R05.2",
        "description": "Update dev/hooks/pre-commit to call lint-docs.sh when README or api-reference.md are staged",
        "status": "pending",
        "files": [
          {
            "path": "dev/hooks/pre-commit",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R05.3",
        "description": "Add lint:docs script to package.json",
        "status": "pending",
        "files": [
          {
            "path": "package.json",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R05.4",
        "description": "Delete fake contract test: test/contracts/admin-api.contract.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/admin-api.contract.test.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R05.5",
        "description": "Delete fake contract test: test/contracts/readme-no-npx.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/readme-no-npx.test.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R05.6",
        "description": "Delete fake contract test: test/contracts/channel-message.contract.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/channel-message.contract.test.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R05.7",
        "description": "Write real admin API contract test with HTTP assertions against live admin server, guarded by OPENPALM_INTEGRATION=1",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/admin-api.contract.test.ts",
            "lines": null,
            "action": "create"
          }
        ]
      },
      {
        "id": "R05.8",
        "description": "Optionally add bun run lint:docs to the unit-tests job in .github/workflows/release.yml",
        "status": "pending",
        "files": [
          {
            "path": ".github/workflows/release.yml",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R06",
    "title": "Eliminate silent test passes",
    "description": "Audit confirmed no silent guard anti-patterns exist. Optionally add a CI grep check to prevent future regressions.",
    "priority": "P2",
    "status": "pending",
    "estimatedEffort": "15 minutes",
    "planFile": ".plans/R06-eliminate-silent-test-passes.md",
    "subtasks": [
      {
        "id": "R06.1",
        "description": "Run verification grep command to confirm no silent if/return patterns exist in test files",
        "status": "pending",
        "files": [
          {
            "path": "dev/docs/release-quality-gates.md",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R06.2",
        "description": "Optionally add silent test guard check step to the unit-tests job in release.yml",
        "status": "pending",
        "files": [
          {
            "path": ".github/workflows/release.yml",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R07",
    "title": "Extract API tests from Playwright into bun:test",
    "description": "Migrate 9 Playwright E2E test files (56 tests) that make pure HTTP API calls into bun:test integration tests using native fetch(), removing unnecessary Chromium dependency.",
    "priority": "P3",
    "status": "pending",
    "estimatedEffort": "3-5 days",
    "planFile": ".plans/R07-extract-api-tests-from-playwright.md",
    "subtasks": [
      {
        "id": "R07.1",
        "description": "Create packages/ui/test/api/ directory and shared helpers.ts with server lifecycle, temp dir, and fetch wrappers",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/helpers.ts",
            "lines": null,
            "action": "create"
          }
        ]
      },
      {
        "id": "R07.2",
        "description": "Migrate 01-health-meta.pw.ts (3 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/01-health-meta.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/01-health-meta.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.3",
        "description": "Migrate 02-auth.pw.ts (8 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/02-auth-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/02-auth.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.4",
        "description": "Migrate 03-setup-api.pw.ts (20 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/03-setup-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/03-setup-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.5",
        "description": "Migrate 04-stack-api.pw.ts (4 tests) to bun:test with runMinimalSetup() helper",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/04-stack-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/04-stack-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.6",
        "description": "Migrate 05-secrets-api.pw.ts (5 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/05-secrets-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/05-secrets-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.7",
        "description": "Migrate 06-automations-api.pw.ts (6 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/06-automations-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/06-automations-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.8",
        "description": "Migrate 07-channels-api.pw.ts (3 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/07-channels-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/07-channels-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.9",
        "description": "Migrate 08-command-api.pw.ts (5 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/08-command-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/08-command-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.10",
        "description": "Migrate 11-container-automation-management-api.pw.ts (2 tests) to bun:test",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/test/api/11-container-automation-management-api.test.ts",
            "lines": null,
            "action": "create"
          },
          {
            "path": "packages/ui/e2e/11-container-automation-management-api.pw.ts",
            "lines": null,
            "action": "delete"
          }
        ]
      },
      {
        "id": "R07.11",
        "description": "Add test:api script to packages/ui/package.json and update test script to include it",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/package.json",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R07.12",
        "description": "Add bun-api job to .github/workflows/test-ui.yml that runs API tests without Chromium",
        "status": "pending",
        "files": [
          {
            "path": ".github/workflows/test-ui.yml",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R08",
    "title": "Break the sequential state machine in setup API test",
    "description": "Collapse 23 sequential test() calls in 03-setup-api.pw.ts into a single test() with test.step() sub-steps to eliminate cascading failures and honestly represent the linear workflow.",
    "priority": "P3",
    "status": "pending",
    "estimatedEffort": "1-2 hours",
    "planFile": ".plans/R08-break-sequential-state-machine.md",
    "subtasks": [
      {
        "id": "R08.1",
        "description": "Replace 23 test() calls with a single test() containing 23 test.step() calls organized by phase",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/03-setup-api.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R08.2",
        "description": "Remove the wrapping test.describe() block or simplify it",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/03-setup-api.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R08.3",
        "description": "Run full Playwright E2E suite and verify downstream files 04-11 are unaffected",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/03-setup-api.pw.ts",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "packages/ui/e2e/04-stack-api.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R09",
    "title": "Add resetServerState() utility",
    "description": "Create a resetServerState(tmpDir) function that resets an OpenPalm state directory to first-boot condition, replacing ad-hoc state reset patterns scattered across the test suite.",
    "priority": "P3",
    "status": "pending",
    "estimatedEffort": "1-2 hours",
    "planFile": ".plans/R09-add-reset-server-state-utility.md",
    "subtasks": [
      {
        "id": "R09.1",
        "description": "Export DEFAULT_STATE from setup-manager.ts (change const to export const)",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/setup-manager.ts",
            "lines": "37",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R09.2",
        "description": "Create test-utils.ts with resetServerState(), createTestDirLayout(), ServerDirLayout type, and related constants",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/test-utils.ts",
            "lines": null,
            "action": "create"
          }
        ]
      },
      {
        "id": "R09.3",
        "description": "Create test-utils.test.ts with tests for resetServerState (correct state file, artifact removal, service env cleanup, idempotency) and createTestDirLayout",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/test-utils.test.ts",
            "lines": null,
            "action": "create"
          }
        ]
      },
      {
        "id": "R09.4",
        "description": "Verify all tests pass: bun test packages/lib/src/admin/test-utils.test.ts and bun run typecheck",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/test-utils.test.ts",
            "lines": null,
            "action": "create"
          }
        ]
      }
    ]
  },
  {
    "id": "R10",
    "title": "Stop rebuilding every test run",
    "description": "Add SKIP_BUILD env var support to start-webserver.cjs so Playwright skips the Vite build when build/index.js already exists, and pre-build in CI.",
    "priority": "P3",
    "status": "pending",
    "estimatedEffort": "1 hour",
    "planFile": ".plans/R10-stop-rebuilding-every-test-run.md",
    "subtasks": [
      {
        "id": "R10.1",
        "description": "Modify start-webserver.cjs to check SKIP_BUILD=1 && existsSync('build/index.js') before running bun run build",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/start-webserver.cjs",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R10.2",
        "description": "Update .github/workflows/test-ui.yml to add explicit 'Build UI' step and pass SKIP_BUILD=1 to Playwright step",
        "status": "pending",
        "files": [
          {
            "path": ".github/workflows/test-ui.yml",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R10.3",
        "description": "Optionally add build caching with actions/cache keyed on source file hashes",
        "status": "pending",
        "files": [
          {
            "path": ".github/workflows/test-ui.yml",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R10.4",
        "description": "Verify locally: SKIP_BUILD=1 works with existing build, fallback rebuilds when build is missing, default behavior unchanged",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/start-webserver.cjs",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R11",
    "title": "Make integration tests run in CI",
    "description": "Convert 3 stack-dependent integration test files to use in-process Bun.serve() mock servers instead of requiring a live Docker stack, following the pattern from channel-gateway.integration.test.ts.",
    "priority": "P4",
    "status": "pending",
    "estimatedEffort": "2-3 hours",
    "planFile": ".plans/R11-make-integration-tests-run-in-ci.md",
    "subtasks": [
      {
        "id": "R11.1",
        "description": "Convert container-health.integration.test.ts: remove OPENPALM_INTEGRATION guard, import checkServiceHealth, create mock Bun.serve() servers, test against mocks",
        "status": "pending",
        "files": [
          {
            "path": "test/integration/container-health.integration.test.ts",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "packages/ui/src/lib/server/health.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R11.2",
        "description": "Convert admin-auth.integration.test.ts: remove skipIf guard, create mock admin server with auth middleware pattern, test 401/200 responses",
        "status": "pending",
        "files": [
          {
            "path": "test/integration/admin-auth.integration.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R11.3",
        "description": "Convert admin-health-check.integration.test.ts: remove skipIf guard, create mock service servers, test health-check response shape and aggregation",
        "status": "pending",
        "files": [
          {
            "path": "test/integration/admin-health-check.integration.test.ts",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "packages/ui/src/lib/server/health.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R11.4",
        "description": "Verify all integration tests pass without Docker: bun test --filter integration",
        "status": "pending",
        "files": [
          {
            "path": "test/integration/channel-gateway.integration.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R12",
    "title": "Fix bun test discovery",
    "description": "Configure bunfig.toml to exclude Docker tests from default discovery, simplify test:unit script, remove dead scripts, and fix naming inconsistency.",
    "priority": "P4",
    "status": "pending",
    "estimatedEffort": "15 minutes",
    "planFile": ".plans/R12-fix-bun-test-discovery.md",
    "subtasks": [
      {
        "id": "R12.1",
        "description": "Rename test/contracts/readme-no-npx.test.ts to readme-no-npx.contract.test.ts for naming consistency",
        "status": "pending",
        "files": [
          {
            "path": "test/contracts/readme-no-npx.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R12.2",
        "description": "Add exclude patterns for test/docker/** and test/install-e2e/** to bunfig.toml [test] section",
        "status": "pending",
        "files": [
          {
            "path": "bunfig.toml",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R12.3",
        "description": "Replace fragile deny-list test:unit script with directory allow-list: bun test packages/ channels/ core/ dev/",
        "status": "pending",
        "files": [
          {
            "path": "package.json",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R12.4",
        "description": "Remove dead test:compose and test:compose:ui scripts from package.json",
        "status": "pending",
        "files": [
          {
            "path": "package.json",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R12.5",
        "description": "Verify bun test excludes Docker tests, test:unit runs correctly, and test:contracts discovers renamed file",
        "status": "pending",
        "files": [
          {
            "path": "bunfig.toml",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "package.json",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R13",
    "title": "Inject dependencies instead of monkey-patching globals",
    "description": "Add SpawnFn type and optional spawn parameter to runCompose, createComposeRunner, and composeExec, then rewrite two test files to use DI instead of monkey-patching Bun.spawn.",
    "priority": "P5",
    "status": "pending",
    "estimatedEffort": "2-3 hours",
    "planFile": ".plans/R13-inject-dependencies-not-globals.md",
    "subtasks": [
      {
        "id": "R13.1",
        "description": "Add SpawnFn type and spawn? field to ComposeRunOptions in packages/lib/src/types.ts",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/types.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R13.2",
        "description": "Update runComposeOnce in compose-runner.ts to use options.spawn ?? Bun.spawn instead of hard-coded Bun.spawn",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/compose-runner.ts",
            "lines": "27-48",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R13.3",
        "description": "Thread spawn parameter through createComposeRunner and execCompose in admin/compose-runner.ts",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/compose-runner.ts",
            "lines": "73-131",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R13.4",
        "description": "Add spawn? to composeExec options in packages/lib/src/compose.ts and forward it",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/compose.ts",
            "lines": "14",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R13.5",
        "description": "Rewrite compose-runner.test.ts: remove all Bun.spawn monkey-patching, use createComposeRunner(envFile, mockSpawn) and createMockRunner()",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/compose-runner.test.ts",
            "lines": "13-40",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R13.6",
        "description": "Rewrite packages/cli/test/compose.test.ts: remove Bun.spawn monkey-patching, pass spawn via composeExec options",
        "status": "pending",
        "files": [
          {
            "path": "packages/cli/test/compose.test.ts",
            "lines": "47-56",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R13.7",
        "description": "Run full test suite and grep for remaining Bun.spawn= assignments in test files",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/compose-runner.test.ts",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "packages/cli/test/compose.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R14",
    "title": "Fix module-load side effects in automations.ts",
    "description": "Refactor automations.ts to accept cronDir as an explicit parameter instead of reading Bun.env.CRON_DIR, eliminating the cache-busting import hack in tests.",
    "priority": "P5",
    "status": "pending",
    "estimatedEffort": "2-3 hours",
    "planFile": ".plans/R14-fix-module-load-side-effects.md",
    "subtasks": [
      {
        "id": "R14.1",
        "description": "Refactor automations.ts: remove cronDir() env reader function, add cronDir parameter to all exported functions (ensureCronDirs, syncAutomations, triggerAutomation) and internal helpers",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/automations.ts",
            "lines": "10-18",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.2",
        "description": "Update ensureCronDirs signature and internal calls to pass cronDir parameter",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/automations.ts",
            "lines": "35-40",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.3",
        "description": "Update syncAutomations and triggerAutomation signatures to accept cronDir as first parameter",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/automations.ts",
            "lines": "42-120",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.4",
        "description": "Update init.ts: remove process.env.CRON_DIR propagation, pass CRON_DIR to ensureCronDirs() and syncAutomations()",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/src/lib/server/init.ts",
            "lines": "72-93",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.5",
        "description": "Update packages/ui/src/routes/command/+server.ts: pass CRON_DIR to syncAutomations and triggerAutomation calls",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/src/routes/command/+server.ts",
            "lines": "355-588",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.6",
        "description": "Update remaining UI route callers (stack/apply, setup/complete, automations/*, automations/update, automations/delete, automations/trigger) to pass CRON_DIR",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/src/routes/stack/apply/+server.ts",
            "lines": "5-28",
            "action": "modify"
          },
          {
            "path": "packages/ui/src/routes/setup/complete/+server.ts",
            "lines": "7-41",
            "action": "modify"
          },
          {
            "path": "packages/ui/src/routes/automations/+server.ts",
            "lines": "5-40",
            "action": "modify"
          },
          {
            "path": "packages/ui/src/routes/automations/update/+server.ts",
            "lines": "4-24",
            "action": "modify"
          },
          {
            "path": "packages/ui/src/routes/automations/delete/+server.ts",
            "lines": "3-14",
            "action": "modify"
          },
          {
            "path": "packages/ui/src/routes/automations/trigger/+server.ts",
            "lines": "3-13",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.7",
        "description": "Rewrite automations.test.ts: use static import, remove cache-busting hack and env var manipulation, pass cronDir directly",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/automations.test.ts",
            "lines": "11-23",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R14.8",
        "description": "Run full test suite and grep for remaining Bun.env.CRON_DIR and cache-busting import patterns",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/automations.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R15",
    "title": "Add health-check failure tests",
    "description": "Add 4 new Playwright E2E tests to 10-setup-wizard-ui.pw.ts covering health-check failure scenarios: service errors, polling timeout, partial readiness, and HealthStep dot indicators.",
    "priority": "P5",
    "status": "pending",
    "estimatedEffort": "2-3 hours",
    "planFile": ".plans/R15-add-health-check-failure-tests.md",
    "subtasks": [
      {
        "id": "R15.1",
        "description": "Extract navigateToHealthCheckStep() helper function to reduce wizard navigation duplication",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R15.2",
        "description": "Extract mockSetupCompleteOk() helper function for shared setup.complete command mocking",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R15.3",
        "description": "Add Test 1: Complete step shows error state when all non-admin services report ok:false (fast-fail after 5 polls)",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R15.4",
        "description": "Add Test 2: Complete step shows timeout message after full 60-poll polling exhaustion (partial failure: some services up, some down)",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R15.5",
        "description": "Add Test 3: Complete step renders per-service status during polling with phased mock (services come up incrementally)",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R15.6",
        "description": "Add Test 4: Health Check step shows per-service dot indicators for mixed health (dot-ok, dot-err, error text)",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      },
      {
        "id": "R15.7",
        "description": "Run full Playwright suite and verify all new and existing tests pass",
        "status": "pending",
        "files": [
          {
            "path": "packages/ui/e2e/10-setup-wizard-ui.pw.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R16",
    "title": "Deduplicate parameterized tests",
    "description": "Collapse ~46 duplicate test cases across 8 files into parameterized for...of loops, reducing code duplication while maintaining the same test coverage.",
    "priority": "P5",
    "status": "pending",
    "estimatedEffort": "2-3 hours",
    "planFile": ".plans/R16-deduplicate-parameterized-tests.md",
    "subtasks": [
      {
        "id": "R16.1",
        "description": "Pattern 1 & 2: Parameterize setAccessScope and completeStep tests in setup-manager.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/setup-manager.test.ts",
            "lines": "56-97",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.2",
        "description": "Pattern 3 & 4: Parameterize help/version flag and subcommand validation tests in main.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "packages/cli/test/main.test.ts",
            "lines": "39-188",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.3",
        "description": "Pattern 5: Remove redundant individual loadComposeConfig tests from management-commands.test.ts (already covered by shared loop)",
        "status": "pending",
        "files": [
          {
            "path": "packages/cli/test/management-commands.test.ts",
            "lines": "42-169",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.4",
        "description": "Pattern 6 & 7: Parameterize safeRequestId and validatePayload tests in core/gateway/src/server.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "core/gateway/src/server.test.ts",
            "lines": "23-93",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.5",
        "description": "Pattern 8 & 9: Parameterize missing text field and malformed body tests in input-bounds.security.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "test/security/input-bounds.security.test.ts",
            "lines": "121-227",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.6",
        "description": "Pattern 10: Parameterize parseCustomCommands invalid-input tests in channels/discord/server.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "channels/discord/server.test.ts",
            "lines": "429-444",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.7",
        "description": "Pattern 11: Parameterize validateCron out-of-range tests in cron.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/cron.test.ts",
            "lines": "24-45",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.8",
        "description": "Pattern 12: Parameterize HMAC special body content tests in hmac.security.test.ts",
        "status": "pending",
        "files": [
          {
            "path": "test/security/hmac.security.test.ts",
            "lines": "130-166",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R16.9",
        "description": "Run full test suite and verify test count remains approximately the same",
        "status": "pending",
        "files": [
          {
            "path": "packages/lib/src/admin/setup-manager.test.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  },
  {
    "id": "R17",
    "title": "Dynamic port allocation for Docker tests",
    "description": "Replace hardcoded host ports (18200, 18280, 18300) in Docker test files with dynamic port allocation using Docker Compose '0:<container_port>' syntax and docker compose port discovery.",
    "priority": "P5",
    "status": "pending",
    "estimatedEffort": "1-2 hours",
    "planFile": ".plans/R17-dynamic-port-allocation.md",
    "subtasks": [
      {
        "id": "R17.1",
        "description": "Create shared helper test/helpers/docker-compose-port.ts with resolveHostPort() function",
        "status": "pending",
        "files": [
          {
            "path": "test/helpers/docker-compose-port.ts",
            "lines": null,
            "action": "create"
          }
        ]
      },
      {
        "id": "R17.2",
        "description": "Modify docker-stack.docker.ts: remove hardcoded ADMIN_PORT/GATEWAY_PORT constants, use '0:8100' and '0:8080' in compose overlay, add resolveHostPort() calls after container startup",
        "status": "pending",
        "files": [
          {
            "path": "test/docker/docker-stack.docker.ts",
            "lines": "96-217",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R17.3",
        "description": "Modify happy-path.docker.ts: remove hardcoded ADMIN_PORT constant, use '0:8100' in compose overlay, add resolveHostPort() call after container startup",
        "status": "pending",
        "files": [
          {
            "path": "test/install-e2e/happy-path.docker.ts",
            "lines": "25-254",
            "action": "modify"
          }
        ]
      },
      {
        "id": "R17.4",
        "description": "Verify both Docker test suites pass with dynamic ports and can run in parallel without conflicts",
        "status": "pending",
        "files": [
          {
            "path": "test/docker/docker-stack.docker.ts",
            "lines": null,
            "action": "modify"
          },
          {
            "path": "test/install-e2e/happy-path.docker.ts",
            "lines": null,
            "action": "modify"
          }
        ]
      }
    ]
  }
]
