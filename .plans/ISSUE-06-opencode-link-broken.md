# ISSUE-6: "Open OpenCode" Link Is Broken — Authentication Mismatch

**Severity:** BLOCKER  
**Priority:** Must Fix  
**Effort:** XS — change one URL

## Problem Summary

The "Open OpenCode" link in QuickLinks.svelte uses `${base}/opencode/` which routes through the SvelteKit proxy. Browser link navigations don't send `x-admin-token` headers, so the proxy returns 401. The working Caddy route at `/services/opencode*` exists but is not used.

## Implementation Steps

### Step 1: Change the assistant URL in QuickLinks.svelte

**File:** `packages/ui/src/lib/components/QuickLinks.svelte:5`

Change:
```typescript
const assistantUrl = `${base}/opencode/`;
```
to:
```typescript
const assistantUrl = `/services/opencode/`;
```

This points to the Caddy direct proxy route which:
- Handles WebSocket and SSE natively (no timeout)
- Requires no admin token (already LAN-restricted by IP guard)
- Is generated by `stack-generator.ts` in the `caddyAdminSubroute` function

### Step 2: Verify the Caddy route exists in stack-generator.ts

**File:** `packages/lib/src/admin/stack-generator.ts`

Confirm that `caddyAdminSubroute()` (around line 140) includes the route:
```
/services/opencode* → strip prefix + proxy to assistant:4096
```

This is already present — no changes needed in the generator.

### Step 3: Keep the SvelteKit proxy for programmatic API access

**File:** `packages/ui/src/routes/opencode/[...path]/+server.ts`

No changes needed. This route can remain for programmatic API access where callers set `x-admin-token` headers (e.g., from JavaScript fetch calls within the admin UI if ever needed).

## Files Changed

| File | Change |
|---|---|
| `packages/ui/src/lib/components/QuickLinks.svelte` | Change `assistantUrl` from `${base}/opencode/` to `/services/opencode/` |

## Testing

1. Run `bun test` — ensure no regressions
2. Manual test: click "Open OpenCode" in admin dashboard → should open chat interface in new tab
3. Verify WebSocket/SSE connections work (chat responses stream properly)
4. Verify the link works from both localhost and LAN IP addresses

## Note

This fix also resolves ISSUE-7 (SvelteKit proxy WebSocket/SSE limitations) since the Caddy route handles both natively.
