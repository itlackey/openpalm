# OpenPaLM v0.5.0 Migration Plan

> Revised 2026-02-27. Aligned to actual codebase state.
> Priority: simplest path. No CLI, no version.ts, keep setup.sh.

---

## Current State

### Package names & versions (op-mvp backlog)

| Workspace | Current Name | Current Version |
|-----------|-------------|-----------------|
| root | `op-mvp` | `0.1.0` |
| `core/admin` | `openpalm-mvp-admin` | `0.1.0` |
| `core/guardian` | `@openpalm/guardian` | `0.1.0` |
| `packages/lib` | `@openpalm/lib` | `0.1.0` |
| `channels/chat` | `@openpalm/channel-chat` | `0.1.0` |
| `channels/api` | `@openpalm/channel-api` | `0.4.0` |
| `channels/discord` | `@openpalm/channel-discord` | `0.4.0` |
| `channels/base` | `@openpalm/channel-base` | `0.1.0` |

### Existing CI/CD

- `ci.yml` — quality gates on PR/push to main (admin check, bun test, compose validate)
- `release.yml` — tag-triggered (`v*`) or manual dispatch:
  - Publishes 7 Docker images (currently to **GHCR** — needs to change to **Docker Hub**)
  - Auto-discovers non-private packages for npm (nothing is non-private yet)
  - Creates GitHub Release with deploy bundle tarball

### What the docker-compose.yml expects

Images pull from `${OPENPALM_IMAGE_NAMESPACE:-openpalm}/<service>:${OPENPALM_IMAGE_TAG:-latest}`.
Default is `openpalm/admin`, `openpalm/guardian`, etc. — **Docker Hub**.

### What setup.sh does

Downloads `docker-compose.yml` and `Caddyfile` from `REPO="itlackey/op-mvp"`, pulls
the admin image, starts the admin service, opens the setup wizard. Already fully
functional — just needs the REPO reference updated.

---

## Phase 1: Package Identity & Version Normalization

Mechanical edits only.

### 1.1 Root `package.json`

```diff
- "name": "op-mvp",
+ "name": "openpalm",
- "version": "0.1.0",
+ "version": "0.5.0",
```

Workspaces array unchanged.

### 1.2 Workspace `package.json` updates

| File | Name change | Version |
|------|------------|---------|
| `core/admin/package.json` | `openpalm-mvp-admin` → `@openpalm/admin` | `0.5.0` |
| `core/guardian/package.json` | unchanged | `0.5.0` |
| `packages/lib/package.json` | unchanged | `0.5.0` |
| `channels/chat/package.json` | unchanged | `0.5.0` |
| `channels/api/package.json` | unchanged | `0.5.0` |
| `channels/discord/package.json` | unchanged | `0.5.0` |
| `channels/base/package.json` | unchanged | `0.5.0` |

### 1.3 Text reference updates

Grep for `op-mvp` and update to `openpalm`:
- `scripts/setup.sh` — `REPO="itlackey/op-mvp"` → `REPO="itlackey/openpalm"`, and both
  URL comments in the header
- `README.md` — repo URLs and one-liner install URL
- `AGENTS.md` — project name
- `docs/*.md` — repo/project name references
- `.opencode/opencode.json` — project name field (if present)

---

## Phase 2: Update `release.yml` — Docker Hub Instead of GHCR

The existing workflow builds and publishes correctly. The only change is swapping
GHCR authentication and image names for Docker Hub.

### 2.1 Login step change

```yaml
# Replace:
- name: Login to GHCR
  uses: docker/login-action@v3
  with:
    registry: ghcr.io
    username: ${{ github.actor }}
    password: ${{ secrets.GITHUB_TOKEN }}

# With:
- name: Login to Docker Hub
  uses: docker/login-action@v3
  with:
    username: ${{ secrets.DOCKERHUB_USERNAME }}
    password: ${{ secrets.DOCKERHUB_TOKEN }}
```

### 2.2 Image names in matrix

```yaml
# Replace ghcr.io/${{ github.repository_owner }}/openpalm-* with:
- dockerfile: core/admin/Dockerfile
  image: openpalm/admin
- dockerfile: core/guardian/Dockerfile
  image: openpalm/guardian
- dockerfile: channels/chat/Dockerfile
  image: openpalm/channel-chat
- dockerfile: channels/api/Dockerfile
  image: openpalm/channel-api
- dockerfile: channels/discord/Dockerfile
  image: openpalm/channel-discord
- dockerfile: channels/base/Dockerfile
  image: openpalm/channel-base
- dockerfile: core/assistant/Dockerfile
  image: openpalm/assistant
```

### 2.3 Remove npm publish job

Delete the `publish-npm` job entirely — nothing to publish to npm.

Update the `release` job's `needs` array to remove `publish-npm`:
```yaml
needs:
  - prepare-tag
  - publish-images
  # publish-npm removed
```

### 2.4 Result

Simplified release pipeline:
1. `prepare-tag` — resolve/create git tag
2. `quality-gates` — type-check, tests, compose validate
3. `publish-images` — 7 Docker images → Docker Hub
4. `release` — GitHub Release with deploy bundle tarball

---

## Phase 3: Repository Migration

### 3.1 In `itlackey/openpalm`

```bash
# Tag current state for reference
git tag v0.4.0-final
git push origin v0.4.0-final

# Create migration branch
git checkout -b migration/v0.5.0

# Clear working tree (preserves .git/)
git rm -rf .

# Copy op-mvp backlog branch contents (excluding .git/)
rsync -av --exclude='.git' /path/to/op-mvp/ .

git add -A
git commit -m "feat: migrate to op-mvp codebase for v0.5.0"
```

### 3.2 GitHub Secrets

Ensure these exist in `itlackey/openpalm` repo settings:
- `DOCKERHUB_USERNAME` — Docker Hub account username
- `DOCKERHUB_TOKEN` — Docker Hub access token

`GITHUB_TOKEN` (for GitHub Release creation) is auto-provided.

### 3.3 Docker Hub repositories

Create `openpalm/guardian` on Docker Hub if it doesn't exist.
The following images will receive the `0.5.0` and `latest` tags:
- `openpalm/admin`
- `openpalm/guardian`
- `openpalm/assistant`
- `openpalm/channel-chat`
- `openpalm/channel-api`
- `openpalm/channel-discord`
- `openpalm/channel-base`

Old images (`openpalm/gateway`, `openpalm/channel-voice`, etc.) simply stop receiving
updates — no automated cleanup needed.

---

## Phase 4: Release

### 4.1 Merge PR

Open PR `migration/v0.5.0` → `main`. CI must pass.

### 4.2 Trigger release

Via GitHub Actions manual dispatch: enter `0.5.0` in the version input field.
This tags `v0.5.0`, runs quality gates, publishes images, creates GitHub Release.

Or push a tag directly:
```bash
git tag -a v0.5.0 -m "Release v0.5.0"
git push origin v0.5.0
```

### 4.3 Verify

```bash
docker pull openpalm/admin:0.5.0
docker pull openpalm/guardian:0.5.0
curl -fsSL https://raw.githubusercontent.com/itlackey/openpalm/main/scripts/setup.sh | bash
```

---

## Phase 5: Cleanup

### 5.1 Archive `itlackey/op-mvp`

Add redirect notice to README, archive via Settings → Archive Repository.

### 5.2 Docker Hub

Optionally deprecate or delete old v0.4.0 images (`openpalm/gateway`, etc.)
via Docker Hub UI. No automated action needed.

---

## Docker Images (7, published to Docker Hub)

| Image | Dockerfile |
|-------|------------|
| `openpalm/admin` | `core/admin/Dockerfile` |
| `openpalm/guardian` | `core/guardian/Dockerfile` |
| `openpalm/assistant` | `core/assistant/Dockerfile` |
| `openpalm/channel-chat` | `channels/chat/Dockerfile` |
| `openpalm/channel-api` | `channels/api/Dockerfile` |
| `openpalm/channel-discord` | `channels/discord/Dockerfile` |
| `openpalm/channel-base` | `channels/base/Dockerfile` |

---

## Task Order

```
Phase 1: Rename packages + bump versions (mechanical)
  ↓
Phase 2: Update release.yml (Docker Hub, remove npm job)
  ↓
  Validate: bun run test, docker builds pass locally, compose config validates
  ↓
Phase 3: Copy to itlackey/openpalm migration/v0.5.0 branch
  ↓
Phase 4: Merge PR → trigger release → verify images on Docker Hub
  ↓
Phase 5: Cleanup
```

## Risk Summary

| Risk | Mitigation |
|------|------------|
| `DOCKERHUB_TOKEN` missing in openpalm repo | Check secrets before triggering release |
| `openpalm/guardian` Docker Hub repo doesn't exist | Create manually before first publish |
| `channels/base` Dockerfile broken with root build context | Test `docker build -f channels/base/Dockerfile .` locally first |
| setup.sh still points to op-mvp after migration | Phase 1.3 — update REPO and URL comments |
