services:
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "${OPENPALM_INGRESS_BIND_ADDRESS:-127.0.0.1}:80:80"
      - "${OPENPALM_INGRESS_BIND_ADDRESS:-127.0.0.1}:443:443"
    volumes:
      - ${OPENPALM_STATE_HOME}/rendered/caddy/caddy.json:/etc/caddy/caddy.json:ro
      - ${OPENPALM_STATE_HOME}/caddy/data:/data/caddy
      - ${OPENPALM_STATE_HOME}/caddy/config:/config/caddy
    command: caddy run --config /etc/caddy/caddy.json
    networks: [assistant_net]

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/postgres/.env
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-openpalm}
      POSTGRES_USER: ${POSTGRES_USER:-openpalm}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change-me-pg-password}
    volumes:
      - ${OPENPALM_DATA_HOME}/postgres:/var/lib/postgresql/data
    networks: [assistant_net]

  qdrant:
    image: qdrant/qdrant:v1.13.2
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/qdrant/.env
    volumes:
      - ${OPENPALM_DATA_HOME}/qdrant:/qdrant/storage
    networks: [assistant_net]

  openmemory:
    image: mem0/openmemory-mcp:latest
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/openmemory/.env
    ports:
      - "${OPENPALM_OPENMEMORY_BIND_ADDRESS:-127.0.0.1}:8765:8765"
    volumes:
      - ${OPENPALM_DATA_HOME}/openmemory:/data
    networks: [assistant_net]
    depends_on: [qdrant]

  openmemory-ui:
    image: mem0/openmemory-ui:latest
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=${OPENMEMORY_DASHBOARD_API_URL:-http://localhost:8765}
      - NEXT_PUBLIC_USER_ID=${OPENMEMORY_USER_ID:-default-user}
    ports:
      - "${OPENPALM_OPENMEMORY_UI_BIND_ADDRESS:-127.0.0.1}:3000:3000"
    networks: [assistant_net]
    depends_on: [openmemory]

  assistant:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/assistant:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/assistant/.env
    environment:
      - OPENCODE_CONFIG_DIR=/opt/opencode
      - OPENCODE_PORT=4096
      - OPENCODE_ENABLE_SSH=${OPENCODE_ENABLE_SSH:-0}
      - HOME=/home/opencode
    ports:
      - "${OPENCODE_CORE_BIND_ADDRESS:-127.0.0.1}:4096:4096"
      - "${OPENCODE_CORE_SSH_BIND_ADDRESS:-127.0.0.1}:${OPENCODE_CORE_SSH_PORT:-2222}:22"
    volumes:
      - ${OPENPALM_DATA_HOME}/assistant:/home/opencode
      - ${HOME}/openpalm:/work
    working_dir: /work
    user: "${OPENPALM_UID:-1000}:${OPENPALM_GID:-1000}"
    networks: [assistant_net]
    depends_on: [openmemory]
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:4096/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  gateway:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/gateway:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/system.env
      - ${OPENPALM_STATE_HOME}/gateway/.env
    environment:
      - PORT=8080
      - OPENCODE_CORE_BASE_URL=http://assistant:4096
      - OPENCODE_TIMEOUT_MS=${OPENCODE_TIMEOUT_MS:-15000}
    volumes:
      - ${OPENPALM_STATE_HOME}/gateway:/app/data
    networks: [channel_net, assistant_net]
    depends_on: [assistant]
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  admin:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/admin:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/system.env
    environment:
      - PORT=8100
      - ADMIN_TOKEN=${ADMIN_TOKEN:-change-me-admin-token}
      - GATEWAY_URL=http://gateway:8080
      - OPENCODE_CORE_URL=http://assistant:4096
      - OPENPALM_COMPOSE_BIN=${OPENPALM_COMPOSE_BIN:-docker}
      - OPENPALM_COMPOSE_SUBCOMMAND=${OPENPALM_COMPOSE_SUBCOMMAND:-compose}
      - OPENPALM_CONTAINER_SOCKET_URI=${OPENPALM_CONTAINER_SOCKET_URI:-unix:///var/run/docker.sock}
      - COMPOSE_PROJECT_PATH=/state
      - OPENPALM_COMPOSE_FILE=docker-compose.yml
    volumes:
      - ${OPENPALM_DATA_HOME}:/data
      - ${OPENPALM_CONFIG_HOME}:/config
      - ${OPENPALM_STATE_HOME}:/state
      - ${HOME}/openpalm:/work
      - ${OPENPALM_CONTAINER_SOCKET_PATH:-/var/run/docker.sock}:${OPENPALM_CONTAINER_SOCKET_IN_CONTAINER:-/var/run/docker.sock}
    networks: [assistant_net]
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:8100/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  channel-chat:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/channel-chat:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_STATE_HOME}/channel-chat/.env
    environment:
      - PORT=8181
      - GATEWAY_URL=http://gateway:8080
    networks: [channel_net]
    depends_on: [gateway]

  channel-discord:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/channel-discord:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_STATE_HOME}/channel-discord/.env
    environment:
      - PORT=8184
      - GATEWAY_URL=http://gateway:8080
    networks: [channel_net]
    depends_on: [gateway]

  channel-voice:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/channel-voice:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_STATE_HOME}/channel-voice/.env
    environment:
      - PORT=8183
      - GATEWAY_URL=http://gateway:8080
    networks: [channel_net]
    depends_on: [gateway]

  channel-telegram:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/channel-telegram:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_STATE_HOME}/channel-telegram/.env
    environment:
      - PORT=8182
      - GATEWAY_URL=http://gateway:8080
    networks: [channel_net]
    depends_on: [gateway]

networks:
  channel_net:
  assistant_net:
