services:
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "${OPENPALM_INGRESS_BIND_ADDRESS:-127.0.0.1}:80:80"
      - "${OPENPALM_INGRESS_BIND_ADDRESS:-127.0.0.1}:443:443"
    volumes:
      - ${OPENPALM_STATE_HOME}/caddy.json:/etc/caddy/caddy.json:ro
      - ${OPENPALM_STATE_HOME}/caddy/data:/data/caddy
      - ${OPENPALM_STATE_HOME}/caddy/config:/config/caddy
    command: caddy run --config /etc/caddy/caddy.json
    networks: [assistant_net]

  admin:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/admin:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ${OPENPALM_STATE_HOME}/system.env
    environment:
      - PORT=8100
      - ADMIN_TOKEN=${ADMIN_TOKEN:-change-me-admin-token}
      - GATEWAY_URL=http://gateway:8080
      - OPENCODE_CORE_URL=http://assistant:4096
      - OPENPALM_COMPOSE_BIN=${OPENPALM_COMPOSE_BIN:-docker}
      - OPENPALM_COMPOSE_SUBCOMMAND=${OPENPALM_COMPOSE_SUBCOMMAND:-compose}
      - OPENPALM_CONTAINER_SOCKET_URI=${OPENPALM_CONTAINER_SOCKET_URI:-unix:///var/run/docker.sock}
      - COMPOSE_PROJECT_PATH=/state
      - OPENPALM_COMPOSE_FILE=docker-compose.yml
    volumes:
      - ${OPENPALM_DATA_HOME}:/data
      - ${OPENPALM_CONFIG_HOME}:/config
      - ${OPENPALM_STATE_HOME}:/state
      - ${OPENPALM_WORK_HOME:-${HOME}/openpalm}:/work
      - ${OPENPALM_CONTAINER_SOCKET_PATH:-/var/run/docker.sock}:${OPENPALM_CONTAINER_SOCKET_IN_CONTAINER:-/var/run/docker.sock}
    networks: [assistant_net]
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:8100/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  channel_net:
  assistant_net:
