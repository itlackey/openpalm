services:
  # ============================================================
  # Reverse Proxy — Caddy (front door)
  # Routes channel ingress and LAN-only admin/dashboard URLs:
  # /channels/* and /admin/* (including /admin/opencode* and /admin/openmemory*)
  # ============================================================
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "${OPENPALM_INGRESS_BIND_ADDRESS:-0.0.0.0}:80:80"
      - "${OPENPALM_INGRESS_BIND_ADDRESS:-0.0.0.0}:443:443"
    volumes:
      - ${OPENPALM_CONFIG_HOME}/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ${OPENPALM_DATA_HOME}/caddy:/data
      - ${OPENPALM_STATE_HOME}/caddy:/config
    networks: [assistant_net]
    depends_on: [gateway, admin]

  # ============================================================
  # Storage Layer
  # ============================================================
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-openpalm}
      POSTGRES_USER: ${POSTGRES_USER:-openpalm}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change-me-pg-password}
    volumes:
      - ${OPENPALM_DATA_HOME}/postgres:/var/lib/postgresql/data
    networks: [assistant_net]

  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    volumes:
      - ${OPENPALM_DATA_HOME}/qdrant:/qdrant/storage
    networks: [assistant_net]

  # ============================================================
  # Core Application Layer
  # ============================================================
  openmemory:
    image: skpassegna/openmemory-mcp:latest
    restart: unless-stopped
    ports:
      - "${OPENPALM_OPENMEMORY_BIND_ADDRESS:-0.0.0.0}:3000:3000"
      - "${OPENPALM_OPENMEMORY_BIND_ADDRESS:-0.0.0.0}:8765:8765"
    volumes:
      - ${OPENPALM_DATA_HOME}/openmemory:/data
      - ${OPENPALM_DATA_HOME}/shared:/shared
    networks: [assistant_net]
    depends_on: [qdrant]

  opencode-core:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-opencode-core:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    env_file:
      - ${OPENPALM_CONFIG_HOME}/user.env
      - ${OPENPALM_CONFIG_HOME}/secrets.env
    environment:
      - OPENCODE_CONFIGURATION_DIRECTORY=/config
      - OPENCODE_CONFIG=/config/opencode.jsonc
      - OPENCODE_PORT=4096
      - OPENCODE_ENABLE_SSH=${OPENCODE_ENABLE_SSH:-0}
    # Bind addresses default to localhost; set *_BIND_ADDRESS=0.0.0.0 to allow LAN access.
    ports:
      - "${OPENCODE_CORE_BIND_ADDRESS:-127.0.0.1}:4096:4096"
      - "${OPENCODE_CORE_SSH_BIND_ADDRESS:-127.0.0.1}:${OPENCODE_CORE_SSH_PORT:-2222}:22"
    volumes:
      - ${OPENPALM_CONFIG_HOME}/opencode-core:/config
      - ${OPENPALM_STATE_HOME}/opencode-core:/state
      - ${OPENPALM_STATE_HOME}/workspace:/work
      - ${OPENPALM_DATA_HOME}/shared:/shared
    working_dir: /work
    networks: [assistant_net]
    depends_on: [openmemory]


  gateway:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-gateway:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - PORT=8080
      - OPENCODE_CORE_BASE_URL=http://opencode-core:4096
      - OPENCODE_TIMEOUT_MS=${OPENCODE_TIMEOUT_MS:-15000}
      - CHANNEL_CHAT_SECRET=${CHANNEL_CHAT_SECRET:-}
      - CHANNEL_DISCORD_SECRET=${CHANNEL_DISCORD_SECRET:-}
      - CHANNEL_VOICE_SECRET=${CHANNEL_VOICE_SECRET:-}
      - CHANNEL_TELEGRAM_SECRET=${CHANNEL_TELEGRAM_SECRET:-}
    volumes:
      - ${OPENPALM_STATE_HOME}/gateway:/app/data
    networks: [assistant_net]
    depends_on: [opencode-core]

  admin:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-admin:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - PORT=8100
      - ADMIN_TOKEN=${ADMIN_TOKEN:-change-me-admin-token}
      - OPENCODE_CONFIG_PATH=/app/config/opencode-core/opencode.jsonc
      - CONTROLLER_URL=http://controller:8090
      - CONTROLLER_TOKEN=${CONTROLLER_TOKEN:-change-me-controller}
      - GATEWAY_URL=http://gateway:8080
      - OPENCODE_CORE_URL=http://opencode-core:4096
      - CADDYFILE_PATH=/app/config/caddy/Caddyfile
      - CHANNEL_ENV_DIR=/app/channel-env
      - RUNTIME_ENV_PATH=/workspace/.env
    volumes:
      - ${OPENPALM_CONFIG_HOME}/opencode-core:/app/config/opencode-core
      - ${OPENPALM_CONFIG_HOME}/caddy:/app/config/caddy
      - ${OPENPALM_CONFIG_HOME}/channels:/app/channel-env
      - ${OPENPALM_DATA_HOME}/admin:/app/data
      - ${OPENPALM_DATA_HOME}/shared:/shared
      - ${OPENPALM_STATE_HOME}:/workspace
    networks: [assistant_net]
    depends_on: [controller]

  controller:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-controller:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - PORT=8090
      - CONTROLLER_TOKEN=${CONTROLLER_TOKEN:-change-me-controller}
      - COMPOSE_PROJECT_PATH=/workspace
      - OPENPALM_CONTAINER_PLATFORM=${OPENPALM_CONTAINER_PLATFORM:-docker}
      - OPENPALM_COMPOSE_BIN=${OPENPALM_COMPOSE_BIN:-docker}
      - OPENPALM_COMPOSE_SUBCOMMAND=${OPENPALM_COMPOSE_SUBCOMMAND:-compose}
      - OPENPALM_CONTAINER_SOCKET_URI=${OPENPALM_CONTAINER_SOCKET_URI:-unix:///var/run/openpalm-container.sock}
    volumes:
      - ${OPENPALM_CONTAINER_SOCKET_PATH:-/var/run/docker.sock}:${OPENPALM_CONTAINER_SOCKET_IN_CONTAINER:-/var/run/openpalm-container.sock}
      - ${OPENPALM_STATE_HOME}:/workspace
    networks: [assistant_net]

  # ============================================================
  # Channel Layer (optional — enable via --profile channels)
  # Channels are exposed via Caddy under /channels/*; adapters forward normalized payloads to gateway internally
  # ============================================================
  channel-chat:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-channel-chat:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_CONFIG_HOME}/channels/channel-chat.env
    environment:
      - PORT=8181
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_CHAT_SECRET=${CHANNEL_CHAT_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

  channel-discord:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-channel-discord:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_CONFIG_HOME}/channels/channel-discord.env
    environment:
      - PORT=8184
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_DISCORD_SECRET=${CHANNEL_DISCORD_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

  channel-voice:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-channel-voice:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_CONFIG_HOME}/channels/channel-voice.env
    environment:
      - PORT=8183
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_VOICE_SECRET=${CHANNEL_VOICE_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

  channel-telegram:
    image: ${OPENPALM_IMAGE_NAMESPACE:-openpalm}/openpalm-channel-telegram:${OPENPALM_IMAGE_TAG:-latest}
    restart: unless-stopped
    profiles: ["channels"]
    env_file:
      - ${OPENPALM_CONFIG_HOME}/channels/channel-telegram.env
    environment:
      - PORT=8182
      - GATEWAY_URL=http://gateway:8080
      - CHANNEL_TELEGRAM_SECRET=${CHANNEL_TELEGRAM_SECRET:-}
    networks: [assistant_net]
    depends_on: [gateway]

networks:
  assistant_net:
