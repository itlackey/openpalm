{
	admin off
}

:80 {
	@lan remote_ip 127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 ::1 fd00::/8
	@not_lan not remote_ip 127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 ::1 fd00::/8

	# Channel ingress (LAN by default; configurable by admin API)
	handle /channels/chat* {
		abort @not_lan
		rewrite * /chat
		reverse_proxy channel-chat:8181
	}

	handle /channels/voice* {
		abort @not_lan
		rewrite * /voice/transcription
		reverse_proxy channel-voice:8183
	}

	handle /channels/discord* {
		abort @not_lan
		rewrite * /discord/webhook
		reverse_proxy channel-discord:8184
	}

	handle /channels/telegram* {
		abort @not_lan
		rewrite * /telegram/webhook
		reverse_proxy channel-telegram:8182
	}

	# LAN-only admin umbrella
	handle /admin* {
		abort @not_lan
		route {
			handle /admin/api* {
				uri replace /admin/api /admin
				reverse_proxy admin:8100
			}

			handle /admin/opencode* {
				uri replace /admin/opencode / 
				reverse_proxy opencode-core:4096
			}

			handle /admin/openmemory* {
				uri replace /admin/openmemory / 
				reverse_proxy openmemory:3000
			}

			# Admin service serves UI/assets from root paths.
			uri strip_prefix /admin
			reverse_proxy admin:8100
		}
	}

	# Explicitly reject other URLs at edge
	handle {
		respond "not_found" 404
	}
}
