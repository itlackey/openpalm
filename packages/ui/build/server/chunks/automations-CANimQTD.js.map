{"version":3,"file":"automations-CANimQTD.js","sources":["../../../.svelte-kit/adapter-node/chunks/automations.js"],"sourcesContent":["import { writeFileSync, chmodSync, readdirSync, rmSync, mkdirSync } from \"node:fs\";\nimport { execSync, spawn } from \"node:child_process\";\nimport { join } from \"node:path\";\nimport { v as validateCron } from \"./cron.js\";\nimport { c as createLogger } from \"./stack-spec.js\";\nconst log = createLogger(\"admin\");\nconst DEFAULT_CRON_DIR = \"/state/automations\";\nlet _cronDir = DEFAULT_CRON_DIR;\nfunction configureCronDir(dir) {\n  _cronDir = dir;\n}\nfunction scriptsDir(base) {\n  return join(base, \"scripts\");\n}\nfunction logDir(base) {\n  return join(base, \"log\");\n}\nfunction lockDir(base) {\n  return join(base, \"lock\");\n}\nfunction cronEnabledDir(base) {\n  return join(base, \"cron.d.enabled\");\n}\nfunction cronDisabledDir(base) {\n  return join(base, \"cron.d.disabled\");\n}\nfunction combinedSchedulePath(base) {\n  return join(base, \"cron.schedule\");\n}\nfunction runnerPath(base) {\n  return join(base, \"run-automation\");\n}\nfunction fileSafeId(id) {\n  if (!/^[a-zA-Z0-9_-]+$/.test(id)) throw new Error(\"invalid_automation_id\");\n  return id;\n}\nfunction sortedFiles(dir) {\n  return readdirSync(dir).filter((name) => !name.startsWith(\".\")).sort();\n}\nfunction clearCronEntries(dir) {\n  for (const file of sortedFiles(dir)) {\n    rmSync(join(dir, file), { force: true });\n  }\n}\nfunction ensureCronDirs(cronDir = _cronDir) {\n  for (const dir of [cronDir, scriptsDir(cronDir), logDir(cronDir), lockDir(cronDir), cronEnabledDir(cronDir), cronDisabledDir(cronDir)]) {\n    mkdirSync(dir, { recursive: true });\n  }\n  writeRunner(cronDir);\n}\nfunction syncAutomations(automations, cronDir = _cronDir) {\n  ensureCronDirs(cronDir);\n  const activeIds = /* @__PURE__ */ new Set();\n  for (const automation of automations) {\n    const cronError = validateCron(automation.schedule);\n    if (cronError) throw new Error(\"invalid_cron_schedule\");\n    const id = fileSafeId(automation.id);\n    activeIds.add(id);\n    const scriptPath = join(scriptsDir(cronDir), `${id}.sh`);\n    writeFileSync(scriptPath, automation.script, \"utf8\");\n    chmodSync(scriptPath, 493);\n  }\n  for (const file of readdirSync(scriptsDir(cronDir))) {\n    if (!file.endsWith(\".sh\")) continue;\n    const id = file.slice(0, -3);\n    if (!activeIds.has(id)) rmSync(join(scriptsDir(cronDir), file), { force: true });\n  }\n  clearCronEntries(cronEnabledDir(cronDir));\n  clearCronEntries(cronDisabledDir(cronDir));\n  const combinedLines = [\"# OpenPalm automations â€” managed by admin, do not edit\", \"\"];\n  const sortedAutomations = [...automations].sort((a, b) => a.id.localeCompare(b.id));\n  for (const [index, automation] of sortedAutomations.entries()) {\n    const id = fileSafeId(automation.id);\n    const fileName = `${String(index + 1).padStart(2, \"0\")}-${id}`;\n    const entry = [\n      \"# OpenPalm automation (managed)\",\n      `# ${automation.name} (${id})`,\n      `${automation.schedule} ${runnerPath(cronDir)} ${id}`,\n      \"\"\n    ].join(\"\\n\");\n    if (automation.enabled) {\n      writeFileSync(join(cronEnabledDir(cronDir), fileName), entry, \"utf8\");\n      combinedLines.push(`# ${automation.name} (${id})`);\n      combinedLines.push(`${automation.schedule} ${runnerPath(cronDir)} ${id}`);\n      combinedLines.push(\"\");\n    } else {\n      writeFileSync(join(cronDisabledDir(cronDir), fileName), entry, \"utf8\");\n    }\n  }\n  writeFileSync(combinedSchedulePath(cronDir), `${combinedLines.join(\"\\n\")}`.trimEnd() + \"\\n\", \"utf8\");\n  try {\n    execSync(`crontab ${combinedSchedulePath(cronDir)}`, { stdio: \"pipe\" });\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error);\n    if (message.includes(\"crontab: not found\")) {\n      log.warn(\"crontab reload skipped: binary not available in this environment\");\n      return;\n    }\n    log.error(\"crontab reload failed\", { error: message });\n  }\n}\nfunction triggerAutomation(idRaw, cronDir = _cronDir) {\n  const id = fileSafeId(idRaw);\n  return new Promise((resolve) => {\n    const proc = spawn(runnerPath(cronDir), [id], { stdio: \"pipe\" });\n    let stderr = \"\";\n    proc.stderr.on(\"data\", (chunk) => {\n      stderr += String(chunk);\n    });\n    proc.on(\"close\", (code) => {\n      if (code === 0) return resolve({ ok: true });\n      return resolve({ ok: false, error: stderr.slice(0, 200) || \"automation_failed\" });\n    });\n    proc.on(\"error\", (error) => {\n      resolve({ ok: false, error: error.message });\n    });\n  });\n}\nfunction writeRunner(cronDir) {\n  const script = `#!/usr/bin/env bash\nset -uo pipefail\n\nID=\"\\${1:?automation ID required}\"\nSCRIPT=\"${scriptsDir(cronDir)}/\\${ID}.sh\"\nLOG_FILE=\"${logDir(cronDir)}/\\${ID}.jsonl\"\nLOCK_FILE=\"${lockDir(cronDir)}/\\${ID}.lock\"\n\nif [[ ! -f \"$SCRIPT\" ]]; then\n  printf '{\"ts\":\"%s\",\"id\":\"%s\",\"status\":\"error\",\"error\":\"script_not_found\"}\\\\n' \\\\\n    \"$(date -Iseconds)\" \"$ID\" >> \"$LOG_FILE\"\n  exit 1\nfi\n\nexec 200>\"$LOCK_FILE\"\nif ! flock -n 200; then\n  printf '{\"ts\":\"%s\",\"id\":\"%s\",\"status\":\"skipped\",\"error\":\"previous_run_active\"}\\\\n' \\\\\n    \"$(date -Iseconds)\" \"$ID\" >> \"$LOG_FILE\"\n  exit 0\nfi\n\nSTART=$(date +%s%N)\nset +e\nOUTPUT=$(bash \"$SCRIPT\" 2>&1)\nEXIT_CODE=$?\nset -e\nDURATION_MS=$(( ( $(date +%s%N) - START ) / 1000000 ))\nPREVIEW=$(printf '%s' \"$OUTPUT\" | head -c 200 | tr '\\\\n\"\\\\\\\\' '  _')\n\nif [[ $EXIT_CODE -eq 0 ]]; then STATUS=\"success\"; else STATUS=\"error\"; fi\n\nprintf '{\"ts\":\"%s\",\"id\":\"%s\",\"status\":\"%s\",\"exit\":%d,\"dur\":%d,\"preview\":\"%s\"}\\\\n' \\\\\n  \"$(date -Iseconds)\" \"$ID\" \"$STATUS\" \"$EXIT_CODE\" \"$DURATION_MS\" \"$PREVIEW\" \\\\\n  >> \"$LOG_FILE\"\n`;\n  writeFileSync(runnerPath(cronDir), script, \"utf8\");\n  chmodSync(runnerPath(cronDir), 493);\n}\nexport {\n  configureCronDir,\n  ensureCronDirs,\n  syncAutomations,\n  triggerAutomation\n};\n"],"names":[],"mappings":"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"}