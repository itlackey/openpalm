{"version":3,"file":"setup-manager-T6S6ERQC.js","sources":["../../../.svelte-kit/adapter-node/chunks/setup-manager.js"],"sourcesContent":["import { mkdirSync, existsSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { dirname } from \"node:path\";\nimport { e as ensureStackSpec, s as stringifyStackSpec } from \"./stack-spec.js\";\nconst DEFAULT_STATE = {\n  completed: false,\n  accessScope: \"host\",\n  serviceInstances: {\n    openmemory: \"\",\n    psql: \"\",\n    qdrant: \"\"\n  },\n  smallModel: {\n    endpoint: \"\",\n    modelId: \"\"\n  },\n  profile: {\n    name: \"\",\n    email: \"\"\n  },\n  steps: {\n    welcome: false,\n    profile: false,\n    accessScope: false,\n    serviceInstances: false,\n    healthCheck: false,\n    security: false,\n    channels: false,\n    extensions: false\n  },\n  enabledChannels: [],\n  installedExtensions: []\n};\nfunction isValidSetupState(value) {\n  if (typeof value !== \"object\" || value === null) return false;\n  const v = value;\n  return typeof v.completed === \"boolean\" && typeof v.accessScope === \"string\" && [\"host\", \"lan\", \"public\"].includes(v.accessScope) && typeof v.serviceInstances === \"object\" && v.serviceInstances !== null && typeof v.smallModel === \"object\" && v.smallModel !== null && typeof v.profile === \"object\" && v.profile !== null && typeof v.steps === \"object\" && v.steps !== null && Array.isArray(v.enabledChannels) && Array.isArray(v.installedExtensions);\n}\nclass SetupManager {\n  path;\n  stackSpecPath;\n  constructor(dataDir, options) {\n    this.path = `${dataDir}/setup-state.json`;\n    this.stackSpecPath = options?.stackSpecPath;\n    mkdirSync(dirname(this.path), { recursive: true });\n  }\n  getState() {\n    if (!existsSync(this.path)) return this.withStackSpecState(structuredClone(DEFAULT_STATE));\n    try {\n      const parsed = JSON.parse(readFileSync(this.path, \"utf8\"));\n      if (!isValidSetupState(parsed)) return this.withStackSpecState(structuredClone(DEFAULT_STATE));\n      return this.withStackSpecState(parsed);\n    } catch {\n      return this.withStackSpecState(structuredClone(DEFAULT_STATE));\n    }\n  }\n  save(state) {\n    mkdirSync(dirname(this.path), { recursive: true });\n    writeFileSync(this.path, JSON.stringify(state, null, 2), \"utf8\");\n  }\n  completeStep(step) {\n    const state = this.getState();\n    state.steps[step] = true;\n    this.save(state);\n    return state;\n  }\n  setAccessScope(scope) {\n    this.withMutableStackSpec((spec) => {\n      spec.accessScope = scope;\n    });\n    const state = this.getState();\n    state.accessScope = scope;\n    this.save(state);\n    return state;\n  }\n  setServiceInstances(serviceInstances) {\n    const state = this.getState();\n    state.serviceInstances = {\n      ...state.serviceInstances,\n      ...serviceInstances\n    };\n    this.save(state);\n    return state;\n  }\n  setSmallModel(smallModel) {\n    const state = this.getState();\n    state.smallModel = {\n      ...state.smallModel,\n      ...smallModel\n    };\n    this.save(state);\n    return state;\n  }\n  setProfile(profile) {\n    const state = this.getState();\n    state.profile = {\n      ...state.profile,\n      ...profile\n    };\n    this.save(state);\n    return state;\n  }\n  completeSetup() {\n    const state = this.getState();\n    state.completed = true;\n    state.completedAt = (/* @__PURE__ */ new Date()).toISOString();\n    this.save(state);\n    return state;\n  }\n  addChannel(channel) {\n    const state = this.getState();\n    if (!state.enabledChannels.includes(channel)) state.enabledChannels.push(channel);\n    this.save(state);\n    return state;\n  }\n  setEnabledChannels(channels) {\n    const enabled = new Set(channels);\n    this.withMutableStackSpec((spec) => {\n      for (const [name, channel] of Object.entries(spec.channels)) {\n        channel.enabled = enabled.has(name);\n      }\n    });\n    const state = this.getState();\n    state.enabledChannels = [...enabled];\n    this.save(state);\n    return state;\n  }\n  addExtension(extensionId) {\n    const state = this.getState();\n    if (!state.installedExtensions.includes(extensionId)) {\n      state.installedExtensions.push(extensionId);\n    }\n    this.save(state);\n    return state;\n  }\n  isFirstBoot() {\n    return !existsSync(this.path);\n  }\n  withStackSpecState(state) {\n    if (!this.stackSpecPath) return state;\n    try {\n      const spec = ensureStackSpec(this.stackSpecPath);\n      state.accessScope = spec.accessScope;\n      state.enabledChannels = Object.entries(spec.channels).filter(([, config]) => config.enabled).map(([name]) => name).sort();\n    } catch {\n    }\n    return state;\n  }\n  withMutableStackSpec(mutator) {\n    if (!this.stackSpecPath) return;\n    try {\n      const spec = ensureStackSpec(this.stackSpecPath);\n      mutator(spec);\n      writeFileSync(this.stackSpecPath, stringifyStackSpec(spec), \"utf8\");\n    } catch {\n    }\n  }\n}\nexport {\n  DEFAULT_STATE,\n  SetupManager\n};\n"],"names":[],"mappings":"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"}