{"version":3,"file":"setup-completion-response-FQQRRQU1.js","sources":["../../../.svelte-kit/adapter-node/chunks/setup-completion-response.js"],"sourcesContent":["import { a as applyStack } from \"./stack-apply-engine.js\";\nimport { composeAction, SetupStartupServices } from \"./compose-runner.js\";\nimport { ensureCoreServicesReady } from \"./core-readiness.js\";\nimport { syncAutomations } from \"./automations.js\";\nimport { u as updateRuntimeEnvContent, p as parseRuntimeEnvContent } from \"./runtime-env.js\";\nimport { writeFileSync, mkdirSync, readFileSync, existsSync } from \"node:fs\";\nimport { dirname } from \"node:path\";\nimport { setCoreReadinessPhase, applyReadinessResult, getCoreReadinessSnapshot } from \"./core-readiness-state.js\";\nfunction generateToken(length = 64) {\n  const bytesNeeded = Math.ceil(length * 3 / 4);\n  const randomBytes = new Uint8Array(bytesNeeded);\n  crypto.getRandomValues(randomBytes);\n  let base64 = btoa(String.fromCharCode(...randomBytes));\n  const urlSafeBase64 = base64.replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=/g, \"\");\n  return urlSafeBase64.slice(0, length);\n}\nconst defaultDependencies = {\n  secretsEnvPath: \"/config/secrets.env\",\n  existsSync,\n  readFileSync,\n  parseRuntimeEnvContent,\n  updateRuntimeEnvContent,\n  generateToken,\n  mkdirSync,\n  dirname,\n  writeFileSync,\n  applyStack,\n  composeAction,\n  syncAutomations,\n  ensureCoreServicesReady\n};\nfunction ensurePostgresPassword(dependencies) {\n  const current = dependencies.existsSync(dependencies.secretsEnvPath) ? dependencies.readFileSync(dependencies.secretsEnvPath, \"utf8\") : \"\";\n  const existingSecrets = dependencies.parseRuntimeEnvContent(current);\n  if (existingSecrets.POSTGRES_PASSWORD) return;\n  const next = dependencies.updateRuntimeEnvContent(current, {\n    POSTGRES_PASSWORD: dependencies.generateToken(32)\n  });\n  dependencies.mkdirSync(dependencies.dirname(dependencies.secretsEnvPath), { recursive: true });\n  dependencies.writeFileSync(dependencies.secretsEnvPath, next, \"utf8\");\n}\nasync function completeSetupOrchestration(setupManager, stackManager, overrides = {}) {\n  const dependencies = { ...defaultDependencies, ...overrides };\n  ensurePostgresPassword(dependencies);\n  setCoreReadinessPhase(\"applying\");\n  const apply = await dependencies.applyStack(stackManager);\n  setCoreReadinessPhase(\"starting\");\n  const startup = await dependencies.composeAction(\"up\", [...SetupStartupServices]);\n  if (!startup.ok) {\n    setCoreReadinessPhase(\"failed\");\n    throw new Error(`core_startup_failed:${startup.stderr}`);\n  }\n  setCoreReadinessPhase(\"checking\");\n  let readiness;\n  try {\n    const maxAttempts = envInt(\"CORE_READINESS_MAX_ATTEMPTS\", 6);\n    const pollIntervalMs = envInt(\"CORE_READINESS_POLL_MS\", 2e3);\n    readiness = await dependencies.ensureCoreServicesReady({\n      targetServices: SetupStartupServices,\n      maxAttempts,\n      pollIntervalMs\n    });\n    applyReadinessResult(readiness);\n  } catch {\n    setCoreReadinessPhase(\"failed\");\n  }\n  dependencies.syncAutomations(stackManager.listAutomations());\n  const state = setupManager.completeSetup();\n  return { state, apply, readiness };\n}\nfunction envInt(name, fallback) {\n  const raw = process.env[name];\n  if (raw == null) return fallback;\n  const parsed = parseInt(raw, 10);\n  return Number.isFinite(parsed) ? parsed : fallback;\n}\nasync function completeSetupCommandResponse(setupManager, stackManager, secretsEnvPath, completeSetup = completeSetupOrchestration) {\n  const result = await completeSetup(setupManager, stackManager, { secretsEnvPath });\n  const coreReadiness = getCoreReadinessSnapshot();\n  return { ok: true, data: result.state, apply: result.apply, readiness: result.readiness, coreReadiness };\n}\nasync function completeSetupRouteResponse(setupManager, stackManager, secretsEnvPath, completeSetup = completeSetupOrchestration) {\n  const result = await completeSetup(setupManager, stackManager, { secretsEnvPath });\n  const coreReadiness = getCoreReadinessSnapshot();\n  return { ok: true, state: result.state, apply: result.apply, readiness: result.readiness, coreReadiness };\n}\nexport {\n  completeSetupRouteResponse as a,\n  completeSetupCommandResponse as c\n};\n"],"names":[],"mappings":"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"}