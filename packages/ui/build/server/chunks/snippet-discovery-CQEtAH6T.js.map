{"version":3,"file":"snippet-discovery-CQEtAH6T.js","sources":["../../../.svelte-kit/adapter-node/chunks/snippet-discovery.js"],"sourcesContent":["import { D as DEFAULT_SNIPPET_SOURCES } from \"./snippet-types.js\";\nimport { a as parseYamlDocument } from \"./index.js\";\nconst cache = /* @__PURE__ */ new Map();\nconst CACHE_TTL_MS = 15 * 60 * 1e3;\nfunction getCached(sourceId) {\n  const entry = cache.get(sourceId);\n  if (!entry) return null;\n  if (Date.now() - entry.fetchedAt > CACHE_TTL_MS) {\n    cache.delete(sourceId);\n    return null;\n  }\n  return entry.snippets;\n}\nfunction setCache(sourceId, snippets) {\n  cache.set(sourceId, { snippets, fetchedAt: Date.now() });\n}\nasync function fetchIndexUrl(source) {\n  if (!source.target) return [];\n  const cached = getCached(source.id);\n  if (cached) return cached;\n  try {\n    const response = await fetch(source.target, {\n      headers: { Accept: \"application/yaml, application/json, text/yaml, text/plain\" },\n      signal: AbortSignal.timeout(1e4)\n    });\n    if (!response.ok) return [];\n    const text = await response.text();\n    const entries = parseYamlDocument(text);\n    if (!Array.isArray(entries)) return [];\n    const resolved = [];\n    for (const entry of entries) {\n      if (isSnippetDef(entry)) {\n        resolved.push(resolveSnippet(entry, source));\n      }\n    }\n    setCache(source.id, resolved);\n    return resolved;\n  } catch {\n    return [];\n  }\n}\nconst SNIPPET_FILENAMES = [\"openpalm-snippet.yaml\", \"openpalm-snippet.yml\"];\nasync function fetchGitHubTopic(source) {\n  const cached = getCached(source.id);\n  if (cached) return cached;\n  const topic = source.target;\n  if (!topic) return [];\n  try {\n    const searchUrl = `https://api.github.com/search/repositories?q=topic:${encodeURIComponent(topic)}&sort=updated&per_page=50`;\n    const searchResponse = await fetch(searchUrl, {\n      headers: {\n        Accept: \"application/vnd.github.v3+json\",\n        \"User-Agent\": \"OpenPalm-Snippet-Discovery\"\n      },\n      signal: AbortSignal.timeout(15e3)\n    });\n    if (!searchResponse.ok) return [];\n    const searchData = await searchResponse.json();\n    if (!searchData.items?.length) return [];\n    const snippets = [];\n    for (const repo of searchData.items.slice(0, 20)) {\n      const snippet = await fetchRepoSnippet(repo.full_name, repo.default_branch, source);\n      if (snippet) snippets.push(snippet);\n    }\n    setCache(source.id, snippets);\n    return snippets;\n  } catch {\n    return [];\n  }\n}\nasync function fetchRepoSnippet(fullName, branch, source) {\n  for (const filename of SNIPPET_FILENAMES) {\n    try {\n      const url = `https://raw.githubusercontent.com/${fullName}/${branch}/${filename}`;\n      const response = await fetch(url, {\n        signal: AbortSignal.timeout(5e3)\n      });\n      if (!response.ok) continue;\n      const text = await response.text();\n      let parsed;\n      try {\n        parsed = parseYamlDocument(text);\n      } catch {\n        continue;\n      }\n      if (isSnippetDef(parsed)) {\n        return resolveSnippet(parsed, source, `github:${fullName}`);\n      }\n    } catch {\n      continue;\n    }\n  }\n  return null;\n}\nfunction resolveSnippet(def, source, sourceIdOverride) {\n  return {\n    ...def,\n    trust: source.trust,\n    sourceId: sourceIdOverride ?? source.id,\n    sourceName: source.name\n  };\n}\nconst VALID_KINDS = /* @__PURE__ */ new Set([\"channel\", \"service\", \"automation\"]);\nfunction isSnippetDef(value) {\n  if (typeof value !== \"object\" || value === null) return false;\n  const obj = value;\n  if (typeof obj.kind !== \"string\" || !VALID_KINDS.has(obj.kind)) return false;\n  if (typeof obj.name !== \"string\") return false;\n  if (!Array.isArray(obj.env)) return false;\n  return true;\n}\nasync function discoverFromSource(source) {\n  if (!source.enabled) return [];\n  switch (source.type) {\n    case \"index-url\":\n      return fetchIndexUrl(source);\n    case \"github-topic\":\n      return fetchGitHubTopic(source);\n    default:\n      return [];\n  }\n}\nasync function discoverAllSnippets(sources = DEFAULT_SNIPPET_SOURCES) {\n  const results = await Promise.allSettled(\n    sources.filter((s) => s.enabled).map((s) => discoverFromSource(s))\n  );\n  const snippets = [];\n  for (const result of results) {\n    if (result.status === \"fulfilled\") {\n      snippets.push(...result.value);\n    }\n  }\n  const trustOrder = { official: 0, curated: 1, community: 2 };\n  const seen = /* @__PURE__ */ new Map();\n  for (const snippet of snippets) {\n    const key = `${snippet.kind}:${snippet.name}`;\n    const existing = seen.get(key);\n    if (!existing || trustOrder[snippet.trust] < trustOrder[existing.trust]) {\n      seen.set(key, snippet);\n    }\n  }\n  return Array.from(seen.values());\n}\nexport {\n  discoverAllSnippets as d\n};\n"],"names":[],"mappings":"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"}