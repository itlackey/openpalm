{"version":3,"file":"env-helpers-B-Cb62vD.js","sources":["../../../.svelte-kit/adapter-node/chunks/env-helpers.js"],"sourcesContent":["import { existsSync, readFileSync, mkdirSync, writeFileSync } from \"node:fs\";\nimport { p as parseRuntimeEnvContent, u as updateRuntimeEnvContent, a as setRuntimeBindScopeContent } from \"./runtime-env.js\";\nimport { dirname } from \"node:path\";\nimport { D as DATA_ENV_PATH, S as SECRETS_ENV_PATH, R as RUNTIME_ENV_PATH } from \"./config.js\";\nconst MAX_SECRETS_RAW_SIZE = 64 * 1024;\nconst fileLocks = /* @__PURE__ */ new Map();\nasync function withFileLock(path, fn) {\n  const existing = fileLocks.get(path) ?? Promise.resolve();\n  let resolve;\n  const next = new Promise((r) => {\n    resolve = r;\n  });\n  fileLocks.set(path, next);\n  await existing;\n  try {\n    return await fn();\n  } finally {\n    resolve();\n  }\n}\nfunction readRuntimeEnv() {\n  if (!existsSync(RUNTIME_ENV_PATH)) return {};\n  return parseRuntimeEnvContent(readFileSync(RUNTIME_ENV_PATH, \"utf8\"));\n}\nfunction updateRuntimeEnv(entries) {\n  return withFileLock(RUNTIME_ENV_PATH, async () => {\n    const current = existsSync(RUNTIME_ENV_PATH) ? readFileSync(RUNTIME_ENV_PATH, \"utf8\") : \"\";\n    const next = updateRuntimeEnvContent(current, entries);\n    mkdirSync(dirname(RUNTIME_ENV_PATH), { recursive: true });\n    writeFileSync(RUNTIME_ENV_PATH, next, \"utf8\");\n  });\n}\nfunction setRuntimeBindScope(scope) {\n  return withFileLock(RUNTIME_ENV_PATH, async () => {\n    const current = existsSync(RUNTIME_ENV_PATH) ? readFileSync(RUNTIME_ENV_PATH, \"utf8\") : \"\";\n    const next = setRuntimeBindScopeContent(current, scope);\n    mkdirSync(dirname(RUNTIME_ENV_PATH), { recursive: true });\n    writeFileSync(RUNTIME_ENV_PATH, next, \"utf8\");\n  });\n}\nfunction readSecretsEnv() {\n  if (!existsSync(SECRETS_ENV_PATH)) return {};\n  return parseRuntimeEnvContent(readFileSync(SECRETS_ENV_PATH, \"utf8\"));\n}\nfunction updateSecretsEnv(entries) {\n  return withFileLock(SECRETS_ENV_PATH, async () => {\n    const current = existsSync(SECRETS_ENV_PATH) ? readFileSync(SECRETS_ENV_PATH, \"utf8\") : \"\";\n    const next = updateRuntimeEnvContent(current, entries);\n    mkdirSync(dirname(SECRETS_ENV_PATH), { recursive: true });\n    writeFileSync(SECRETS_ENV_PATH, next, \"utf8\");\n  });\n}\nfunction readSecretsRaw() {\n  if (!existsSync(SECRETS_ENV_PATH)) return \"\";\n  return readFileSync(SECRETS_ENV_PATH, \"utf8\");\n}\nfunction writeSecretsRaw(content) {\n  void withFileLock(SECRETS_ENV_PATH, async () => {\n    mkdirSync(dirname(SECRETS_ENV_PATH), { recursive: true });\n    writeFileSync(SECRETS_ENV_PATH, content, \"utf8\");\n  });\n}\nfunction validateSecretsRawContent(content) {\n  if (content.length > MAX_SECRETS_RAW_SIZE) return \"content exceeds maximum size (64 KB)\";\n  for (const line of content.split(/\\r?\\n/)) {\n    const trimmed = line.trim();\n    if (!trimmed || trimmed.startsWith(\"#\")) continue;\n    if (!trimmed.includes(\"=\"))\n      return `invalid env line (missing '='): ${trimmed.slice(0, 40)}`;\n    const key = trimmed.split(\"=\")[0].trim();\n    if (!/^[A-Za-z_][A-Za-z0-9_]*$/.test(key)) return `invalid env key: ${key.slice(0, 40)}`;\n  }\n  return null;\n}\nfunction readDataEnv() {\n  if (!existsSync(DATA_ENV_PATH)) return {};\n  return parseRuntimeEnvContent(readFileSync(DATA_ENV_PATH, \"utf8\"));\n}\nfunction updateDataEnv(entries) {\n  return withFileLock(DATA_ENV_PATH, async () => {\n    const current = existsSync(DATA_ENV_PATH) ? readFileSync(DATA_ENV_PATH, \"utf8\") : \"\";\n    const next = updateRuntimeEnvContent(current, entries);\n    mkdirSync(dirname(DATA_ENV_PATH), { recursive: true });\n    writeFileSync(DATA_ENV_PATH, next, \"utf8\");\n  });\n}\nexport {\n  updateRuntimeEnv as a,\n  updateSecretsEnv as b,\n  readSecretsEnv as c,\n  readSecretsRaw as d,\n  readRuntimeEnv as e,\n  readDataEnv as r,\n  setRuntimeBindScope as s,\n  updateDataEnv as u,\n  validateSecretsRawContent as v,\n  writeSecretsRaw as w\n};\n"],"names":[],"mappings":"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"}