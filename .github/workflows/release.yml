name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 0.2.0). Used to create and push tag v<version> from current branch.'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare-tag:
    name: Prepare release tag
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
      version: ${{ steps.resolve.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        if: github.event_name == 'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Resolve release tag
        id: resolve
        env:
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          if [ "${EVENT_NAME}" = 'push' ]; then
            TAG="${REF_NAME}"
          else
            VERSION="${INPUT_VERSION}"
            if ! echo "${VERSION}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
              echo 'Invalid version. Must be semver like 1.2.3.'
              exit 1
            fi

            TAG="v${VERSION}"

            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'

            # Bump all workspace package.json versions
            ./scripts/bump-versions.sh "${VERSION}"

            if git diff --quiet; then
              echo "Versions already at ${VERSION}, no changes needed."
            else
              git add -A '*.json'
              git commit -m "chore: bump versions to ${VERSION}"
              git push origin HEAD:"${GITHUB_REF_NAME}"
            fi

            if git rev-parse "${TAG}" >/dev/null 2>&1; then
              echo "Tag ${TAG} already exists."
            else
              git tag -a "${TAG}" -m "Release ${TAG}"
              git push origin "${TAG}"
            fi
          fi

          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

  quality-gates:
    name: Release quality gates
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: prepare-tag

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-tag.outputs.tag }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Bun workspace dependencies
        run: bun install --frozen-lockfile

      - name: Type check admin UI
        run: cd core/admin && bun run check

      - name: Test (lib + guardian + channels)
        run: bun run test

      - name: Validate Docker Compose manifests
        env:
          ADMIN_TOKEN: ci-placeholder
          POSTGRES_PASSWORD: ci-placeholder
        run: docker compose -f assets/docker-compose.yml -f docker-compose.override.yml config -q

  build-images:
    name: Build Docker images
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs:
      - prepare-tag
      - quality-gates
    strategy:
      fail-fast: true
      matrix:
        include:
          - dockerfile: core/admin/Dockerfile
            image: openpalm/admin
          - dockerfile: core/guardian/Dockerfile
            image: openpalm/guardian
          - dockerfile: channels/chat/Dockerfile
            image: openpalm/channel-chat
          - dockerfile: channels/api/Dockerfile
            image: openpalm/channel-api
          - dockerfile: channels/discord/Dockerfile
            image: openpalm/channel-discord
          - dockerfile: channels/base/Dockerfile
            image: openpalm/channel-base
          - dockerfile: core/assistant/Dockerfile
            image: openpalm/assistant

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-tag.outputs.tag }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: false
          cache-from: type=gha,scope=${{ matrix.image }}
          cache-to: type=gha,scope=${{ matrix.image }},mode=max

  push-images:
    name: Push Docker images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs:
      - prepare-tag
      - build-images
    strategy:
      fail-fast: true
      matrix:
        include:
          - dockerfile: core/admin/Dockerfile
            image: openpalm/admin
          - dockerfile: core/guardian/Dockerfile
            image: openpalm/guardian
          - dockerfile: channels/chat/Dockerfile
            image: openpalm/channel-chat
          - dockerfile: channels/api/Dockerfile
            image: openpalm/channel-api
          - dockerfile: channels/discord/Dockerfile
            image: openpalm/channel-discord
          - dockerfile: channels/base/Dockerfile
            image: openpalm/channel-base
          - dockerfile: core/assistant/Dockerfile
            image: openpalm/assistant

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-tag.outputs.tag }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.image }}
          tags: |
            type=raw,value=latest
            type=raw,value=v${{ needs.prepare-tag.outputs.version }}

      - name: Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.image }}

  release:
    name: Publish GitHub release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
      - prepare-tag
      - push-images

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-tag.outputs.tag }}

      - name: Build release artifact bundle
        run: |
          mkdir -p dist
          tar -czf dist/openpalm-${{ needs.prepare-tag.outputs.version }}-deploy-bundle.tar.gz \
            assets \
            channels \
            core \
            packages \
            scripts \
            docker-compose.override.yml \
            README.md

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums-sha256.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-tag.outputs.tag }}
          name: OpenPalm ${{ needs.prepare-tag.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/openpalm-${{ needs.prepare-tag.outputs.version }}-deploy-bundle.tar.gz
            dist/checksums-sha256.txt