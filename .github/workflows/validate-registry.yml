name: Validate Registry Entries

# Validates new or modified registry entries on pull requests.
# Checks JSON syntax and required fields. Does NOT build Docker images.

on:
  pull_request:
    paths:
      - "assets/state/registry/*.json"
      - "!assets/state/registry/index.json"

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate changed registry entries
        id: validate
        run: |
          ERRORS=0
          WARNINGS=0
          REPORT=""

          ENTRY_FILES=$(find assets/state/registry -maxdepth 1 -name "*.json" \
            ! -name "index.json" ! -name "schema.json" | sort)

          for f in $ENTRY_FILES; do
            ENTRY_ERRORS=""

            # 1. Valid JSON?
            if ! jq empty "$f" 2>/dev/null; then
              ENTRY_ERRORS="${ENTRY_ERRORS}\n- Not valid JSON"
              ERRORS=$((ERRORS + 1))
              REPORT="${REPORT}\n### ❌ \`$f\`\n${ENTRY_ERRORS}"
              continue
            fi

            # 2. Required fields
            REQUIRED="id name description category risk author version source tags permissions securityNotes installAction installTarget"
            for field in $REQUIRED; do
              VAL=$(jq -r --arg f "$field" '.[$f] // empty' "$f")
              if [ -z "$VAL" ]; then
                ENTRY_ERRORS="${ENTRY_ERRORS}\n- Missing required field: \`$field\`"
                ERRORS=$((ERRORS + 1))
              fi
            done

            # 3. Enum fields
            CATEGORY=$(jq -r '.category // ""' "$f")
            if [[ "$CATEGORY" != "plugin" && "$CATEGORY" != "skill" && "$CATEGORY" != "command" && "$CATEGORY" != "agent" && "$CATEGORY" != "tool" && "$CATEGORY" != "channel" ]]; then
              ENTRY_ERRORS="${ENTRY_ERRORS}\n- \`category\` must be one of: plugin, skill, command, agent, tool, channel"
              ERRORS=$((ERRORS + 1))
            fi

            RISK=$(jq -r '.risk // ""' "$f")
            if [[ "$RISK" != "lowest" && "$RISK" != "low" && "$RISK" != "medium" && "$RISK" != "medium-high" && "$RISK" != "highest" ]]; then
              ENTRY_ERRORS="${ENTRY_ERRORS}\n- \`risk\` must be one of: lowest, low, medium, medium-high, highest"
              ERRORS=$((ERRORS + 1))
            fi

            INSTALL_ACTION=$(jq -r '.installAction // ""' "$f")
            if [[ "$INSTALL_ACTION" != "plugin" && "$INSTALL_ACTION" != "skill-file" && "$INSTALL_ACTION" != "compose-service" ]]; then
              ENTRY_ERRORS="${ENTRY_ERRORS}\n- \`installAction\` must be one of: plugin, skill-file, compose-service"
              ERRORS=$((ERRORS + 1))
            fi

            # 4. Check for duplicate ID in existing index
            ENTRY_ID=$(jq -r '.id // ""' "$f")
            if [ -f "assets/state/registry/index.json" ] && [ -n "$ENTRY_ID" ]; then
              EXISTING=$(jq -r --arg id "$ENTRY_ID" '.[] | select(.id == $id) | .id' assets/state/registry/index.json 2>/dev/null)
              if [ -n "$EXISTING" ] && [[ "assets/state/registry/$ENTRY_ID.json" != "$f" ]]; then
                ENTRY_ERRORS="${ENTRY_ERRORS}\n- ⚠️  Warning: ID \`$ENTRY_ID\` already exists in index.json — this will update the existing entry"
                WARNINGS=$((WARNINGS + 1))
              fi
            fi

            if [ -z "$ENTRY_ERRORS" ]; then
              REPORT="${REPORT}\n### ✅ \`$f\` (id: \`$ENTRY_ID\`)\nAll checks passed."
            else
              REPORT="${REPORT}\n### ❌ \`$f\`${ENTRY_ERRORS}"
            fi
          done

          echo "errors=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          # Write summary
          {
            echo "## Registry Validation Report"
            echo ""
            if [ "$ERRORS" -gt 0 ]; then
              echo "**$ERRORS error(s) found** — please fix before merging."
            elif [ "$WARNINGS" -gt 0 ]; then
              echo "**$WARNINGS warning(s)** — review before merging."
            else
              echo "**All entries are valid.** ✓"
            fi
            echo ""
            echo -e "$REPORT"
          } >> $GITHUB_STEP_SUMMARY

          if [ "$ERRORS" -gt 0 ]; then
            exit 1
          fi
